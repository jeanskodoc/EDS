<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Système d'Épreuves d'Évaluations - République Togolaise</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        body {
            background-color: #f5f5f5;
            color: #333;
            padding: 20px;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            padding: 30px;
            box-shadow: 0 0 15px rgba(0, 0, 0, 0.1);
            border-radius: 8px;
        }
        .header {
            text-align: center;
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 2px solid #006600;
        }
        .ministry {
            font-weight: bold;
            font-size: 16px;
            margin-bottom: 5px;
        }
        .republic {
            font-size: 18px;
            font-weight: bold;
            margin: 10px 0;
            color: #006600;
        }
        .motto {
            font-style: italic;
            margin-bottom: 15px;
            color: #555;
        }
        h1 {
            color: #006600;
            text-align: center;
            margin: 20px 0;
            padding-bottom: 10px;
            border-bottom: 1px solid #ddd;
        }
        h2 {
            color: #006600;
            margin: 25px 0 15px 0;
            padding-bottom: 5px;
            border-bottom: 1px solid #eee;
        }
        h3 {
            color: #006600;
            margin: 15px 0 10px 0;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            margin: 15px 0;
        }
        th, td {
            border: 1px solid #ddd;
            padding: 10px;
            text-align: left;
        }
        th {
            background-color: #f2f2f2;
            font-weight: bold;
        }
        input[type="text"], input[type="number"], input[type="date"], textarea, select {
            width: 100%;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
        }
        textarea {
            min-height: 80px;
            resize: vertical;
        }
        .form-section {
            margin-bottom: 25px;
            padding: 15px;
            background-color: #f9f9f9;
            border-left: 4px solid #006600;
            border-radius: 4px;
        }
        .btn-container {
            text-align: center;
            margin: 30px 0 15px 0;
        }
        button {
            background-color: #006600;
            color: white;
            padding: 12px 25px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
            margin: 0 10px;
            transition: background-color 0.3s;
        }
        button:hover {
            background-color: #004d00;
        }
        .footer {
            text-align: center;
            margin-top: 30px;
            padding-top: 15px;
            border-top: 1px solid #ddd;
            color: #777;
            font-size: 14px;
        }
        
        /* Styles pour les informations supplémentaires */
        .school-info {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }
        .info-group {
            margin-bottom: 15px;
        }
        .info-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
            color: #555;
        }
        
        /* Styles pour la visualisation des épreuves */
        .view-container {
            display: none;
            margin-top: 20px;
        }
        .filter-section {
            background-color: #f9f9f9;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
        }
        .filter-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 15px;
        }
        .filter-group {
            margin-bottom: 10px;
        }
        .filter-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
        }
        .filter-group select, .filter-group input {
            width: 100%;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
        }
        .cards-container {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 20px;
        }
        .card {
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            padding: 15px;
            transition: transform 0.3s;
            border-left: 4px solid #006600;
        }
        .card:hover {
            transform: translateY(-5px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
        }
        .card-header {
            border-bottom: 1px solid #eee;
            padding-bottom: 10px;
            margin-bottom: 10px;
        }
        .card-title {
            font-size: 18px;
            font-weight: bold;
            color: #006600;
            margin-bottom: 5px;
        }
        .card-details {
            font-size: 14px;
            color: #666;
        }
        .card-content {
            margin-bottom: 15px;
            font-size: 14px;
        }
        .card-actions {
            display: flex;
            justify-content: space-between;
        }
        .card-btn {
            padding: 6px 12px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 13px;
        }
        .view-btn {
            background-color: #006600;
            color: white;
        }
        .delete-btn {
            background-color: #cc0000;
            color: white;
        }
        .no-results {
            text-align: center;
            padding: 30px;
            color: #666;
            font-style: italic;
            grid-column: 1 / -1;
        }
        
        /* Navigation tabs */
        .tabs {
            display: flex;
            margin-bottom: 20px;
            border-bottom: 1px solid #ddd;
        }
        .tab {
            padding: 10px 20px;
            cursor: pointer;
            background: #f0f0f0;
            border: 1px solid #ddd;
            border-bottom: none;
            border-radius: 5px 5px 0 0;
            margin-right: 5px;
        }
        .tab.active {
            background: white;
            border-bottom: 1px solid white;
            margin-bottom: -1px;
        }
        
        /* Styles pour les questions */
        .question-item {
            margin-bottom: 15px;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            background-color: #f9f9f9;
        }
        .question-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }
        .question-number {
            font-weight: bold;
        }
        .remove-question {
            color: #cc0000;
            cursor: pointer;
            font-size: 18px;
        }
        
        /* Styles pour les barres de notation */
        .rating-bars {
            margin-top: 10px;
        }
        .rating-bar {
            display: flex;
            align-items: center;
            margin-bottom: 8px;
        }
        .rating-label {
            width: 100px;
            font-weight: bold;
        }
        .rating-value {
            width: 60px;
            text-align: center;
        }
        .rating-slider {
            flex-grow: 1;
            margin: 0 10px;
        }
        
        /* Styles pour les statistiques */
        .stats-container {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-top: 20px;
        }
        .stat-box {
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 4px;
            text-align: center;
            background: #f9f9f9;
        }
        .stat-title {
            font-size: 14px;
            color: #555;
            margin-bottom: 5px;
        }
        .stat-value {
            font-size: 24px;
            font-weight: bold;
            color: #006600;
        }
        
        /* Styles pour les types de questions */
        .question-type-selector {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 10px;
            margin-bottom: 15px;
        }
        .type-btn {
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            background-color: #f0f0f0;
            cursor: pointer;
            text-align: center;
            transition: all 0.3s;
        }
        .type-btn:hover {
            background-color: #e0e0e0;
        }
        .type-btn.active {
            background-color: #006600;
            color: white;
            border-color: #004d00;
        }
        
        /* Styles spécifiques aux types de questions */
        .qcm-options, .truefalse-options {
            margin-top: 10px;
        }
        .option-item {
            display: flex;
            align-items: center;
            margin-bottom: 8px;
        }
        .option-item input[type="text"] {
            flex-grow: 1;
            margin-right: 10px;
        }
        .option-item input[type="checkbox"] {
            margin-right: 5px;
        }
        .add-option {
            margin-top: 10px;
            padding: 5px 10px;
            background-color: #f0f0f0;
            border: 1px solid #ddd;
            border-radius: 4px;
            cursor: pointer;
        }
        
        /* Mots mêlés */
        .wordsearch-grid {
            display: grid;
            grid-template-columns: repeat(10, 30px);
            gap: 2px;
            margin: 10px 0;
        }
        .wordsearch-cell {
            width: 30px;
            height: 30px;
            border: 1px solid #999;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            background-color: white;
        }
        .wordsearch-words {
            margin-top: 15px;
        }
        .word-list {
            columns: 2;
            margin-top: 10px;
        }
        
        @media print {
            button, .btn-retour, .tabs, .view-container {
                display: none;
            }
            body {
                background: white;
                padding: 0;
            }
            .container {
                box-shadow: none;
                padding: 15px;
            }
        }
        
        .btn-retour {
            padding: 8px 16px;
            background-color: #f0f0f0;
            border: 1px solid #ccc;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            margin-bottom: 20px;
        }
        .btn-retour:hover {
            background-color: #e0e0e0;
        }
    </style>
</head>
<body>
    <button class="btn-retour" onclick="history.back()">← Retour</button>
    
    <div class="container">
        <!-- En-tête pour la République Togolaise -->
        <div class="header">
            <div class="ministry">MINISTÈRE DES ENSEIGNEMENTS PRIMAIRE, SECONDAIRE, TECHNIQUE ET DE L'ARTISANAT</div>
            <div class="ministry">DIRECTION DES EXAMENS ET CONCOURS</div>
            <div class="republic">RÉPUBLIQUE TOGOLAISE</div>
            <div class="motto">Travail - Liberté - Patrie</div>
            <h1>SYSTÈME DE SAISIE D'ÉPREUVES D'ÉVALUATION</h1>
        </div>

        <!-- Navigation tabs -->
        <div class="tabs">
            <div class="tab active" onclick="showTab('form')">Créer une épreuve</div>
            <div class="tab" onclick="showTab('view')">Voir les épreuves enregistrées</div>
        </div>
        
        <!-- Formulaire de création d'épreuve -->
        <div id="form-container">
            <form id="evaluationForm">
                <!-- Informations de base -->
                <div class="form-section">
                    <h2><i class="fas fa-info-circle"></i> Informations générales</h2>
                    <div class="school-info">
                        <div class="info-group">
                            <label for="school_name">Nom de l'établissement:</label>
                            <input type="text" id="school_name" name="school_name" required>
                        </div>
                        <div class="info-group">
                            <label for="teacher_name">Nom de l'enseignant:</label>
                            <input type="text" id="teacher_name" name="teacher_name" required>
                        </div>
                        <div class="info-group">
                            <label for="class_name">Classe:</label>
                            <input type="text" id="class_name" name="class_name" placeholder="Ex: 5ème A" required>
                        </div>
                        <div class="info-group">
                            <label for="subject">Matière:</label>
                            <input type="text" id="subject" name="subject" placeholder="Ex: Mathématiques" required>
                        </div>
                    </div>
                    
                    <div class="school-info">
                        <div class="info-group">
                            <label for="evaluation_type">Type d'évaluation:</label>
                            <select id="evaluation_type" name="evaluation_type" required>
                                <option value="">Sélectionnez le type</option>
                                <option value="interrogation">Interrogation</option>
                                <option value="devoir_surveille">Devoir surveillé</option>
                                <option value="composition">Composition trimestrielle</option>
                            </select>
                        </div>
                        <div class="info-group">
                            <label for="evaluation_date">Date de l'évaluation:</label>
                            <input type="date" id="evaluation_date" name="evaluation_date" required>
                        </div>
                        <div class="info-group">
                            <label for="duration">Durée (en minutes):</label>
                            <input type="number" id="duration" name="duration" min="5" required>
                        </div>
                        <div class="info-group">
                            <label for="total_points">Total des points:</label>
                            <input type="number" id="total_points" name="total_points" min="1" value="20" required>
                        </div>
                    </div>
                </div>

                <!-- Instructions et consignes -->
                <div class="form-section">
                    <h2><i class="fas fa-clipboard-list"></i> Instructions et consignes</h2>
                    <div class="info-group">
                        <label for="instructions">Instructions générales:</label>
                        <textarea id="instructions" name="instructions" placeholder="Rédigez les instructions pour les élèves..."></textarea>
                    </div>
                </div>

                <!-- Questions de l'épreuve -->
                <div class="form-section">
                    <h2><i class="fas fa-question-circle"></i> Questions de l'épreuve</h2>
                    <div id="questions-container">
                        <!-- Les questions seront ajoutées dynamiquement ici -->
                    </div>
                    
                    <h3>Ajouter une nouvelle question</h3>
                    <div class="question-type-selector">
                        <div class="type-btn active" data-type="traditional" onclick="setQuestionType('traditional')">
                            <i class="fas fa-font"></i> Question traditionnelle
                        </div>
                        <div class="type-btn" data-type="problem" onclick="setQuestionType('problem')">
                            <i class="fas fa-puzzle-piece"></i> Situation problème
                        </div>
                        <div class="type-btn" data-type="qcm" onclick="setQuestionType('qcm')">
                            <i class="fas fa-list-ol"></i> QCM
                        </div>
                        <div class="type-btn" data-type="truefalse" onclick="setQuestionType('truefalse')">
                            <i class="fas fa-check-circle"></i> Vrai/Faux
                        </div>
                        <div class="type-btn" data-type="wordsearch" onclick="setQuestionType('wordsearch')">
                            <i class="fas fa-th"></i> Mots mêlés
                        </div>
                    </div>
                    
                    <button type="button" onclick="addQuestion()" style="margin-top: 15px;">
                        <i class="fas fa-plus"></i> Ajouter la question sélectionnée
                    </button>
                </div>

                <!-- Barème et notation -->
                <div class="form-section">
                    <h2><i class="fas fa-chart-bar"></i> Barème et notation</h2>
                    <div id="rating-container">
                        <!-- Le barème sera généré dynamiquement -->
                    </div>
                </div>

                <!-- Statistiques de l'évaluation -->
                <div class="form-section">
                    <h2><i class="fas fa-chart-pie"></i> Statistiques de l'évaluation</h2>
                    <div class="stats-container">
                        <div class="stat-box">
                            <div class="stat-title">Moyenne de la classe</div>
                            <div class="stat-value" id="average_score">0.0</div>
                        </div>
                        <div class="stat-box">
                            <div class="stat-title">Note la plus élevée</div>
                            <div class="stat-value" id="highest_score">0.0</div>
                        </div>
                        <div class="stat-box">
                            <div class="stat-title">Note la plus basse</div>
                            <div class="stat-value" id="lowest_score">0.0</div>
                        </div>
                        <div class="stat-box">
                            <div class="stat-title">Taux de réussite</div>
                            <div class="stat-value" id="success_rate">0%</div>
                        </div>
                    </div>
                    
                    <div class="info-group" style="margin-top: 20px;">
                        <label for="comments">Commentaires et observations:</label>
                        <textarea id="comments" name="comments" placeholder="Ajoutez vos observations sur les résultats..."></textarea>
                    </div>
                </div>

                <!-- Boutons d'action -->
                <div class="btn-container">
                    <button type="button" onclick="saveEvaluation()"><i class="fas fa-save"></i> Enregistrer</button>
                    <button type="button" onclick="exportToJson()"><i class="fas fa-download"></i> Exporter JSON</button>
                    <button type="button" onclick="window.print()"><i class="fas fa-print"></i> Imprimer</button>
                    <button type="reset"><i class="fas fa-redo"></i> Réinitialiser</button>
                </div>
            </form>
        </div>
        
        <!-- Visualisation des épreuves enregistrées -->
        <div id="view-container" class="view-container">
            <h2>Épreuves enregistrées</h2>
            
            <div class="filter-section">
                <h3>Filtrer les épreuves</h3>
                <div class="filter-grid">
                    <div class="filter-group">
                        <label for="filter-type">Type d'évaluation:</label>
                        <select id="filter-type">
                            <option value="">Tous les types</option>
                            <option value="interrogation">Interrogation</option>
                            <option value="devoir_surveille">Devoir surveillé</option>
                            <option value="composition">Composition trimestrielle</option>
                        </select>
                    </div>
                    <div class="filter-group">
                        <label for="filter-class">Classe:</label>
                        <select id="filter-class">
                            <option value="">Toutes les classes</option>
                        </select>
                    </div>
                    <div class="filter-group">
                        <label for="filter-subject">Matière:</label>
                        <select id="filter-subject">
                            <option value="">Toutes les matières</option>
                        </select>
                    </div>
                    <div class="filter-group">
                        <label for="filter-teacher">Enseignant:</label>
                        <select id="filter-teacher">
                            <option value="">Tous les enseignants</option>
                        </select>
                    </div>
                </div>
                <button onclick="applyFilters()"><i class="fas fa-filter"></i> Appliquer les filtres</button>
                <button onclick="clearFilters()" style="background-color: #666;"><i class="fas fa-times"></i> Effacer les filtres</button>
            </div>
            
            <div id="cards-container" class="cards-container">
                <!-- Les épreuves seront affichées ici dynamiquement -->
            </div>
        </div>

        <div class="footer">
            Système de Saisie d'Épreuves d'Évaluation - République Togolaise © 2023
        </div>
    </div>

    <script>
        let allEvaluations = [];
        let questionCount = 0;
        let currentQuestionType = 'traditional';
        
        // Initialisation
        document.addEventListener('DOMContentLoaded', function() {
            // Définir la date du jour comme date d'évaluation par défaut
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('evaluation_date').value = today;
            
            // Ajouter une première question
            addQuestion();
            
            // Charger les évaluations enregistrées
            loadAllEvaluations();
        });
        
        // Afficher l'onglet sélectionné
        function showTab(tabName) {
            if (tabName === 'form') {
                document.getElementById('form-container').style.display = 'block';
                document.getElementById('view-container').style.display = 'none';
                document.querySelectorAll('.tab')[0].classList.add('active');
                document.querySelectorAll('.tab')[1].classList.remove('active');
            } else {
                document.getElementById('form-container').style.display = 'none';
                document.getElementById('view-container').style.display = 'block';
                document.querySelectorAll('.tab')[0].classList.remove('active');
                document.querySelectorAll('.tab')[1].classList.add('active');
                
                // Recharger les évaluations et les filtres
                loadAllEvaluations();
                populateFilterOptions();
                applyFilters();
            }
        }
        
        // Définir le type de question
        function setQuestionType(type) {
            currentQuestionType = type;
            
            // Mettre à jour l'interface
            document.querySelectorAll('.type-btn').forEach(btn => {
                if (btn.dataset.type === type) {
                    btn.classList.add('active');
                } else {
                    btn.classList.remove('active');
                }
            });
        }
        
        // Ajouter une question à l'épreuve
        function addQuestion() {
            questionCount++;
            const questionsContainer = document.getElementById('questions-container');
            
            const questionItem = document.createElement('div');
            questionItem.className = 'question-item';
            questionItem.id = `question-${questionCount}`;
            questionItem.dataset.type = currentQuestionType;
            
            let questionContent = '';
            
            switch(currentQuestionType) {
                case 'traditional':
                    questionContent = getTraditionalQuestionHTML(questionCount);
                    break;
                case 'problem':
                    questionContent = getProblemQuestionHTML(questionCount);
                    break;
                case 'qcm':
                    questionContent = getQCMQuestionHTML(questionCount);
                    break;
                case 'truefalse':
                    questionContent = getTrueFalseQuestionHTML(questionCount);
                    break;
                case 'wordsearch':
                    questionContent = getWordSearchQuestionHTML(questionCount);
                    break;
            }
            
            questionItem.innerHTML = `
                <div class="question-header">
                    <span class="question-number">Question ${questionCount} (${getQuestionTypeLabel(currentQuestionType)})</span>
                    <span class="remove-question" onclick="removeQuestion(${questionCount})">
                        <i class="fas fa-times"></i>
                    </span>
                </div>
                ${questionContent}
            `;
            
            questionsContainer.appendChild(questionItem);
            updateRatingBars();
        }
        
        // Obtenir le libellé du type de question
        function getQuestionTypeLabel(type) {
            switch(type) {
                case 'traditional': return 'Traditionnelle';
                case 'problem': return 'Situation problème';
                case 'qcm': return 'QCM';
                case 'truefalse': return 'Vrai/Faux';
                case 'wordsearch': return 'Mots mêlés';
                default: return 'Question';
            }
        }
        
        // HTML pour une question traditionnelle
        function getTraditionalQuestionHTML(id) {
            return `
                <div class="info-group">
                    <label for="question-${id}-text">Énoncé de la question:</label>
                    <textarea id="question-${id}-text" name="questions[${id}][text]" placeholder="Rédigez l'énoncé de la question..." required></textarea>
                </div>
                <div class="info-group">
                    <label for="question-${id}-points">Points attribués:</label>
                    <input type="number" id="question-${id}-points" name="questions[${id}][points]" min="0.5" step="0.5" value="2" required>
                </div>
                <div class="info-group">
                    <label for="question-${id}-difficulty">Niveau de difficulté:</label>
                    <select id="question-${id}-difficulty" name="questions[${id}][difficulty]" required>
                        <option value="facile">Facile</option>
                        <option value="moyen" selected>Moyen</option>
                        <option value="difficile">Difficile</option>
                    </select>
                </div>
            `;
        }
        
        // HTML pour une situation problème
        function getProblemQuestionHTML(id) {
            return `
                <div class="info-group">
                    <label for="question-${id}-context">Contexte de la situation:</label>
                    <textarea id="question-${id}-context" name="questions[${id}][context]" placeholder="Décrivez le contexte de la situation problème..." required></textarea>
                </div>
                <div class="info-group">
                    <label for="question-${id}-text">Question ou problème à résoudre:</label>
                    <textarea id="question-${id}-text" name="questions[${id}][text]" placeholder="Formulez le problème à résoudre..." required></textarea>
                </div>
                <div class="info-group">
                    <label for="question-${id}-points">Points attribués:</label>
                    <input type="number" id="question-${id}-points" name="questions[${id}][points]" min="1" step="0.5" value="4" required>
                </div>
                <div class="info-group">
                    <label for="question-${id}-difficulty">Niveau de difficulté:</label>
                    <select id="question-${id}-difficulty" name="questions[${id}][difficulty]" required>
                        <option value="facile">Facile</option>
                        <option value="moyen">Moyen</option>
                        <option value="difficile" selected>Difficile</option>
                    </select>
                </div>
            `;
        }
        
        // HTML pour un QCM
        function getQCMQuestionHTML(id) {
            return `
                <div class="info-group">
                    <label for="question-${id}-text">Énoncé de la question:</label>
                    <textarea id="question-${id}-text" name="questions[${id}][text]" placeholder="Rédigez l'énoncé de la question..." required></textarea>
                </div>
                <div class="qcm-options">
                    <label>Options de réponse:</label>
                    <div id="qcm-options-${id}">
                        <div class="option-item">
                            <input type="checkbox" name="questions[${id}][correct][]" value="0">
                            <input type="text" name="questions[${id}][options][]" placeholder="Option 1" required>
                        </div>
                        <div class="option-item">
                            <input type="checkbox" name="questions[${id}][correct][]" value="1">
                            <input type="text" name="questions[${id}][options][]" placeholder="Option 2" required>
                        </div>
                        <div class="option-item">
                            <input type="checkbox" name="questions[${id}][correct][]" value="2">
                            <input type="text" name="questions[${id}][options][]" placeholder="Option 3" required>
                        </div>
                        <div class="option-item">
                            <input type="checkbox" name="questions[${id}][correct][]" value="3">
                            <input type="text" name="questions[${id}][options][]" placeholder="Option 4" required>
                        </div>
                    </div>
                    <button type="button" class="add-option" onclick="addQMCOption(${id})">+ Ajouter une option</button>
                </div>
                <div class="info-group">
                    <label for="question-${id}-points">Points attribués:</label>
                    <input type="number" id="question-${id}-points" name="questions[${id}][points]" min="0.5" step="0.5" value="1" required>
                </div>
                <div class="info-group">
                    <label for="question-${id}-difficulty">Niveau de difficulté:</label>
                    <select id="question-${id}-difficulty" name="questions[${id}][difficulty]" required>
                        <option value="facile" selected>Facile</option>
                        <option value="moyen">Moyen</option>
                        <option value="difficile">Difficile</option>
                    </select>
                </div>
            `;
        }
        
        // HTML pour une question Vrai/Faux
        function getTrueFalseQuestionHTML(id) {
            return `
                <div class="info-group">
                    <label for="question-${id}-text">Énoncé de l'affirmation:</label>
                    <textarea id="question-${id}-text" name="questions[${id}][text]" placeholder="Rédigez l'affirmation (Vrai ou Faux?)..." required></textarea>
                </div>
                <div class="truefalse-options">
                    <label>Réponse correcte:</label>
                    <div class="option-item">
                        <input type="radio" id="question-${id}-true" name="questions[${id}][correct]" value="true" checked>
                        <label for="question-${id}-true">Vrai</label>
                    </div>
                    <div class="option-item">
                        <input type="radio" id="question-${id}-false" name="questions[${id}][correct]" value="false">
                        <label for="question-${id}-false">Faux</label>
                    </div>
                </div>
                <div class="info-group">
                    <label for="question-${id}-points">Points attribués:</label>
                    <input type="number" id="question-${id}-points" name="questions[${id}][points]" min="0.5" step="0.5" value="0.5" required>
                </div>
                <div class="info-group">
                    <label for="question-${id}-difficulty">Niveau de difficulté:</label>
                    <select id="question-${id}-difficulty" name="questions[${id}][difficulty]" required>
                        <option value="facile" selected>Facile</option>
                        <option value="moyen">Moyen</option>
                        <option value="difficile">Difficile</option>
                    </select>
                </div>
            `;
        }
        
        // HTML pour une grille de mots mêlés
        function getWordSearchQuestionHTML(id) {
            return `
                <div class="info-group">
                    <label for="question-${id}-theme">Thème des mots:</label>
                    <input type="text" id="question-${id}-theme" name="questions[${id}][theme]" placeholder="Ex: Vocabulaire scientifique, Capitales..." required>
                </div>
                <div class="info-group">
                    <label for="question-${id}-words">Liste des mots à trouver (séparés par des virgules):</label>
                    <textarea id="question-${id}-words" name="questions[${id}][words]" placeholder="Ex: Photosynthèse, Mitochondrie, Chlorophylle..." required></textarea>
                </div>
                <div class="info-group">
                    <label>Grille de mots mêlés (10x10):</label>
                    <div class="wordsearch-grid" id="wordsearch-${id}">
                        ${generateWordSearchGrid()}
                    </div>
                </div>
                <div class="info-group">
                    <label for="question-${id}-points">Points attribués:</label>
                    <input type="number" id="question-${id}-points" name="questions[${id}][points]" min="0.5" step="0.5" value="3" required>
                </div>
                <div class="info-group">
                    <label for="question-${id}-difficulty">Niveau de difficulté:</label>
                    <select id="question-${id}-difficulty" name="questions[${id}][difficulty]" required>
                        <option value="facile" selected>Facile</option>
                        <option value="moyen">Moyen</option>
                        <option value="difficile">Difficile</option>
                    </select>
                </div>
            `;
        }
        
        // Générer une grille de mots mêlés
        function generateWordSearchGrid() {
            let gridHTML = '';
            const letters = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ';
            
            for (let i = 0; i < 100; i++) {
                const randomLetter = letters[Math.floor(Math.random() * letters.length)];
                gridHTML += `<div class="wordsearch-cell">${randomLetter}</div>`;
            }
            
            return gridHTML;
        }
        
        // Ajouter une option à un QCM
        function addQMCOption(questionId) {
            const optionsContainer = document.getElementById(`qcm-options-${questionId}`);
            const optionCount = optionsContainer.children.length;
            
            const optionItem = document.createElement('div');
            optionItem.className = 'option-item';
            optionItem.innerHTML = `
                <input type="checkbox" name="questions[${questionId}][correct][]" value="${optionCount}">
                <input type="text" name="questions[${questionId}][options][]" placeholder="Option ${optionCount + 1}" required>
            `;
            
            optionsContainer.appendChild(optionItem);
        }
        
        // Supprimer une question
        function removeQuestion(questionId) {
            if (questionCount <= 1) {
                alert("L'épreuve doit contenir au moins une question.");
                return;
            }
            
            const questionElement = document.getElementById(`question-${questionId}`);
            questionElement.remove();
            
            // Renumérotation des questions
            questionCount = 0;
            const questionItems = document.querySelectorAll('.question-item');
            questionItems.forEach((item, index) => {
                questionCount++;
                const questionNumber = item.querySelector('.question-number');
                const type = item.dataset.type;
                questionNumber.textContent = `Question ${questionCount} (${getQuestionTypeLabel(type)})`;
                
                // Mettre à jour les IDs et les noms
                item.id = `question-${questionCount}`;
                
                // Mettre à jour tous les champs à l'intérieur de la question
                const inputs = item.querySelectorAll('input, textarea, select');
                inputs.forEach(input => {
                    if (input.name) {
                        input.name = input.name.replace(/questions\[\d+\]/, `questions[${questionCount}]`);
                    }
                    if (input.id) {
                        input.id = input.id.replace(/question-\d+/, `question-${questionCount}`);
                    }
                });
                
                // Mettre à jour les événements onclick
                const removeBtn = item.querySelector('.remove-question');
                removeBtn.setAttribute('onclick', `removeQuestion(${questionCount})`);
            });
            
            updateRatingBars();
        }
        
        // Mettre à jour les barèmes de notation
        function updateRatingBars() {
            const ratingContainer = document.getElementById('rating-container');
            ratingContainer.innerHTML = '';
            
            const totalPoints = parseFloat(document.getElementById('total_points').value) || 20;
            let assignedPoints = 0;
            
            // Ajouter un barème pour chaque question
            for (let i = 1; i <= questionCount; i++) {
                const questionElement = document.getElementById(`question-${i}`);
                if (!questionElement) continue;
                
                const pointsInput = document.getElementById(`question-${i}-points`);
                const points = parseFloat(pointsInput.value) || 0;
                assignedPoints += points;
                
                const ratingBar = document.createElement('div');
                ratingBar.className = 'rating-bar';
                ratingBar.innerHTML = `
                    <span class="rating-label">Question ${i}:</span>
                    <input type="range" class="rating-slider" min="0" max="${points}" step="0.5" value="0" 
                           oninput="document.getElementById('question-${i}-score').value = this.value; updateStatistics()">
                    <span class="rating-value">
                        <input type="number" id="question-${i}-score" min="0" max="${points}" step="0.5" value="0" 
                               oninput="document.querySelector('#question-${i} .rating-slider').value = this.value; updateStatistics()" style="width: 50px;">
                        / ${points}
                    </span>
                `;
                
                ratingContainer.appendChild(ratingBar);
            }
            
            // Afficher le total des points attribués
            const totalBar = document.createElement('div');
            totalBar.className = 'rating-bar';
            totalBar.style.marginTop = '20px';
            totalBar.style.paddingTop = '10px';
            totalBar.style.borderTop = '2px solid #ddd';
            totalBar.innerHTML = `
                <span class="rating-label"><strong>Total:</strong></span>
                <span class="rating-slider"></span>
                <span class="rating-value">
                    <strong id="total-score">0</strong> / ${totalPoints}
                </span>
            `;
            
            ratingContainer.appendChild(totalBar);
            
            // Vérifier si le total des points des questions correspond au total de l'épreuve
            if (Math.abs(assignedPoints - totalPoints) > 0.1) {
                const warning = document.createElement('div');
                warning.style.color = '#cc0000';
                warning.style.marginTop = '10px';
                warning.innerHTML = `<i class="fas fa-exclamation-triangle"></i> 
                    Attention: La somme des points des questions (${assignedPoints}) ne correspond pas au total de l'épreuve (${totalPoints}).`;
                ratingContainer.appendChild(warning);
            }
        }
        
        // Mettre à jour les statistiques
        function updateStatistics() {
            let totalScore = 0;
            let totalPoints = parseFloat(document.getElementById('total_points').value) || 20;
            
            // Calculer le score total
            for (let i = 1; i <= questionCount; i++) {
                const scoreInput = document.getElementById(`question-${i}-score`);
                if (scoreInput) {
                    totalScore += parseFloat(scoreInput.value) || 0;
                }
            }
            
            // Mettre à jour l'affichage du score total
            document.getElementById('total-score').textContent = totalScore.toFixed(1);
            
            // Calculer les statistiques (pour l'exemple, on utilise des valeurs fixes)
            // Dans une application réelle, ces valeurs seraient calculées à partir des résultats des élèves
            const averageScore = (totalScore * 0.7).toFixed(1);
            const highestScore = Math.min(totalScore, (totalScore * 0.95)).toFixed(1);
            const lowestScore = (totalScore * 0.3).toFixed(1);
            const successRate = Math.round((averageScore / totalScore) * 100);
            
            // Mettre à jour l'affichage des statistiques
            document.getElementById('average_score').textContent = averageScore;
            document.getElementById('highest_score').textContent = highestScore;
            document.getElementById('lowest_score').textContent = lowestScore;
            document.getElementById('success_rate').textContent = `${successRate}%`;
        }
        
        // Collecter les données du formulaire
        function collectFormData() {
            const formData = {};
            
            // Récupérer les données des champs standards
            document.querySelectorAll('input, select, textarea').forEach(field => {
                if (field.name && !field.name.includes('questions')) {
                    formData[field.name] = field.value;
                }
            });
            
            // Récupérer les questions
            formData.questions = [];
            for (let i = 1; i <= questionCount; i++) {
                const questionElement = document.getElementById(`question-${i}`);
                if (!questionElement) continue;
                
                const questionType = questionElement.dataset.type;
                let questionData = {
                    type: questionType,
                    points: parseFloat(document.getElementById(`question-${i}-points`).value) || 0,
                    difficulty: document.getElementById(`question-${i}-difficulty`).value,
                    score: parseFloat(document.getElementById(`question-${i}-score`).value) || 0
                };
                
                // Données spécifiques au type de question
                switch(questionType) {
                    case 'traditional':
                        questionData.text = document.getElementById(`question-${i}-text`).value;
                        break;
                    case 'problem':
                        questionData.context = document.getElementById(`question-${i}-context`).value;
                        questionData.text = document.getElementById(`question-${i}-text`).value;
                        break;
                    case 'qcm':
                        questionData.text = document.getElementById(`question-${i}-text`).value;
                        // Récupérer les options et les réponses correctes
                        questionData.options = [];
                        questionData.correctAnswers = [];
                        const optionInputs = document.querySelectorAll(`#qcm-options-${i} input[type="text"]`);
                        const correctInputs = document.querySelectorAll(`#qcm-options-${i} input[type="checkbox"]`);
                        
                        optionInputs.forEach((input, index) => {
                            questionData.options.push(input.value);
                            if (correctInputs[index].checked) {
                                questionData.correctAnswers.push(index);
                            }
                        });
                        break;
                    case 'truefalse':
                        questionData.text = document.getElementById(`question-${i}-text`).value;
                        questionData.correctAnswer = document.querySelector(`input[name="questions[${i}][correct]"]:checked`).value;
                        break;
                    case 'wordsearch':
                        questionData.theme = document.getElementById(`question-${i}-theme`).value;
                        questionData.words = document.getElementById(`question-${i}-words`).value;
                        break;
                }
                
                formData.questions.push(questionData);
            }
            
            // Ajouter un timestamp et un ID unique
            formData.timestamp = new Date().toISOString();
            formData.id = 'eval_' + new Date().getTime();
            
            return formData;
        }
        
        // Sauvegarder l'évaluation
        function saveEvaluation() {
            const formData = collectFormData();
            
            // Validation basique
            if (!formData.school_name || !formData.teacher_name || !formData.class_name || !formData.subject) {
                alert("Veuillez remplir tous les champs obligatoires.");
                return;
            }
            
            if (formData.questions.length === 0) {
                alert("Veuillez ajouter au moins une question à l'épreuve.");
                return;
            }
            
            // Récupérer les évaluations existantes
            let allEvals = JSON.parse(localStorage.getItem('allEvaluations')) || [];
            
            // Ajouter la nouvelle évaluation
            allEvals.push(formData);
            
            // Sauvegarder dans le stockage local
            localStorage.setItem('allEvaluations', JSON.stringify(allEvals));
            
            alert('Évaluation enregistrée avec succès!');
        }
        
        // Exporter en JSON
        function exportToJson() {
            const formData = collectFormData();
            
            // Télécharger en tant que fichier JSON
            const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(formData, null, 2));
            const downloadAnchorNode = document.createElement('a');
            downloadAnchorNode.setAttribute("href", dataStr);
            downloadAnchorNode.setAttribute("download", "evaluation_" + new Date().getTime() + ".json");
            document.body.appendChild(downloadAnchorNode);
            downloadAnchorNode.click();
            downloadAnchorNode.remove();
            
            alert('Évaluation exportée avec succès!');
        }
        
        // Charger toutes les évaluations
        function loadAllEvaluations() {
            allEvaluations = JSON.parse(localStorage.getItem('allEvaluations')) || [];
        }
        
        // Remplir les options des filtres
        function populateFilterOptions() {
            const typeFilter = document.getElementById('filter-type');
            const classFilter = document.getElementById('filter-class');
            const subjectFilter = document.getElementById('filter-subject');
            const teacherFilter = document.getElementById('filter-teacher');
            
            // Réinitialiser les filtres (garder l'option par défaut)
            typeFilter.innerHTML = '<option value="">Tous les types</option>';
            classFilter.innerHTML = '<option value="">Toutes les classes</option>';
            subjectFilter.innerHTML = '<option value="">Toutes les matières</option>';
            teacherFilter.innerHTML = '<option value="">Tous les enseignants</option>';
            
            // Ensembles pour stocker les valeurs uniques
            const types = new Set(['interrogation', 'devoir_surveille', 'composition']);
            const classes = new Set();
            const subjects = new Set();
            const teachers = new Set();
            
            // Récupérer toutes les valeurs uniques
            allEvaluations.forEach(eval => {
                if (eval.class_name) classes.add(eval.class_name);
                if (eval.subject) subjects.add(eval.subject);
                if (eval.teacher_name) teachers.add(eval.teacher_name);
            });
            
            // Ajouter les options aux filtres
            types.forEach(t => {
                const option = document.createElement('option');
                option.value = t;
                option.textContent = t === 'interrogation' ? 'Interrogation' : 
                                   t === 'devoir_surveille' ? 'Devoir surveillé' : 'Composition trimestrielle';
                typeFilter.appendChild(option);
            });
            
            classes.forEach(c => {
                const option = document.createElement('option');
                option.value = c;
                option.textContent = c;
                classFilter.appendChild(option);
            });
            
            subjects.forEach(s => {
                const option = document.createElement('option');
                option.value = s;
                option.textContent = s;
                subjectFilter.appendChild(option);
            });
            
            teachers.forEach(t => {
                const option = document.createElement('option');
                option.value = t;
                option.textContent = t;
                teacherFilter.appendChild(option);
            });
        }
        
        // Appliquer les filtres
        function applyFilters() {
            const typeFilter = document.getElementById('filter-type').value;
            const classFilter = document.getElementById('filter-class').value;
            const subjectFilter = document.getElementById('filter-subject').value;
            const teacherFilter = document.getElementById('filter-teacher').value;
            
            // Filtrer les évaluations
            const filteredEvals = allEvaluations.filter(eval => {
                return (!typeFilter || eval.evaluation_type === typeFilter) &&
                       (!classFilter || eval.class_name === classFilter) &&
                       (!subjectFilter || eval.subject === subjectFilter) &&
                       (!teacherFilter || eval.teacher_name === teacherFilter);
            });
            
            // Afficher les évaluations filtrées
            displayEvaluations(filteredEvals);
        }
        
        // Effacer les filtres
        function clearFilters() {
            document.getElementById('filter-type').value = '';
            document.getElementById('filter-class').value = '';
            document.getElementById('filter-subject').value = '';
            document.getElementById('filter-teacher').value = '';
            
            // Afficher toutes les évaluations
            displayEvaluations(allEvaluations);
        }
        
        // Afficher les évaluations dans le conteneur
        function displayEvaluations(evals) {
            const container = document.getElementById('cards-container');
            container.innerHTML = '';
            
            if (evals.length === 0) {
                container.innerHTML = '<div class="no-results">Aucune évaluation ne correspond aux critères de filtrage.</div>';
                return;
            }
            
            evals.forEach((eval, index) => {
                const card = document.createElement('div');
                card.className = 'card';
                
                const evalType = eval.evaluation_type === 'interrogation' ? 'Interrogation' : 
                                eval.evaluation_type === 'devoir_surveille' ? 'Devoir surveillé' : 'Composition trimestrielle';
                
                // Formater la date
                const evalDate = new Date(eval.evaluation_date).toLocaleDateString('fr-FR');
                
                // Compter les types de questions
                const questionTypes = {};
                if (eval.questions) {
                    eval.questions.forEach(q => {
                        questionTypes[q.type] = (questionTypes[q.type] || 0) + 1;
                    });
                }
                
                let questionTypesText = '';
                for (const type in questionTypes) {
                    const label = getQuestionTypeLabel(type);
                    questionTypesText += `${questionTypes[type]} ${label}, `;
                }
                questionTypesText = questionTypesText.replace(/, $/, '');
                
                card.innerHTML = `
                    <div class="card-header">
                        <div class="card-title">${eval.subject || 'Sans titre'} - ${evalType}</div>
                        <div class="card-details">
                            <div>Classe: ${eval.class_name || 'Non spécifié'}</div>
                            <div>Enseignant: ${eval.teacher_name || 'Non spécifié'}</div>
                            <div>Date: ${evalDate}</div>
                            <div>Durée: ${eval.duration} minutes</div>
                        </div>
                    </div>
                    <div class="card-content">
                        <p><strong>Établissement:</strong> ${eval.school_name || 'Non spécifié'}</p>
                        <p><strong>Total des points:</strong> ${eval.total_points || '20'}</p>
                        <p><strong>Nombre de questions:</strong> ${eval.questions ? eval.questions.length : '0'}</p>
                        <p><strong>Types de questions:</strong> ${questionTypesText}</p>
                    </div>
                    <div class="card-actions">
                        <button class="card-btn view-btn" onclick="viewEvaluation('${eval.id}')"><i class="fas fa-eye"></i> Voir</button>
                        <button class="card-btn delete-btn" onclick="deleteEvaluation('${eval.id}')"><i class="fas fa-trash"></i> Supprimer</button>
                    </div>
                `;
                
                container.appendChild(card);
            });
        }
        
        // Voir une évaluation détaillée
        function viewEvaluation(evalId) {
            const evaluation = allEvaluations.find(e => e.id === evalId);
            if (!evaluation) return;
            
            // Ouvrir une nouvelle fenêtre ou onglet avec l'évaluation
            const newWindow = window.open('', '_blank');
            
            const evalType = evaluation.evaluation_type === 'interrogation' ? 'Interrogation' : 
                            evaluation.evaluation_type === 'devoir_surveille' ? 'Devoir surveillé' : 'Composition trimestrielle';
            
            // Formater la date
            const evalDate = new Date(evaluation.evaluation_date).toLocaleDateString('fr-FR');
            
            let questionsHtml = '';
            if (evaluation.questions && evaluation.questions.length > 0) {
                evaluation.questions.forEach((q, index) => {
                    let questionContent = '';
                    
                    switch(q.type) {
                        case 'traditional':
                            questionContent = `<p>${q.text}</p>`;
                            break;
                        case 'problem':
                            questionContent = `
                                <p><strong>Contexte:</strong> ${q.context}</p>
                                <p><strong>Problème:</strong> ${q.text}</p>
                            `;
                            break;
                        case 'qcm':
                            questionContent = `
                                <p>${q.text}</p>
                                <ul>
                                    ${q.options ? q.options.map((opt, i) => 
                                        `<li>${String.fromCharCode(65 + i)}) ${opt} ${q.correctAnswers && q.correctAnswers.includes(i) ? '✓' : ''}</li>`
                                    ).join('') : ''}
                                </ul>
                            `;
                            break;
                        case 'truefalse':
                            questionContent = `
                                <p>${q.text}</p>
                                <p>Réponse correcte: <strong>${q.correctAnswer === 'true' ? 'Vrai' : 'Faux'}</strong></p>
                            `;
                            break;
                        case 'wordsearch':
                            questionContent = `
                                <p><strong>Thème:</strong> ${q.theme}</p>
                                <p><strong>Mots à trouver:</strong> ${q.words}</p>
                                <p><em>Grille de mots mêlés à imprimer</em></p>
                            `;
                            break;
                    }
                    
                    questionsHtml += `
                        <div style="margin-bottom: 15px; padding: 10px; border: 1px solid #ddd; border-radius: 4px;">
                            <p><strong>Question ${index + 1}:</strong> (${q.points} points) - ${getQuestionTypeLabel(q.type)} - Difficulté: ${q.difficulty}</p>
                            ${questionContent}
                        </div>
                    `;
                });
            }
            
            newWindow.document.write(`
                <!DOCTYPE html>
                <html>
                <head>
                    <title>Évaluation - ${evaluation.subject} - ${evalType}</title>
                    <style>
                        body { font-family: Arial, sans-serif; padding: 20px; }
                        .header { text-align: center; margin-bottom: 20px; }
                        .section { margin-bottom: 20px; }
                        .question { margin-bottom: 15px; padding: 10px; border: 1px solid #ddd; border-radius: 4px; }
                    </style>
                </head>
                <body>
                    <div class="header">
                        <h1>${evaluation.subject} - ${evalType}</h1>
                        <h2>${evaluation.class_name} - ${evalDate}</h2>
                    </div>
                    
                    <div class="section">
                        <h3>Informations générales</h3>
                        <p><strong>Enseignant:</strong> ${evaluation.teacher_name}</p>
                        <p><strong>Établissement:</strong> ${evaluation.school_name}</p>
                        <p><strong>Durée:</strong> ${evaluation.duration} minutes</p>
                        <p><strong>Total des points:</strong> ${evaluation.total_points}</p>
                    </div>
                    
                    <div class="section">
                        <h3>Instructions</h3>
                        <p>${evaluation.instructions || 'Aucune instruction spécifiée.'}</p>
                    </div>
                    
                    <div class="section">
                        <h3>Questions</h3>
                        ${questionsHtml}
                    </div>
                    
                    <div class="section">
                        <h3>Barème</h3>
                        <p>Le barème est indicatif et peut être ajusté par l'enseignant.</p>
                    </div>
                    
                    <button onclick="window.print()" style="margin-top: 20px; padding: 10px 15px;">Imprimer</button>
                </body>
                </html>
            `);
            newWindow.document.close();
        }
        
        // Supprimer une évaluation
        function deleteEvaluation(evalId) {
            if (confirm('Êtes-vous sûr de vouloir supprimer cette évaluation ?')) {
                allEvaluations = allEvaluations.filter(e => e.id !== evalId);
                localStorage.setItem('allEvaluations', JSON.stringify(allEvaluations));
                
                // Recharger l'affichage
                populateFilterOptions();
                applyFilters();
                
                alert('Évaluation supprimée avec succès!');
            }
        }
        
        // Écouter les changements sur le total des points
        document.getElementById('total_points').addEventListener('change', updateRatingBars);
        
        // Écouter les changements sur les points des questions
        document.addEventListener('input', function(e) {
            if (e.target.name && e.target.name.includes('points')) {
                updateRatingBars();
            }
        });
    </script>
</body>
</html>