<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gestion des Notes Scolaires</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            line-height: 1.6;
            margin: 0;
            padding: 0;
            background-color: #f5f5f5;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 0 10px rgba(0,0,0,0.1);
        }
        h1, h2, h3, h4 {
            color: #333;
        }
        .section {
            margin-bottom: 30px;
            padding: 20px;
            border: 1px solid #ddd;
            border-radius: 5px;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            margin: 20px 0;
        }
        th, td {
            border: 1px solid #ddd;
            padding: 8px;
            text-align: left;
        }
        th {
            background-color: #f2f2f2;
        }
        tr:nth-child(even) {
            background-color: #f9f9f9;
        }
        form {
            margin-bottom: 20px;
        }
        input, select {
            padding: 8px;
            margin: 5px 0;
            width: 100%;
            box-sizing: border-box;
        }
        button {
            background-color: #4CAF50;
            color: white;
            padding: 10px 15px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            margin-top: 10px;
        }
        button:hover {
            background-color: #45a049;
        }
        .tab {
            overflow: hidden;
            border: 1px solid #ccc;
            background-color: #f1f1f1;
            border-radius: 5px 5px 0 0;
        }
        .tab button {
            background-color: inherit;
            float: left;
            border: none;
            outline: none;
            cursor: pointer;
            padding: 14px 16px;
            transition: 0.3s;
            color: black;
        }
        .tab button:hover {
            background-color: #ddd;
        }
        .tab button.active {
            background-color: #4CAF50;
            color: white;
        }
        .tabcontent {
            display: none;
            padding: 20px;
            border: 1px solid #ccc;
            border-top: none;
            border-radius: 0 0 5px 5px;
        }
        .error {
            color: red;
            font-size: 0.9em;
        }
        .btn-retour {
            padding: 8px 16px;
            background-color: #f0f0f0;
            border: 1px solid #ccc;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
        }
        .btn-retour:hover {
            background-color: #e0e0e0;
        }
        .refresh-button {
            position: fixed;
            bottom: 90px;
            right: 20px;
            background-color: #4285f4;
            color: white;
            border: none;
            border-radius: 50%;
            width: 60px;
            height: 60px;
            text-align: center;
            font-size: 24px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
            cursor: pointer;
            display: flex;
            justify-content: center;
            align-items: center;
            transition: all 0.3s ease;
            z-index: 1000;
        }
        .refresh-button:hover {
            background-color: #3367d6;
            transform: rotate(360deg);
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
        }
        .refresh-icon {
            width: 24px;
            height: 24px;
            fill: white;
        }
        /* Styles pour la consultation */
        .top-students {
            background-color: #e8f5e9;
        }
        .bottom-students {
            background-color: #ffebee;
        }
        .highlight-row {
            font-weight: bold;
        }
        .separator-row {
            height: 10px;
            background-color: #f5f5f5;
        }
        .rank-cell {
            font-weight: bold;
            color: #1976d2;
        }
        .average-cell {
            font-weight: bold;
        }
        .good-average {
            color: #2e7d32;
        }
        .average-average {
            color: #f9a825;
        }
        .bad-average {
            color: #c62828;
        }
        .stats-container {
            display: flex;
            justify-content: space-between;
            flex-wrap: wrap;
        }
        .stat-box {
            flex: 1;
            min-width: 200px;
            margin: 10px;
            padding: 15px;
            border-radius: 5px;
            background-color: #f8f9fa;
        }
        .report-section {
            margin-top: 20px;
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 5px;
            background-color: #f9f9f9;
        }
        .report-options {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-bottom: 15px;
        }
        .report-option {
            flex: 1;
            min-width: 200px;
        }
        .pdf-button {
            background-color: #d32f2f;
            margin-top: 10px;
        }
        .pdf-button:hover {
            background-color: #b71c1c;
        }
        .db-actions {
            margin: 20px 0;
            display: flex;
            gap: 10px;
        }
        .export-btn {
            background-color: #2196F3;
        }
        .import-btn {
            background-color: #4CAF50;
        }
        .clear-btn {
            background-color: #f44336;
        }
    </style>
    <!-- Ajout de la bibliothèque jsPDF -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>
</head>
<body>
    <button class="btn-retour" onclick="history.back()">← Retour</button>
    
    <button onclick="window.location.reload()" class="refresh-button" aria-label="Actualiser la page">
        <svg class="refresh-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
            <path d="M17.65 6.35C16.2 4.9 14.21 4 12 4c-4.42 0-7.99 3.58-7.99 8s3.57 8 7.99 8c3.73 0 6.84-2.55 7.73-6h-2.08c-.82 2.33-3.04 4-5.65 4-3.31 0-6-2.69-6-6s2.69-6 6-6c1.66 0 3.14.69 4.22 1.78L13 11h7V4l-2.35 2.35z"/>
        </svg>
    </button>

    <div class="container">
        <h1>Système de Gestion des Notes Scolaires</h1>
        
        <!-- Actions sur la base de données -->
        <div class="db-actions">
            <button class="export-btn" onclick="exportDatabase()">Exporter les données</button>
            <button class="import-btn" onclick="document.getElementById('import-file').click()">Importer des données</button>
            <button class="clear-btn" onclick="clearDatabase()">Supprimer toutes les données</button>
            <input type="file" id="import-file" style="display: none;" accept=".json" onchange="importDatabase(this)">
        </div>
        
        <div class="tab">
            <button class="tablinks active" onclick="openTab(event, 'Enseignants')">Enseignants</button>
            <button class="tablinks" onclick="openTab(event, 'Matieres')">Matières</button>
            <button class="tablinks" onclick="openTab(event, 'Classes')">Classes</button>
            <button class="tablinks" onclick="openTab(event, 'Attributions')">Attributions</button>
            <button class="tablinks" onclick="openTab(event, 'Eleves')">Élèves</button>
            <button class="tablinks" onclick="openTab(event, 'Notes')">Saisie des Notes</button>
            <button class="tablinks" onclick="openTab(event, 'Consultation')">Consultation</button>
            <button class="tablinks" onclick="openTab(event, 'Rapports')">Rapports PDF</button>
        </div>

        <!-- Section Enseignants -->
        <div id="Enseignants" class="tabcontent" style="display: block;">
            <h2>Gestion des Enseignants</h2>
            <form id="formEnseignant">
                <input type="hidden" id="enseignantId">
                <div>
                    <label for="enseignantNom">Nom:</label>
                    <input type="text" id="enseignantNom" required>
                </div>
                <div>
                    <label for="enseignantPrenom">Prénom:</label>
                    <input type="text" id="enseignantPrenom" required>
                </div>
                <div>
                    <label for="enseignantEmail">Email:</label>
                    <input type="email" id="enseignantEmail" required>
                </div>
                <button type="submit">Enregistrer</button>
                <button type="button" onclick="resetEnseignantForm()">Annuler</button>
            </form>
            
            <h3>Liste des Enseignants</h3>
            <table id="tableEnseignants">
                <thead>
                    <tr>
                        <th>ID</th>
                        <th>Nom</th>
                        <th>Prénom</th>
                        <th>Email</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody></tbody>
            </table>
        </div>

        <!-- Section Matières -->
        <div id="Matieres" class="tabcontent">
            <h2>Gestion des Matières</h2>
            <form id="formMatiere">
                <input type="hidden" id="matiereId">
                <div>
                    <label for="nomMatiere">Nom de la matière:</label>
                    <input type="text" id="nomMatiere" required>
                </div>
                <button type="submit">Enregistrer</button>
                <button type="button" onclick="resetMatiereForm()">Annuler</button>
            </form>
            
            <h3>Liste des Matières</h3>
            <table id="tableMatieres">
                <thead>
                    <tr>
                        <th>ID</th>
                        <th>Nom</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody></tbody>
            </table>
        </div>

        <!-- Section Classes -->
        <div id="Classes" class="tabcontent">
            <h2>Gestion des Classes</h2>
            <form id="formClasse">
                <input type="hidden" id="classeId">
                <div>
                    <label for="nomClasse">Nom de la classe:</label>
                    <input type="text" id="nomClasse" required>
                </div>
                <div>
                    <label for="niveauClasse">Niveau:</label>
                    <input type="text" id="niveauClasse" required>
                </div>
                <button type="submit">Enregistrer</button>
                <button type="button" onclick="resetClasseForm()">Annuler</button>
            </form>
            
            <h3>Liste des Classes</h3>
            <table id="tableClasses">
                <thead>
                    <tr>
                        <th>ID</th>
                        <th>Nom</th>
                        <th>Niveau</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody></tbody>
            </table>
        </div>

        <!-- Section Attributions -->
        <div id="Attributions" class="tabcontent">
            <h2>Attribution des Matières aux Enseignants par Classe</h2>
            <form id="formAttribution">
                <input type="hidden" id="attributionId">
                <div>
                    <label for="attributionEnseignant">Enseignant:</label>
                    <select id="attributionEnseignant" required>
                        <option value="">Sélectionner un enseignant</option>
                    </select>
                </div>
                <div>
                    <label for="attributionMatiere">Matière:</label>
                    <select id="attributionMatiere" required>
                        <option value="">Sélectionner une matière</option>
                    </select>
                </div>
                <div>
                    <label for="attributionClasse">Classe:</label>
                    <select id="attributionClasse" required>
                        <option value="">Sélectionner une classe</option>
                    </select>
                </div>
                <div>
                    <label for="anneeScolaire">Année scolaire:</label>
                    <input type="text" id="anneeScolaire" placeholder="Ex: 2023-2024" required>
                </div>
                <button type="submit">Enregistrer</button>
                <button type="button" onclick="resetAttributionForm()">Annuler</button>
            </form>
            
            <h3>Liste des Attributions</h3>
            <table id="tableAttributions">
                <thead>
                    <tr>
                        <th>ID</th>
                        <th>Enseignant</th>
                        <th>Matière</th>
                        <th>Classe</th>
                        <th>Année</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody></tbody>
            </table>
        </div>

        <!-- Section Élèves -->
        <div id="Eleves" class="tabcontent">
            <h2>Gestion des Élèves</h2>
            <form id="formEleve">
                <input type="hidden" id="eleveId">
                <div>
                    <label for="eleveNom">Nom:</label>
                    <input type="text" id="eleveNom" required>
                </div>
                <div>
                    <label for="elevePrenom">Prénom:</label>
                    <input type="text" id="elevePrenom" required>
                </div>
                <div>
                    <label for="eleveAge">Âge:</label>
                    <input type="number" id="eleveAge" min="5" max="25" required>
                </div>
                <div>
                    <label for="eleveSexe">Sexe:</label>
                    <select id="eleveSexe" required>
                        <option value="">Sélectionner</option>
                        <option value="M">Masculin</option>
                        <option value="F">Féminin</option>
                    </select>
                </div>
                <div>
                    <label for="eleveClasse">Classe:</label>
                    <select id="eleveClasse" required>
                        <option value="">Sélectionner une classe</option>
                    </select>
                </div>
                <button type="submit">Enregistrer</button>
                <button type="button" onclick="resetEleveForm()">Annuler</button>
            </form>
            
            <h3>Liste des Élèves</h3>
            <table id="tableEleves">
                <thead>
                    <tr>
                        <th>ID</th>
                        <th>Nom</th>
                        <th>Prénom</th>
                        <th>Âge</th>
                        <th>Sexe</th>
                        <th>Classe</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody></tbody>
            </table>
        </div>

        <!-- Section Saisie des Notes -->
        <div id="Notes" class="tabcontent">
            <h2>Saisie des Notes</h2>
            <form id="formNote">
                <input type="hidden" id="noteId">
                <div>
                    <label for="noteEnseignant">Enseignant:</label>
                    <select id="noteEnseignant" required onchange="chargerMatieresClasses()">
                        <option value="">Sélectionner un enseignant</option>
                    </select>
                </div>
                <div>
                    <label for="noteMatiere">Matière:</label>
                    <select id="noteMatiere" required>
                        <option value="">Sélectionner une matière</option>
                    </select>
                </div>
                <div>
                    <label for="noteClasse">Classe:</label>
                    <select id="noteClasse" required onchange="chargerEleves()">
                        <option value="">Sélectionner une classe</option>
                    </select>
                </div>
                <div>
                    <label for="noteEleve">Élève:</label>
                    <select id="noteEleve" required>
                        <option value="">Sélectionner un élève</option>
                    </select>
                </div>
                <div>
                    <label for="noteValeur">Note (sur 20):</label>
                    <input type="number" id="noteValeur" min="0" max="20" step="0.01" required>
                </div>
                <div>
                    <label for="noteType">Type d'évaluation:</label>
                    <select id="noteType" required>
                        <option value="DS">Devoir Surveillé</option>
                        <option value="CC">Contrôle Continu</option>
                        <option value="Examen">Examen</option>
                        <option value="Projet">Projet</option>
                    </select>
                </div>
                <div>
                    <label for="noteDate">Date:</label>
                    <input type="date" id="noteDate" required>
                </div>
                <div>
                    <label for="noteCoefficient">Coefficient:</label>
                    <input type="number" id="noteCoefficient" min="1" value="1" required>
                </div>
                <div>
                    <label for="noteCommentaire">Commentaire:</label>
                    <input type="text" id="noteCommentaire">
                </div>
                <button type="submit">Enregistrer</button>
                <button type="button" onclick="resetNoteForm()">Annuler</button>
            </form>
            
            <h3>Notes enregistrées</h3>
            <table id="tableNotes">
                <thead>
                    <tr>
                        <th>ID</th>
                        <th>Élève</th>
                        <th>Matière</th>
                        <th>Classe</th>
                        <th>Note</th>
                        <th>Type</th>
                        <th>Date</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody></tbody>
            </table>
        </div>

        <!-- Section Consultation -->
        <div id="Consultation" class="tabcontent">
            <h2>Consultation des Notes</h2>
            <div>
                <label for="consultationClasse">Classe:</label>
                <select id="consultationClasse" onchange="chargerMatieresConsultation()">
                    <option value="">Toutes les classes</option>
                </select>
            </div>
            <div>
                <label for="consultationMatiere">Matière:</label>
                <select id="consultationMatiere">
                    <option value="">Toutes les matières</option>
                </select>
            </div>
            <div>
                <label for="consultationEnseignant">Enseignant:</label>
                <select id="consultationEnseignant">
                    <option value="">Tous les enseignants</option>
                </select>
            </div>
            <button onclick="filtrerNotes()">Filtrer</button>
            
            <h3>Résultats</h3>
            <div id="resultatsConsultation">
                <p>Sélectionnez des critères de filtrage pour afficher les résultats.</p>
            </div>
        </div>

        <!-- Nouvelle Section Rapports PDF -->
        <div id="Rapports" class="tabcontent">
            <h2>Génération de Rapports PDF</h2>
            
            <div class="report-section">
                <h3>Rapport par Classe</h3>
                <div class="report-options">
                    <div class="report-option">
                        <label for="rapportClasse">Classe:</label>
                        <select id="rapportClasse">
                            <option value="">Toutes les classes</option>
                        </select>
                    </div>
                    <div class="report-option">
                        <label for="rapportMatiereClasse">Matière (optionnel):</label>
                        <select id="rapportMatiereClasse">
                            <option value="">Toutes les matières</option>
                        </select>
                    </div>
                </div>
                <button onclick="genererRapportClasse()" class="pdf-button">Générer PDF</button>
            </div>
            
            <div class="report-section">
                <h3>Rapport par Enseignant</h3>
                <div class="report-options">
                    <div class="report-option">
                        <label for="rapportEnseignant">Enseignant:</label>
                        <select id="rapportEnseignant">
                            <option value="">Tous les enseignants</option>
                        </select>
                    </div>
                    <div class="report-option">
                        <label for="rapportMatiereEnseignant">Matière (optionnel):</label>
                        <select id="rapportMatiereEnseignant">
                            <option value="">Toutes les matières</option>
                        </select>
                    </div>
                </div>
                <button onclick="genererRapportEnseignant()" class="pdf-button">Générer PDF</button>
            </div>
            
            <div class="report-section">
                <h3>Rapport par Matière</h3>
                <div class="report-options">
                    <div class="report-option">
                        <label for="rapportMatiere">Matière:</label>
                        <select id="rapportMatiere">
                            <option value="">Toutes les matières</option>
                        </select>
                    </div>
                    <div class="report-option">
                        <label for="rapportClasseMatiere">Classe (optionnel):</label>
                        <select id="rapportClasseMatiere">
                            <option value="">Toutes les classes</option>
                        </select>
                    </div>
                </div>
                <button onclick="genererRapportMatiere()" class="pdf-button">Générer PDF</button>
            </div>
            
            <div class="report-section">
                <h3>Rapport des Évaluations</h3>
                <div class="report-options">
                    <div class="report-option">
                        <label for="rapportTypeEvaluation">Type d'évaluation:</label>
                        <select id="rapportTypeEvaluation">
                            <option value="">Tous types</option>
                            <option value="DS">Devoir Surveillé</option>
                            <option value="CC">Contrôle Continu</option>
                            <option value="Examen">Examen</option>
                            <option value="Projet">Projet</option>
                        </select>
                    </div>
                    <div class="report-option">
                        <label for="rapportPeriode">Période:</label>
                        <select id="rapportPeriode">
                            <option value="">Toute période</option>
                            <option value="trimestre1">1er Trimestre</option>
                            <option value="trimestre2">2ème Trimestre</option>
                            <option value="trimestre3">3ème Trimestre</option>
                            <option value="semestre1">1er Semestre</option>
                            <option value="semestre2">2ème Semestre</option>
                        </select>
                    </div>
                </div>
                <button onclick="genererRapportEvaluations()" class="pdf-button">Générer PDF</button>
            </div>
        </div>
    </div>

    <script>
        // Variables globales
        let db;
        const { jsPDF } = window.jspdf;
        
        // Initialisation de la base de données
        function initDB() {
            return new Promise((resolve, reject) => {
                console.log("Tentative d'ouverture de la base de données...");
                const request = indexedDB.open('GestionNotesDB', 3);
                
                request.onerror = function(event) {
                    console.error("Erreur d'ouverture de la base de données", event);
                    reject(new Error(`Erreur d'ouverture de la base de données: ${event.target.error}`));
                };
                
                request.onsuccess = function(event) {
                    db = event.target.result;
                    console.log("Base de données ouverte avec succès");
                    
                    // Vérification de la connexion
                    if (!db) {
                        reject(new Error("La connexion à la base de données a échoué"));
                        return;
                    }
                    
                    // Vérifier que tous les objectStores existent
                    const stores = ['enseignants', 'matieres', 'classes', 'attributions', 'eleves', 'notes'];
                    const missingStores = stores.filter(store => !db.objectStoreNames.contains(store));
                    
                    if (missingStores.length > 0) {
                        reject(new Error(`Stores manquants: ${missingStores.join(', ')}`));
                    } else {
                        resolve();
                    }
                };
                
                request.onupgradeneeded = function(event) {
                    console.log("Mise à jour de la structure de la base de données");
                    const db = event.target.result;
                    const oldVersion = event.oldVersion;
                    
                    if (oldVersion < 1) {
                        // Création des tables pour la version 1
                        const enseignantStore = db.createObjectStore('enseignants', { keyPath: 'id', autoIncrement: true });
                        enseignantStore.createIndex('email', 'email', { unique: true });
                        
                        db.createObjectStore('matieres', { keyPath: 'id', autoIncrement: true });
                        db.createObjectStore('classes', { keyPath: 'id', autoIncrement: true });
                        
                        const attributionStore = db.createObjectStore('attributions', { keyPath: 'id', autoIncrement: true });
                        attributionStore.createIndex('enseignant_matiere_classe', ['id_enseignant', 'id_matiere', 'id_classe'], { unique: true });
                        
                        db.createObjectStore('eleves', { keyPath: 'id', autoIncrement: true });
                        db.createObjectStore('notes', { keyPath: 'id', autoIncrement: true });
                    }
                    
                    if (oldVersion < 2) {
                        // Mise à jour pour la version 2
                        const transaction = event.target.transaction;
                        const eleveStore = transaction.objectStore('eleves');
                        
                        eleveStore.getAll().onsuccess = function(e) {
                            const eleves = e.target.result;
                            eleves.forEach(eleve => {
                                if (typeof eleve.age === 'undefined') {
                                    eleve.age = 10;
                                }
                                if (typeof eleve.sexe === 'undefined') {
                                    eleve.sexe = 'M';
                                }
                                eleveStore.put(eleve);
                            });
                        };
                    }
                    
                    if (oldVersion < 3) {
                        // Mise à jour pour la version 3 - Ajout des données initiales
                        addInitialData(event.target.transaction);
                    }
                };
                
                request.onblocked = function(event) {
                    console.error("La base de données est bloquée par une autre connexion");
                    reject(new Error("La base de données est bloquée. Fermez les autres onglets utilisant cette application."));
                };
            });
        }

        function addInitialData(transaction) {
            // Ajout des enseignants initiaux
            const enseignants = [
                {nom: "KOLA", prenom: "Jean", email: "jean@example.com"}
            ];
            
            enseignants.forEach(enseignant => {
                transaction.objectStore('enseignants').add(enseignant);
            });
            
            // Ajout des matières initiales
            const matieres = [
                {nom: "Mathématiques"},
                {nom: "Français"},
                {nom: "Histoire-Géographie"}
            ];
            
            matieres.forEach(matiere => {
                transaction.objectStore('matieres').add(matiere);
            });
            
            // Ajout des classes initiales
            const classes = [
                {nom: "6ème", niveau: "Collège"},
                {nom: "Tle D", niveau: "Lycée"}
            ];
            
            classes.forEach(classe => {
                transaction.objectStore('classes').add(classe);
            });
            
            // Ajout des attributions initiales
            const attributions = [
                {id_enseignant: 1, id_matiere: 1, id_classe: 1, annee: "2024-2025"},
                {id_enseignant: 1, id_matiere: 2, id_classe: 1, annee: "2024-2025"},
                {id_enseignant: 1, id_matiere: 1, id_classe: 2, annee: "2024-2025"}
            ];
            
            attributions.forEach(attribution => {
                transaction.objectStore('attributions').add(attribution);
            });
            
            // Ajout des élèves initiaux
            const eleves = [
                {nom: "Durand", prenom: "Pierre", age: 12, sexe: "M", id_classe: 1},
                {nom: "Leroy", prenom: "Marie", age: 11, sexe: "F", id_classe: 1},
                {nom: "Moreau", prenom: "Luc", age: 18, sexe: "M", id_classe: 2}
            ];
            
            eleves.forEach(eleve => {
                transaction.objectStore('eleves').add(eleve);
            });
            
            // Ajout des notes initiales
            const notes = [
                {id_enseignement: 1, id_eleve: 1, note: 15, type: "DS", date: "2023-10-15", coefficient: 2, commentaire: "Très bien"},
                {id_enseignement: 1, id_eleve: 2, note: 12, type: "DS", date: "2023-10-15", coefficient: 2, commentaire: "Bien"},
                {id_enseignement: 3, id_eleve: 3, note: 18, type: "CC", date: "2023-10-10", coefficient: 1, commentaire: "Excellent"}
            ];
            
            notes.forEach(note => {
                transaction.objectStore('notes').add(note);
            });
        }

        // Fonctions de base pour la base de données
        function addItem(storeName, item) {
            return new Promise((resolve, reject) => {
                const transaction = db.transaction([storeName], 'readwrite');
                const store = transaction.objectStore(storeName);
                
                const request = store.add(item);
                
                request.onsuccess = function() {
                    resolve(request.result);
                };
                
                request.onerror = function(event) {
                    reject(new Error("Erreur lors de l'ajout: " + event.target.error));
                };
            });
        }
        
        function updateItem(storeName, item) {
            return new Promise((resolve, reject) => {
                const transaction = db.transaction([storeName], 'readwrite');
                const store = transaction.objectStore(storeName);
                
                const request = store.put(item);
                
                request.onsuccess = function() {
                    resolve();
                };
                
                request.onerror = function(event) {
                    reject(new Error("Erreur lors de la mise à jour: " + event.target.error));
                };
            });
        }
        
        function deleteItem(storeName, id) {
            return new Promise((resolve, reject) => {
                const transaction = db.transaction([storeName], 'readwrite');
                const store = transaction.objectStore(storeName);
                
                const request = store.delete(id);
                
                request.onsuccess = function() {
                    resolve();
                };
                
                request.onerror = function(event) {
                    reject(new Error("Erreur lors de la suppression: " + event.target.error));
                };
            });
        }
        
        function getAllItems(storeName) {
            return new Promise((resolve, reject) => {
                const transaction = db.transaction([storeName], 'readonly');
                const store = transaction.objectStore(storeName);
                
                const request = store.getAll();
                
                request.onsuccess = function() {
                    resolve(request.result);
                };
                
                request.onerror = function(event) {
                    reject(new Error("Erreur lors de la récupération: " + event.target.error));
                };
            });
        }
        
        function getItemById(storeName, id) {
            return new Promise((resolve, reject) => {
                const transaction = db.transaction([storeName], 'readonly');
                const store = transaction.objectStore(storeName);
                
                const request = store.get(id);
                
                request.onsuccess = function() {
                    resolve(request.result);
                };
                
                request.onerror = function(event) {
                    reject(new Error("Erreur lors de la récupération: " + event.target.error));
                };
            });
        }

        // Fonctions d'interface utilisateur
        function openTab(evt, tabName) {
            let i, tabcontent, tablinks;
            
            tabcontent = document.getElementsByClassName("tabcontent");
            for (i = 0; i < tabcontent.length; i++) {
                tabcontent[i].style.display = "none";
            }
            
            tablinks = document.getElementsByClassName("tablinks");
            for (i = 0; i < tablinks.length; i++) {
                tablinks[i].className = tablinks[i].className.replace(" active", "");
            }
            
            document.getElementById(tabName).style.display = "block";
            evt.currentTarget.className += " active";
        }

        // Fonctions pour remplir les sélecteurs
        async function fillSelectOptions() {
            try {
                const enseignants = await getAllItems('enseignants');
                const matieres = await getAllItems('matieres');
                const classes = await getAllItems('classes');
                
                // Remplir les sélecteurs pour les formulaires
                const selectEnseignants = document.querySelectorAll("select[id$='Enseignant']");
                selectEnseignants.forEach(select => {
                    select.innerHTML = '<option value="">Sélectionner un enseignant</option>';
                    enseignants.forEach(ens => {
                        select.innerHTML += `<option value="${ens.id}">${ens.nom} ${ens.prenom}</option>`;
                    });
                });
                
                const selectMatieres = document.querySelectorAll("select[id$='Matiere']");
                selectMatieres.forEach(select => {
                    select.innerHTML = '<option value="">Sélectionner une matière</option>';
                    matieres.forEach(mat => {
                        select.innerHTML += `<option value="${mat.id}">${mat.nom}</option>`;
                    });
                });
                
                const selectClasses = document.querySelectorAll("select[id$='Classe']");
                selectClasses.forEach(select => {
                    select.innerHTML = '<option value="">Sélectionner une classe</option>';
                    classes.forEach(cl => {
                        select.innerHTML += `<option value="${cl.id}">${cl.nom} (${cl.niveau})</option>`;
                    });
                });
                
                // Remplir les sélecteurs pour la consultation
                document.getElementById("consultationClasse").innerHTML = '<option value="">Toutes les classes</option>';
                classes.forEach(cl => {
                    document.getElementById("consultationClasse").innerHTML += `<option value="${cl.id}">${cl.nom} (${cl.niveau})</option>`;
                });
                
                document.getElementById("consultationEnseignant").innerHTML = '<option value="">Tous les enseignants</option>';
                enseignants.forEach(ens => {
                    document.getElementById("consultationEnseignant").innerHTML += `<option value="${ens.id}">${ens.nom} ${ens.prenom}</option>`;
                });
                
                // Remplir les sélecteurs pour les rapports PDF
                document.getElementById("rapportClasse").innerHTML = '<option value="">Toutes les classes</option>';
                classes.forEach(cl => {
                    document.getElementById("rapportClasse").innerHTML += `<option value="${cl.id}">${cl.nom} (${cl.niveau})</option>`;
                });
                
                document.getElementById("rapportMatiereClasse").innerHTML = '<option value="">Toutes les matières</option>';
                matieres.forEach(mat => {
                    document.getElementById("rapportMatiereClasse").innerHTML += `<option value="${mat.id}">${mat.nom}</option>`;
                });
                
                document.getElementById("rapportEnseignant").innerHTML = '<option value="">Tous les enseignants</option>';
                enseignants.forEach(ens => {
                    document.getElementById("rapportEnseignant").innerHTML += `<option value="${ens.id}">${ens.nom} ${ens.prenom}</option>`;
                });
                
                document.getElementById("rapportMatiereEnseignant").innerHTML = '<option value="">Toutes les matières</option>';
                matieres.forEach(mat => {
                    document.getElementById("rapportMatiereEnseignant").innerHTML += `<option value="${mat.id}">${mat.nom}</option>`;
                });
                
                document.getElementById("rapportMatiere").innerHTML = '<option value="">Toutes les matières</option>';
                matieres.forEach(mat => {
                    document.getElementById("rapportMatiere").innerHTML += `<option value="${mat.id}">${mat.nom}</option>`;
                });
                
                document.getElementById("rapportClasseMatiere").innerHTML = '<option value="">Toutes les classes</option>';
                classes.forEach(cl => {
                    document.getElementById("rapportClasseMatiere").innerHTML += `<option value="${cl.id}">${cl.nom} (${cl.niveau})</option>`;
                });
                
            } catch (error) {
                console.error("Erreur lors du remplissage des options:", error);
            }
        }
        
        // Fonctions pour charger les données dynamiques
        async function chargerMatieresClasses() {
            const enseignantId = document.getElementById("noteEnseignant").value;
            const matiereSelect = document.getElementById("noteMatiere");
            const classeSelect = document.getElementById("noteClasse");
            
            matiereSelect.innerHTML = '<option value="">Sélectionner une matière</option>';
            classeSelect.innerHTML = '<option value="">Sélectionner une classe</option>';
            
            if (!enseignantId) return;
            
            try {
                const attributions = await getAllItems('attributions');
                const attribs = attributions.filter(a => a.id_enseignant == enseignantId);
                
                const matieres = await getAllItems('matieres');
                const classes = await getAllItems('classes');
                
                const matieresEnseignant = [];
                attribs.forEach(att => {
                    const matiere = matieres.find(m => m.id == att.id_matiere);
                    if (matiere && !matieresEnseignant.some(m => m.id == matiere.id)) {
                        matieresEnseignant.push(matiere);
                    }
                });
                
                matieresEnseignant.forEach(mat => {
                    matiereSelect.innerHTML += `<option value="${mat.id}">${mat.nom}</option>`;
                });
                
                const classesEnseignant = [];
                attribs.forEach(att => {
                    const classe = classes.find(c => c.id == att.id_classe);
                    if (classe && !classesEnseignant.some(c => c.id == classe.id)) {
                        classesEnseignant.push(classe);
                    }
                });
                
                classesEnseignant.forEach(cl => {
                    classeSelect.innerHTML += `<option value="${cl.id}">${cl.nom} (${cl.niveau})</option>`;
                });
            } catch (error) {
                console.error("Erreur lors du chargement des matières et classes:", error);
            }
        }
        
        async function chargerEleves() {
            const classeId = document.getElementById("noteClasse").value;
            const eleveSelect = document.getElementById("noteEleve");
            
            eleveSelect.innerHTML = '<option value="">Sélectionner un élève</option>';
            
            if (!classeId) return;
            
            try {
                const eleves = await getAllItems('eleves');
                const elevesClasse = eleves.filter(e => e.id_classe == classeId);
                elevesClasse.forEach(el => {
                    eleveSelect.innerHTML += `<option value="${el.id}">${el.nom} ${el.prenom}</option>`;
                });
            } catch (error) {
                console.error("Erreur lors du chargement des élèves:", error);
            }
        }
        
        async function chargerMatieresConsultation() {
            const classeId = document.getElementById("consultationClasse").value;
            const matiereSelect = document.getElementById("consultationMatiere");
            
            matiereSelect.innerHTML = '<option value="">Toutes les matières</option>';
            
            try {
                const matieres = await getAllItems('matieres');
                
                if (!classeId) {
                    matieres.forEach(mat => {
                        matiereSelect.innerHTML += `<option value="${mat.id}">${mat.nom}</option>`;
                    });
                    return;
                }
                
                const attributions = await getAllItems('attributions');
                const matieresClasse = [];
                
                attributions.forEach(att => {
                    if (att.id_classe == classeId) {
                        const matiere = matieres.find(m => m.id == att.id_matiere);
                        if (matiere && !matieresClasse.some(m => m.id == matiere.id)) {
                            matieresClasse.push(matiere);
                        }
                    }
                });
                
                matieresClasse.forEach(mat => {
                    matiereSelect.innerHTML += `<option value="${mat.id}">${mat.nom}</option>`;
                });
            } catch (error) {
                console.error("Erreur lors du chargement des matières:", error);
            }
        }
        
        // Fonctions pour la consultation des notes
        async function filtrerNotes() {
            const classeId = document.getElementById("consultationClasse").value;
            const matiereId = document.getElementById("consultationMatiere").value;
            const enseignantId = document.getElementById("consultationEnseignant").value;
            
            try {
                let notes = await getAllItems('notes');
                let notesFiltrees = [...notes];
                
                if (classeId) {
                    const eleves = await getAllItems('eleves');
                    const elevesClasse = eleves.filter(e => e.id_classe == classeId).map(e => e.id);
                    notesFiltrees = notesFiltrees.filter(n => elevesClasse.includes(n.id_eleve));
                }
                
                if (matiereId) {
                    const attributions = await getAllItems('attributions');
                    const enseignements = attributions.filter(a => a.id_matiere == matiereId).map(a => a.id);
                    notesFiltrees = notesFiltrees.filter(n => enseignements.includes(n.id_enseignement));
                }
                
                if (enseignantId) {
                    const attributions = await getAllItems('attributions');
                    const enseignements = attributions.filter(a => a.id_enseignant == enseignantId).map(a => a.id);
                    notesFiltrees = notesFiltrees.filter(n => enseignements.includes(n.id_enseignement));
                }
                
                await afficherResultatsConsultation(notesFiltrees);
            } catch (error) {
                console.error("Erreur lors du filtrage des notes:", error);
                document.getElementById("resultatsConsultation").innerHTML = "<p>Erreur lors du filtrage des notes</p>";
            }
        }
        
        async function afficherResultatsConsultation(notesFiltrees) {
            const resultatsDiv = document.getElementById("resultatsConsultation");
            
            if (notesFiltrees.length === 0) {
                resultatsDiv.innerHTML = "<p>Aucun résultat trouvé avec ces critères de filtrage.</p>";
                return;
            }
            
            try {
                const attributions = await getAllItems('attributions');
                const matieres = await getAllItems('matieres');
                const classes = await getAllItems('classes');
                const eleves = await getAllItems('eleves');
                const enseignants = await getAllItems('enseignants');
                
                const moyennesParEleve = {};
                
                notesFiltrees.forEach(note => {
                    if (!moyennesParEleve[note.id_eleve]) {
                        moyennesParEleve[note.id_eleve] = {
                            sommeNotes: 0,
                            sommeCoefficients: 0,
                            count: 0
                        };
                    }
                    
                    moyennesParEleve[note.id_eleve].sommeNotes += note.note * note.coefficient;
                    moyennesParEleve[note.id_eleve].sommeCoefficients += note.coefficient;
                    moyennesParEleve[note.id_eleve].count++;
                });
                
                const resultats = [];
                
                for (const eleveId in moyennesParEleve) {
                    const eleve = eleves.find(e => e.id == eleveId);
                    const moyenne = moyennesParEleve[eleveId].sommeNotes / moyennesParEleve[eleveId].sommeCoefficients;
                    
                    resultats.push({
                        eleveId: parseInt(eleveId),
                        nom: eleve.nom,
                        prenom: eleve.prenom,
                        age: eleve.age,
                        sexe: eleve.sexe === 'M' ? 'Masculin' : 'Féminin',
                        classe: classes.find(c => c.id == eleve.id_classe).nom,
                        moyenne: moyenne,
                        nbNotes: moyennesParEleve[eleveId].count
                    });
                }
                
                resultats.sort((a, b) => b.moyenne - a.moyenne);
                
                resultats.forEach((result, index) => {
                    result.rang = index + 1;
                });
                
                const top5 = resultats.slice(0, 5);
                const bottom5 = resultats.slice(-5);
                const autres = resultats.slice(5, -5);
                
                let html = '<h4>Classement des élèves</h4>';
                html += '<table><thead><tr>';
                html += '<th>Rang</th>';
                html += '<th>Élève</th>';
                html += '<th>Âge</th>';
                html += '<th>Sexe</th>';
                html += '<th>Classe</th>';
                html += '<th>Moyenne</th>';
                html += '<th>Nombre de notes</th>';
                html += '</tr></thead><tbody>';
                
                top5.forEach(result => {
                    html += `<tr class="top-students highlight-row">`;
                    html += `<td class="rank-cell">${result.rang}</td>`;
                    html += `<td>${result.nom} ${result.prenom}</td>`;
                    html += `<td>${result.age} ans</td>`;
                    html += `<td>${result.sexe}</td>`;
                    html += `<td>${result.classe}</td>`;
                    html += `<td class="average-cell good-average">${result.moyenne.toFixed(2)}/20</td>`;
                    html += `<td>${result.nbNotes}</td>`;
                    html += '</tr>';
                });
                
                if (autres.length > 0) {
                    html += '<tr class="separator-row"><td colspan="7"></td></tr>';
                }
                
                autres.forEach(result => {
                    const averageClass = result.moyenne >= 12 ? 'good-average' : 
                                        result.moyenne >= 8 ? 'average-average' : 'bad-average';
                    
                    html += `<tr>`;
                    html += `<td class="rank-cell">${result.rang}</td>`;
                    html += `<td>${result.nom} ${result.prenom}</td>`;
                    html += `<td>${result.age} ans</td>`;
                    html += `<td>${result.sexe}</td>`;
                    html += `<td>${result.classe}</td>`;
                    html += `<td class="average-cell ${averageClass}">${result.moyenne.toFixed(2)}/20</td>`;
                    html += `<td>${result.nbNotes}</td>`;
                    html += '</tr>';
                });
                
                if (bottom5.length > 0 && (top5.length > 0 || autres.length > 0)) {
                    html += '<tr class="separator-row"><td colspan="7"></td></tr>';
                }
                
                bottom5.forEach(result => {
                    html += `<tr class="bottom-students highlight-row">`;
                    html += `<td class="rank-cell">${result.rang}</td>`;
                    html += `<td>${result.nom} ${result.prenom}</td>`;
                    html += `<td>${result.age} ans</td>`;
                    html += `<td>${result.sexe}</td>`;
                    html += `<td>${result.classe}</td>`;
                    html += `<td class="average-cell bad-average">${result.moyenne.toFixed(2)}/20</td>`;
                    html += `<td>${result.nbNotes}</td>`;
                    html += '</tr>';
                });
                
                html += '</tbody></table>';
                
                if (resultats.length > 0) {
                    const moyenneClasse = resultats.reduce((sum, result) => sum + result.moyenne, 0) / resultats.length;
                    const meilleur = resultats[0];
                    const moinsBon = resultats[resultats.length - 1];
                    
                    html += '<div class="stats-container">';
                    html += '<div class="stat-box">';
                    html += '<h4>Statistiques de la classe</h4>';
                    html += `<p>Nombre d'élèves: <strong>${resultats.length}</strong></p>`;
                    html += `<p>Moyenne de la classe: <strong>${moyenneClasse.toFixed(2)}/20</strong></p>`;
                    html += '</div>';
                    
                    html += '<div class="stat-box">';
                    html += '<h4>Meilleur élève</h4>';
                    html += `<p>${meilleur.nom} ${meilleur.prenom}</p>`;
                    html += `<p>Moyenne: <strong class="good-average">${meilleur.moyenne.toFixed(2)}/20</strong></p>`;
                    html += `<p>Âge: ${meilleur.age} ans | Sexe: ${meilleur.sexe}</p>`;
                    html += '</div>';
                    
                    html += '<div class="stat-box">';
                    html += '<h4>Élève en difficulté</h4>';
                    html += `<p>${moinsBon.nom} ${moinsBon.prenom}</p>`;
                    html += `<p>Moyenne: <strong class="bad-average">${moinsBon.moyenne.toFixed(2)}/20</strong></p>`;
                    html += `<p>Âge: ${moinsBon.age} ans | Sexe: ${moinsBon.sexe}</p>`;
                    html += '</div>';
                    html += '</div>';
                }
                
                resultatsDiv.innerHTML = html;
            } catch (error) {
                console.error("Erreur lors de l'affichage des résultats:", error);
                resultatsDiv.innerHTML = "<p>Erreur lors de l'affichage des résultats</p>";
            }
        }
        
        // Fonctions pour générer les rapports PDF
        async function genererRapportClasse() {
            const classeId = document.getElementById("rapportClasse").value;
            const matiereId = document.getElementById("rapportMatiereClasse").value;
            
            try {
                const classes = await getAllItems('classes');
                const eleves = await getAllItems('eleves');
                const notes = await getAllItems('notes');
                const attributions = await getAllItems('attributions');
                const matieres = await getAllItems('matieres');
                const enseignants = await getAllItems('enseignants');
                
                // Filtrer les élèves par classe
                let elevesFiltres = [...eleves];
                if (classeId) {
                    elevesFiltres = elevesFiltres.filter(e => e.id_classe == classeId);
                }
                
                // Filtrer les notes par matière si spécifiée
                let notesFiltrees = [...notes];
                if (matiereId) {
                    const enseignements = attributions.filter(a => a.id_matiere == matiereId).map(a => a.id);
                    notesFiltrees = notesFiltrees.filter(n => enseignements.includes(n.id_enseignement));
                }
                
                // Créer un nouveau document PDF
                const doc = new jsPDF();
                
                // Titre du rapport
                let titre = "Rapport des notes par classe";
                if (classeId) {
                    const classe = classes.find(c => c.id == classeId);
                    titre += ` - ${classe.nom} (${classe.niveau})`;
                }
                if (matiereId) {
                    const matiere = matieres.find(m => m.id == matiereId);
                    titre += ` - ${matiere.nom}`;
                }
                
                doc.setFontSize(16);
                doc.text(titre, 14, 20);
                doc.setFontSize(12);
                doc.text(`Généré le ${new Date().toLocaleDateString()}`, 14, 30);
                
                // Tableau des notes
                const headers = ["Élève", "Classe", "DS", "CC", "Examen", "Projet", "Moyenne"];
                const data = [];
                
                // Calculer les moyennes pour chaque élève
                elevesFiltres.forEach(eleve => {
                    const notesEleve = notesFiltrees.filter(n => n.id_eleve == eleve.id);
                    const classe = classes.find(c => c.id == eleve.id_classe);
                    
                    // Calculer les moyennes par type
                    const notesDS = notesEleve.filter(n => n.type === "DS");
                    const notesCC = notesEleve.filter(n => n.type === "CC");
                    const notesExam = notesEleve.filter(n => n.type === "Examen");
                    const notesProjet = notesEleve.filter(n => n.type === "Projet");
                    
                    const moyenneDS = notesDS.length > 0 ? 
                        notesDS.reduce((sum, n) => sum + n.note, 0) / notesDS.length : null;
                    const moyenneCC = notesCC.length > 0 ? 
                        notesCC.reduce((sum, n) => sum + n.note, 0) / notesCC.length : null;
                    const moyenneExam = notesExam.length > 0 ? 
                        notesExam.reduce((sum, n) => sum + n.note, 0) / notesExam.length : null;
                    const moyenneProjet = notesProjet.length > 0 ? 
                        notesProjet.reduce((sum, n) => sum + n.note, 0) / notesProjet.length : null;
                    
                    // Calculer la moyenne générale
                    const moyenneGenerale = notesEleve.length > 0 ? 
                        notesEleve.reduce((sum, n) => sum + n.note, 0) / notesEleve.length : null;
                    
                    data.push([
                        `${eleve.nom} ${eleve.prenom}`,
                        classe ? `${classe.nom} (${classe.niveau})` : "",
                        moyenneDS ? moyenneDS.toFixed(2) : "-",
                        moyenneCC ? moyenneCC.toFixed(2) : "-",
                        moyenneExam ? moyenneExam.toFixed(2) : "-",
                        moyenneProjet ? moyenneProjet.toFixed(2) : "-",
                        moyenneGenerale ? moyenneGenerale.toFixed(2) : "-"
                    ]);
                });
                
                // Ajouter le tableau au PDF
                doc.autoTable({
                    head: [headers],
                    body: data,
                    startY: 40,
                    styles: {
                        fontSize: 10,
                        cellPadding: 3,
                        overflow: 'linebreak'
                    },
                    headStyles: {
                        fillColor: [41, 128, 185],
                        textColor: 255,
                        fontStyle: 'bold'
                    },
                    alternateRowStyles: {
                        fillColor: [245, 245, 245]
                    },
                    columnStyles: {
                        0: {cellWidth: 40},
                        1: {cellWidth: 30},
                        2: {cellWidth: 20},
                        3: {cellWidth: 20},
                        4: {cellWidth: 20},
                        5: {cellWidth: 20},
                        6: {cellWidth: 20}
                    }
                });
                
                // Enregistrer le PDF
                let nomFichier = "Rapport_Classe";
                if (classeId) {
                    const classe = classes.find(c => c.id == classeId);
                    nomFichier += `_${classe.nom.replace(/\s+/g, '_')}`;
                }
                if (matiereId) {
                    const matiere = matieres.find(m => m.id == matiereId);
                    nomFichier += `_${matiere.nom.replace(/\s+/g, '_')}`;
                }
                nomFichier += ".pdf";
                
                doc.save(nomFichier);
                
            } catch (error) {
                console.error("Erreur lors de la génération du rapport:", error);
                alert("Erreur lors de la génération du rapport PDF");
            }
        }
        
        async function genererRapportEnseignant() {
            const enseignantId = document.getElementById("rapportEnseignant").value;
            const matiereId = document.getElementById("rapportMatiereEnseignant").value;
            
            try {
                const enseignants = await getAllItems('enseignants');
                const eleves = await getAllItems('eleves');
                const notes = await getAllItems('notes');
                const attributions = await getAllItems('attributions');
                const matieres = await getAllItems('matieres');
                const classes = await getAllItems('classes');
                
                // Filtrer les attributions par enseignant
                let attributionsFiltrees = [...attributions];
                if (enseignantId) {
                    attributionsFiltrees = attributionsFiltrees.filter(a => a.id_enseignant == enseignantId);
                }
                
                // Filtrer par matière si spécifiée
                if (matiereId) {
                    attributionsFiltrees = attributionsFiltrees.filter(a => a.id_matiere == matiereId);
                }
                
                // Récupérer les IDs des enseignements
                const enseignementsIds = attributionsFiltrees.map(a => a.id);
                
                // Filtrer les notes par ces enseignements
                const notesFiltrees = notes.filter(n => enseignementsIds.includes(n.id_enseignement));
                
                // Créer un nouveau document PDF
                const doc = new jsPDF();
                
                // Titre du rapport
                let titre = "Rapport des notes par enseignant";
                if (enseignantId) {
                    const enseignant = enseignants.find(e => e.id == enseignantId);
                    titre += ` - ${enseignant.nom} ${enseignant.prenom}`;
                }
                if (matiereId) {
                    const matiere = matieres.find(m => m.id == matiereId);
                    titre += ` - ${matiere.nom}`;
                }
                
                doc.setFontSize(16);
                doc.text(titre, 14, 20);
                doc.setFontSize(12);
                doc.text(`Généré le ${new Date().toLocaleDateString()}`, 14, 30);
                
                // Tableau des notes
                const headers = ["Élève", "Classe", "Matière", "DS", "CC", "Examen", "Projet", "Moyenne"];
                const data = [];
                
                // Grouper les notes par élève et matière
                const notesParEleveMatiere = {};
                
                notesFiltrees.forEach(note => {
                    const attribution = attributions.find(a => a.id == note.id_enseignement);
                    const matiere = matieres.find(m => m.id == attribution.id_matiere);
                    const enseignant = enseignants.find(e => e.id == attribution.id_enseignant);
                    const eleve = eleves.find(e => e.id == note.id_eleve);
                    const classe = classes.find(c => c.id == eleve.id_classe);
                    
                    const key = `${eleve.id}_${matiere.id}`;
                    if (!notesParEleveMatiere[key]) {
                        notesParEleveMatiere[key] = {
                            eleve: eleve,
                            matiere: matiere,
                            classe: classe,
                            notesDS: [],
                            notesCC: [],
                            notesExam: [],
                            notesProjet: []
                        };
                    }
                    
                    switch(note.type) {
                        case "DS": notesParEleveMatiere[key].notesDS.push(note); break;
                        case "CC": notesParEleveMatiere[key].notesCC.push(note); break;
                        case "Examen": notesParEleveMatiere[key].notesExam.push(note); break;
                        case "Projet": notesParEleveMatiere[key].notesProjet.push(note); break;
                    }
                });
                
                // Calculer les moyennes et remplir le tableau
                Object.values(notesParEleveMatiere).forEach(item => {
                    const moyenneDS = item.notesDS.length > 0 ? 
                        item.notesDS.reduce((sum, n) => sum + n.note, 0) / item.notesDS.length : null;
                    const moyenneCC = item.notesCC.length > 0 ? 
                        item.notesCC.reduce((sum, n) => sum + n.note, 0) / item.notesCC.length : null;
                    const moyenneExam = item.notesExam.length > 0 ? 
                        item.notesExam.reduce((sum, n) => sum + n.note, 0) / item.notesExam.length : null;
                    const moyenneProjet = item.notesProjet.length > 0 ? 
                        item.notesProjet.reduce((sum, n) => sum + n.note, 0) / item.notesProjet.length : null;
                    
                    // Calculer la moyenne générale pour cette matière
                    const toutesNotes = [...item.notesDS, ...item.notesCC, ...item.notesExam, ...item.notesProjet];
                    const moyenneGenerale = toutesNotes.length > 0 ? 
                        toutesNotes.reduce((sum, n) => sum + n.note, 0) / toutesNotes.length : null;
                    
                    data.push([
                        `${item.eleve.nom} ${item.eleve.prenom}`,
                        item.classe ? `${item.classe.nom} (${item.classe.niveau})` : "",
                        item.matiere.nom,
                        moyenneDS ? moyenneDS.toFixed(2) : "-",
                        moyenneCC ? moyenneCC.toFixed(2) : "-",
                        moyenneExam ? moyenneExam.toFixed(2) : "-",
                        moyenneProjet ? moyenneProjet.toFixed(2) : "-",
                        moyenneGenerale ? moyenneGenerale.toFixed(2) : "-"
                    ]);
                });
                
                // Ajouter le tableau au PDF
                doc.autoTable({
                    head: [headers],
                    body: data,
                    startY: 40,
                    styles: {
                        fontSize: 10,
                        cellPadding: 3,
                        overflow: 'linebreak'
                    },
                    headStyles: {
                        fillColor: [41, 128, 185],
                        textColor: 255,
                        fontStyle: 'bold'
                    },
                    alternateRowStyles: {
                        fillColor: [245, 245, 245]
                    },
                    columnStyles: {
                        0: {cellWidth: 30},
                        1: {cellWidth: 25},
                        2: {cellWidth: 25},
                        3: {cellWidth: 15},
                        4: {cellWidth: 15},
                        5: {cellWidth: 15},
                        6: {cellWidth: 15},
                        7: {cellWidth: 15}
                    }
                });
                
                // Enregistrer le PDF
                let nomFichier = "Rapport_Enseignant";
                if (enseignantId) {
                    const enseignant = enseignants.find(e => e.id == enseignantId);
                    nomFichier += `_${enseignant.nom}_${enseignant.prenom}`;
                }
                if (matiereId) {
                    const matiere = matieres.find(m => m.id == matiereId);
                    nomFichier += `_${matiere.nom.replace(/\s+/g, '_')}`;
                }
                nomFichier += ".pdf";
                
                doc.save(nomFichier);
                
            } catch (error) {
                console.error("Erreur lors de la génération du rapport:", error);
                alert("Erreur lors de la génération du rapport PDF");
            }
        }
        
        async function genererRapportMatiere() {
            const matiereId = document.getElementById("rapportMatiere").value;
            const classeId = document.getElementById("rapportClasseMatiere").value;
            
            try {
                const matieres = await getAllItems('matieres');
                const eleves = await getAllItems('eleves');
                const notes = await getAllItems('notes');
                const attributions = await getAllItems('attributions');
                const classes = await getAllItems('classes');
                const enseignants = await getAllItems('enseignants');
                
                // Filtrer les attributions par matière
                let attributionsFiltrees = [...attributions];
                if (matiereId) {
                    attributionsFiltrees = attributionsFiltrees.filter(a => a.id_matiere == matiereId);
                }
                
                // Filtrer par classe si spécifiée
                if (classeId) {
                    attributionsFiltrees = attributionsFiltrees.filter(a => a.id_classe == classeId);
                }
                
                // Récupérer les IDs des enseignements
                const enseignementsIds = attributionsFiltrees.map(a => a.id);
                
                // Filtrer les notes par ces enseignements
                const notesFiltrees = notes.filter(n => enseignementsIds.includes(n.id_enseignement));
                
                // Créer un nouveau document PDF
                const doc = new jsPDF();
                
                // Titre du rapport
                let titre = "Rapport des notes par matière";
                if (matiereId) {
                    const matiere = matieres.find(m => m.id == matiereId);
                    titre += ` - ${matiere.nom}`;
                }
                if (classeId) {
                    const classe = classes.find(c => c.id == classeId);
                    titre += ` - ${classe.nom} (${classe.niveau})`;
                }
                
                doc.setFontSize(16);
                doc.text(titre, 14, 20);
                doc.setFontSize(12);
                doc.text(`Généré le ${new Date().toLocaleDateString()}`, 14, 30);
                
                // Tableau des notes
                const headers = ["Élève", "Classe", "Enseignant", "DS", "CC", "Examen", "Projet", "Moyenne"];
                const data = [];
                
                // Grouper les notes par élève et enseignant
                const notesParEleveEnseignant = {};
                
                notesFiltrees.forEach(note => {
                    const attribution = attributions.find(a => a.id == note.id_enseignement);
                    const enseignant = enseignants.find(e => e.id == attribution.id_enseignant);
                    const eleve = eleves.find(e => e.id == note.id_eleve);
                    const classe = classes.find(c => c.id == eleve.id_classe);
                    
                    const key = `${eleve.id}_${enseignant.id}`;
                    if (!notesParEleveEnseignant[key]) {
                        notesParEleveEnseignant[key] = {
                            eleve: eleve,
                            enseignant: enseignant,
                            classe: classe,
                            notesDS: [],
                            notesCC: [],
                            notesExam: [],
                            notesProjet: []
                        };
                    }
                    
                    switch(note.type) {
                        case "DS": notesParEleveEnseignant[key].notesDS.push(note); break;
                        case "CC": notesParEleveEnseignant[key].notesCC.push(note); break;
                        case "Examen": notesParEleveEnseignant[key].notesExam.push(note); break;
                        case "Projet": notesParEleveEnseignant[key].notesProjet.push(note); break;
                    }
                });
                
                // Calculer les moyennes et remplir le tableau
                Object.values(notesParEleveEnseignant).forEach(item => {
                    const moyenneDS = item.notesDS.length > 0 ? 
                        item.notesDS.reduce((sum, n) => sum + n.note, 0) / item.notesDS.length : null;
                    const moyenneCC = item.notesCC.length > 0 ? 
                        item.notesCC.reduce((sum, n) => sum + n.note, 0) / item.notesCC.length : null;
                    const moyenneExam = item.notesExam.length > 0 ? 
                        item.notesExam.reduce((sum, n) => sum + n.note, 0) / item.notesExam.length : null;
                    const moyenneProjet = item.notesProjet.length > 0 ? 
                        item.notesProjet.reduce((sum, n) => sum + n.note, 0) / item.notesProjet.length : null;
                    
                    // Calculer la moyenne générale pour cet enseignant
                    const toutesNotes = [...item.notesDS, ...item.notesCC, ...item.notesExam, ...item.notesProjet];
                    const moyenneGenerale = toutesNotes.length > 0 ? 
                        toutesNotes.reduce((sum, n) => sum + n.note, 0) / toutesNotes.length : null;
                    
                    data.push([
                        `${item.eleve.nom} ${item.eleve.prenom}`,
                        item.classe ? `${item.classe.nom} (${item.classe.niveau})` : "",
                        `${item.enseignant.nom} ${item.enseignant.prenom}`,
                        moyenneDS ? moyenneDS.toFixed(2) : "-",
                        moyenneCC ? moyenneCC.toFixed(2) : "-",
                        moyenneExam ? moyenneExam.toFixed(2) : "-",
                        moyenneProjet ? moyenneProjet.toFixed(2) : "-",
                        moyenneGenerale ? moyenneGenerale.toFixed(2) : "-"
                    ]);
                });
                
                // Ajouter le tableau au PDF
                doc.autoTable({
                    head: [headers],
                    body: data,
                    startY: 40,
                    styles: {
                        fontSize: 10,
                        cellPadding: 3,
                        overflow: 'linebreak'
                    },
                    headStyles: {
                        fillColor: [41, 128, 185],
                        textColor: 255,
                        fontStyle: 'bold'
                    },
                    alternateRowStyles: {
                        fillColor: [245, 245, 245]
                    },
                    columnStyles: {
                        0: {cellWidth: 30},
                        1: {cellWidth: 25},
                        2: {cellWidth: 30},
                        3: {cellWidth: 15},
                        4: {cellWidth: 15},
                        5: {cellWidth: 15},
                        6: {cellWidth: 15},
                        7: {cellWidth: 15}
                    }
                });
                
                // Enregistrer le PDF
                let nomFichier = "Rapport_Matiere";
                if (matiereId) {
                    const matiere = matieres.find(m => m.id == matiereId);
                    nomFichier += `_${matiere.nom.replace(/\s+/g, '_')}`;
                }
                if (classeId) {
                    const classe = classes.find(c => c.id == classeId);
                    nomFichier += `_${classe.nom.replace(/\s+/g, '_')}`;
                }
                nomFichier += ".pdf";
                
                doc.save(nomFichier);
                
            } catch (error) {
                console.error("Erreur lors de la génération du rapport:", error);
                alert("Erreur lors de la génération du rapport PDF");
            }
        }
        
        async function genererRapportEvaluations() {
            const typeEvaluation = document.getElementById("rapportTypeEvaluation").value;
            const periode = document.getElementById("rapportPeriode").value;
            
            try {
                const notes = await getAllItems('notes');
                const attributions = await getAllItems('attributions');
                const eleves = await getAllItems('eleves');
                const classes = await getAllItems('classes');
                const matieres = await getAllItems('matieres');
                const enseignants = await getAllItems('enseignants');
                
                // Filtrer les notes par type d'évaluation
                let notesFiltrees = [...notes];
                if (typeEvaluation) {
                    notesFiltrees = notesFiltrees.filter(n => n.type === typeEvaluation);
                }
                
                // Filtrer par période si spécifiée
                if (periode) {
                    const dateActuelle = new Date();
                    let dateDebut, dateFin;
                    
                    switch(periode) {
                        case "trimestre1":
                            dateDebut = new Date(dateActuelle.getFullYear(), 0, 1);
                            dateFin = new Date(dateActuelle.getFullYear(), 3, 31);
                            break;
                        case "trimestre2":
                            dateDebut = new Date(dateActuelle.getFullYear(), 4, 1);
                            dateFin = new Date(dateActuelle.getFullYear(), 7, 31);
                            break;
                        case "trimestre3":
                            dateDebut = new Date(dateActuelle.getFullYear(), 8, 1);
                            dateFin = new Date(dateActuelle.getFullYear(), 11, 31);
                            break;
                        case "semestre1":
                            dateDebut = new Date(dateActuelle.getFullYear(), 0, 1);
                            dateFin = new Date(dateActuelle.getFullYear(), 5, 30);
                            break;
                        case "semestre2":
                            dateDebut = new Date(dateActuelle.getFullYear(), 6, 1);
                            dateFin = new Date(dateActuelle.getFullYear(), 11, 31);
                            break;
                    }
                    
                    notesFiltrees = notesFiltrees.filter(n => {
                        const dateNote = new Date(n.date);
                        return dateNote >= dateDebut && dateNote <= dateFin;
                    });
                }
                
                // Créer un nouveau document PDF
                const doc = new jsPDF();
                
                // Titre du rapport
                let titre = "Rapport des évaluations";
                if (typeEvaluation) {
                    const typeText = {
                        "DS": "Devoirs Surveillés",
                        "CC": "Contrôles Continus",
                        "Examen": "Examens",
                        "Projet": "Projets"
                    }[typeEvaluation];
                    titre += ` - ${typeText}`;
                }
                if (periode) {
                    const periodeText = {
                        "trimestre1": "1er Trimestre",
                        "trimestre2": "2ème Trimestre",
                        "trimestre3": "3ème Trimestre",
                        "semestre1": "1er Semestre",
                        "semestre2": "2ème Semestre"
                    }[periode];
                    titre += ` - ${periodeText}`;
                }
                
                doc.setFontSize(16);
                doc.text(titre, 14, 20);
                doc.setFontSize(12);
                doc.text(`Généré le ${new Date().toLocaleDateString()}`, 14, 30);
                
                // Tableau des notes
                const headers = ["Élève", "Classe", "Matière", "Enseignant", "Note", "Date", "Coefficient"];
                const data = [];
                
                notesFiltrees.forEach(note => {
                    const attribution = attributions.find(a => a.id == note.id_enseignement);
                    const matiere = matieres.find(m => m.id == attribution.id_matiere);
                    const enseignant = enseignants.find(e => e.id == attribution.id_enseignant);
                    const eleve = eleves.find(e => e.id == note.id_eleve);
                    const classe = classes.find(c => c.id == eleve.id_classe);
                    
                    data.push([
                        `${eleve.nom} ${eleve.prenom}`,
                        classe ? `${classe.nom} (${classe.niveau})` : "",
                        matiere.nom,
                        `${enseignant.nom} ${enseignant.prenom}`,
                        note.note.toFixed(2),
                        note.date,
                        note.coefficient
                    ]);
                });
                
                // Ajouter le tableau au PDF
                doc.autoTable({
                    head: [headers],
                    body: data,
                    startY: 40,
                    styles: {
                        fontSize: 10,
                        cellPadding: 3,
                        overflow: 'linebreak'
                    },
                    headStyles: {
                        fillColor: [41, 128, 185],
                        textColor: 255,
                        fontStyle: 'bold'
                    },
                    alternateRowStyles: {
                        fillColor: [245, 245, 245]
                    },
                    columnStyles: {
                        0: {cellWidth: 30},
                        1: {cellWidth: 25},
                        2: {cellWidth: 25},
                        3: {cellWidth: 30},
                        4: {cellWidth: 15},
                        5: {cellWidth: 20},
                        6: {cellWidth: 15}
                    }
                });
                
                // Statistiques
                if (notesFiltrees.length > 0) {
                    const moyenneGenerale = notesFiltrees.reduce((sum, n) => sum + n.note, 0) / notesFiltrees.length;
                    const noteMax = Math.max(...notesFiltrees.map(n => n.note));
                    const noteMin = Math.min(...notesFiltrees.map(n => n.note));
                    
                    doc.setFontSize(12);
                    doc.text("Statistiques:", 14, doc.autoTable.previous.finalY + 20);
                    
                    doc.setFontSize(10);
                    doc.text(`Nombre d'évaluations: ${notesFiltrees.length}`, 14, doc.autoTable.previous.finalY + 30);
                    doc.text(`Moyenne générale: ${moyenneGenerale.toFixed(2)}/20`, 14, doc.autoTable.previous.finalY + 40);
                    doc.text(`Note maximale: ${noteMax.toFixed(2)}/20`, 14, doc.autoTable.previous.finalY + 50);
                    doc.text(`Note minimale: ${noteMin.toFixed(2)}/20`, 14, doc.autoTable.previous.finalY + 60);
                }
                
                // Enregistrer le PDF
                let nomFichier = "Rapport_Evaluations";
                if (typeEvaluation) {
                    nomFichier += `_${typeEvaluation}`;
                }
                if (periode) {
                    nomFichier += `_${periode}`;
                }
                nomFichier += ".pdf";
                
                doc.save(nomFichier);
                
            } catch (error) {
                console.error("Erreur lors de la génération du rapport:", error);
                alert("Erreur lors de la génération du rapport PDF");
            }
        }
        
        // Fonctions pour mettre à jour les tables
        async function updateAllTables() {
            await updateTableEnseignants();
            await updateTableMatieres();
            await updateTableClasses();
            await updateTableAttributions();
            await updateTableEleves();
            await updateTableNotes();
            await fillSelectOptions();
        }
        
        async function updateTableEnseignants() {
            try {
                const enseignants = await getAllItems('enseignants');
                const tbody = document.querySelector("#tableEnseignants tbody");
                tbody.innerHTML = '';
                
                enseignants.forEach(ens => {
                    tbody.innerHTML += `
                        <tr>
                            <td>${ens.id}</td>
                            <td>${ens.nom}</td>
                            <td>${ens.prenom}</td>
                            <td>${ens.email}</td>
                            <td>
                                <button onclick="editEnseignant(${ens.id})">Modifier</button>
                                <button onclick="deleteEnseignant(${ens.id})">Supprimer</button>
                            </td>
                        </tr>
                    `;
                });
            } catch (error) {
                console.error("Erreur lors de la mise à jour de la table enseignants:", error);
            }
        }
        
        async function updateTableMatieres() {
            try {
                const matieres = await getAllItems('matieres');
                const tbody = document.querySelector("#tableMatieres tbody");
                tbody.innerHTML = '';
                
                matieres.forEach(mat => {
                    tbody.innerHTML += `
                        <tr>
                            <td>${mat.id}</td>
                            <td>${mat.nom}</td>
                            <td>
                                <button onclick="editMatiere(${mat.id})">Modifier</button>
                                <button onclick="deleteMatiere(${mat.id})">Supprimer</button>
                            </td>
                        </tr>
                    `;
                });
            } catch (error) {
                console.error("Erreur lors de la mise à jour de la table matières:", error);
            }
        }
        
        async function updateTableClasses() {
            try {
                const classes = await getAllItems('classes');
                const tbody = document.querySelector("#tableClasses tbody");
                tbody.innerHTML = '';
                
                classes.forEach(cl => {
                    tbody.innerHTML += `
                        <tr>
                            <td>${cl.id}</td>
                            <td>${cl.nom}</td>
                            <td>${cl.niveau}</td>
                            <td>
                                <button onclick="editClasse(${cl.id})">Modifier</button>
                                <button onclick="deleteClasse(${cl.id})">Supprimer</button>
                            </td>
                        </tr>
                    `;
                });
            } catch (error) {
                console.error("Erreur lors de la mise à jour de la table classes:", error);
            }
        }
        
        async function updateTableAttributions() {
            try {
                const attributions = await getAllItems('attributions');
                const enseignants = await getAllItems('enseignants');
                const matieres = await getAllItems('matieres');
                const classes = await getAllItems('classes');
                
                const tbody = document.querySelector("#tableAttributions tbody");
                tbody.innerHTML = '';
                
                attributions.forEach(att => {
                    const enseignant = enseignants.find(e => e.id === att.id_enseignant);
                    const matiere = matieres.find(m => m.id === att.id_matiere);
                    const classe = classes.find(c => c.id === att.id_classe);
                    
                    tbody.innerHTML += `
                        <tr>
                            <td>${att.id}</td>
                            <td>${enseignant.nom} ${enseignant.prenom}</td>
                            <td>${matiere.nom}</td>
                            <td>${classe.nom}</td>
                            <td>${att.annee}</td>
                            <td>
                                <button onclick="editAttribution(${att.id})">Modifier</button>
                                <button onclick="deleteAttribution(${att.id})">Supprimer</button>
                            </td>
                        </tr>
                    `;
                });
            } catch (error) {
                console.error("Erreur lors de la mise à jour de la table attributions:", error);
            }
        }
        
        async function updateTableEleves() {
            try {
                const eleves = await getAllItems('eleves');
                const classes = await getAllItems('classes');
                
                const tbody = document.querySelector("#tableEleves tbody");
                tbody.innerHTML = '';
                
                eleves.forEach(el => {
                    const classe = classes.find(c => c.id === el.id_classe);
                    
                    tbody.innerHTML += `
                        <tr>
                            <td>${el.id}</td>
                            <td>${el.nom}</td>
                            <td>${el.prenom}</td>
                            <td>${el.age}</td>
                            <td>${el.sexe === 'M' ? 'Masculin' : 'Féminin'}</td>
                            <td>${classe.nom}</td>
                            <td>
                                <button onclick="editEleve(${el.id})">Modifier</button>
                                <button onclick="deleteEleve(${el.id})">Supprimer</button>
                            </td>
                        </tr>
                    `;
                });
            } catch (error) {
                console.error("Erreur lors de la mise à jour de la table élèves:", error);
            }
        }
        
        async function updateTableNotes() {
            try {
                const notes = await getAllItems('notes');
                const attributions = await getAllItems('attributions');
                const matieres = await getAllItems('matieres');
                const classes = await getAllItems('classes');
                const eleves = await getAllItems('eleves');
                
                const tbody = document.querySelector("#tableNotes tbody");
                tbody.innerHTML = '';
                
                notes.forEach(note => {
                    const enseignement = attributions.find(a => a.id === note.id_enseignement);
                    const matiere = matieres.find(m => m.id === enseignement.id_matiere);
                    const classe = classes.find(c => c.id === enseignement.id_classe);
                    const eleve = eleves.find(e => e.id === note.id_eleve);
                    
                    tbody.innerHTML += `
                        <tr>
                            <td>${note.id}</td>
                            <td>${eleve.nom} ${eleve.prenom}</td>
                            <td>${matiere.nom}</td>
                            <td>${classe.nom}</td>
                            <td>${note.note}/20</td>
                            <td>${note.type}</td>
                            <td>${note.date}</td>
                            <td>
                                <button onclick="editNote(${note.id})">Modifier</button>
                                <button onclick="deleteNote(${note.id})">Supprimer</button>
                            </td>
                        </tr>
                    `;
                });
            } catch (error) {
                console.error("Erreur lors de la mise à jour de la table notes:", error);
            }
        }
        
        // Gestion des formulaires
        document.getElementById("formEnseignant").addEventListener("submit", async function(e) {
            e.preventDefault();
            
            const id = document.getElementById("enseignantId").value;
            const nom = document.getElementById("enseignantNom").value;
            const prenom = document.getElementById("enseignantPrenom").value;
            const email = document.getElementById("enseignantEmail").value;
            
            try {
                if (id) {
                    const enseignant = await getItemById('enseignants', parseInt(id));
                    enseignant.nom = nom;
                    enseignant.prenom = prenom;
                    enseignant.email = email;
                    
                    await updateItem('enseignants', enseignant);
                } else {
                    const newEnseignant = {
                        nom,
                        prenom,
                        email
                    };
                    
                    await addItem('enseignants', newEnseignant);
                }
                
                await updateTableEnseignants();
                await fillSelectOptions();
                resetEnseignantForm();
            } catch (error) {
                console.error("Erreur lors de l'enregistrement de l'enseignant:", error);
                alert("Erreur lors de l'enregistrement de l'enseignant");
            }
        });
        
        async function editEnseignant(id) {
            try {
                const ens = await getItemById('enseignants', id);
                document.getElementById("enseignantId").value = ens.id;
                document.getElementById("enseignantNom").value = ens.nom;
                document.getElementById("enseignantPrenom").value = ens.prenom;
                document.getElementById("enseignantEmail").value = ens.email;
                
                document.querySelector('.tablinks.active').classList.remove('active');
                document.querySelector('.tabcontent[style*="display: block"]').style.display = 'none';
                
                document.querySelector('.tablinks:first-child').classList.add('active');
                document.getElementById("Enseignants").style.display = 'block';
            } catch (error) {
                console.error("Erreur lors de l'édition de l'enseignant:", error);
                alert("Erreur lors de l'édition de l'enseignant");
            }
        }
        
        async function deleteEnseignant(id) {
            if (confirm("Voulez-vous vraiment supprimer cet enseignant ?")) {
                try {
                    const attributions = await getAllItems('attributions');
                    const hasAttributions = attributions.some(a => a.id_enseignant === id);
                    
                    if (hasAttributions) {
                        alert("Impossible de supprimer cet enseignant car il a des attributions. Supprimez d'abord ses attributions.");
                        return;
                    }
                    
                    await deleteItem('enseignants', id);
                    await updateTableEnseignants();
                    await fillSelectOptions();
                } catch (error) {
                    console.error("Erreur lors de la suppression de l'enseignant:", error);
                    alert("Erreur lors de la suppression de l'enseignant");
                }
            }
        }
        
        function resetEnseignantForm() {
            document.getElementById("formEnseignant").reset();
            document.getElementById("enseignantId").value = '';
        }
        
        document.getElementById("formMatiere").addEventListener("submit", async function(e) {
            e.preventDefault();
            
            const id = document.getElementById("matiereId").value;
            const nom = document.getElementById("nomMatiere").value;
            
            try {
                if (id) {
                    const matiere = await getItemById('matieres', parseInt(id));
                    matiere.nom = nom;
                    
                    await updateItem('matieres', matiere);
                } else {
                    const newMatiere = {
                        nom
                    };
                    
                    await addItem('matieres', newMatiere);
                }
                
                await updateTableMatieres();
                await fillSelectOptions();
                resetMatiereForm();
            } catch (error) {
                console.error("Erreur lors de l'enregistrement de la matière:", error);
                alert("Erreur lors de l'enregistrement de la matière");
            }
        });
        
        async function editMatiere(id) {
            try {
                const mat = await getItemById('matieres', id);
                document.getElementById("matiereId").value = mat.id;
                document.getElementById("nomMatiere").value = mat.nom;
                
                document.querySelector('.tablinks.active').classList.remove('active');
                document.querySelector('.tabcontent[style*="display: block"]').style.display = 'none';
                
                document.querySelector('.tablinks:nth-child(2)').classList.add('active');
                document.getElementById("Matieres").style.display = 'block';
            } catch (error) {
                console.error("Erreur lors de l'édition de la matière:", error);
                alert("Erreur lors de l'édition de la matière");
            }
        }
        
        async function deleteMatiere(id) {
            if (confirm("Voulez-vous vraiment supprimer cette matière ?")) {
                try {
                    const attributions = await getAllItems('attributions');
                    const hasAttributions = attributions.some(a => a.id_matiere === id);
                    
                    if (hasAttributions) {
                        alert("Impossible de supprimer cette matière car elle a des attributions. Supprimez d'abord ses attributions.");
                        return;
                    }
                    
                    await deleteItem('matieres', id);
                    await updateTableMatieres();
                    await fillSelectOptions();
                } catch (error) {
                    console.error("Erreur lors de la suppression de la matière:", error);
                    alert("Erreur lors de la suppression de la matière");
                }
            }
        }
        
        function resetMatiereForm() {
            document.getElementById("formMatiere").reset();
            document.getElementById("matiereId").value = '';
        }
        
        document.getElementById("formClasse").addEventListener("submit", async function(e) {
            e.preventDefault();
            
            const id = document.getElementById("classeId").value;
            const nom = document.getElementById("nomClasse").value;
            const niveau = document.getElementById("niveauClasse").value;
            
            try {
                if (id) {
                    const classe = await getItemById('classes', parseInt(id));
                    classe.nom = nom;
                    classe.niveau = niveau;
                    
                    await updateItem('classes', classe);
                } else {
                    const newClasse = {
                        nom,
                        niveau
                    };
                    
                    await addItem('classes', newClasse);
                }
                
                await updateTableClasses();
                await fillSelectOptions();
                resetClasseForm();
            } catch (error) {
                console.error("Erreur lors de l'enregistrement de la classe:", error);
                alert("Erreur lors de l'enregistrement de la classe");
            }
        });
        
        async function editClasse(id) {
            try {
                const cl = await getItemById('classes', id);
                document.getElementById("classeId").value = cl.id;
                document.getElementById("nomClasse").value = cl.nom;
                document.getElementById("niveauClasse").value = cl.niveau;
                
                document.querySelector('.tablinks.active').classList.remove('active');
                document.querySelector('.tabcontent[style*="display: block"]').style.display = 'none';
                
                document.querySelector('.tablinks:nth-child(3)').classList.add('active');
                document.getElementById("Classes").style.display = 'block';
            } catch (error) {
                console.error("Erreur lors de l'édition de la classe:", error);
                alert("Erreur lors de l'édition de la classe");
            }
        }
        
        async function deleteClasse(id) {
            if (confirm("Voulez-vous vraiment supprimer cette classe ?")) {
                try {
                    const eleves = await getAllItems('eleves');
                    const attributions = await getAllItems('attributions');
                    
                    const hasEleves = eleves.some(e => e.id_classe === id);
                    const hasAttributions = attributions.some(a => a.id_classe === id);
                    
                    if (hasEleves || hasAttributions) {
                        alert("Impossible de supprimer cette classe car elle a des élèves ou des attributions. Supprimez d'abord les élèves et attributions liés.");
                        return;
                    }
                    
                    await deleteItem('classes', id);
                    await updateTableClasses();
                    await fillSelectOptions();
                } catch (error) {
                    console.error("Erreur lors de la suppression de la classe:", error);
                    alert("Erreur lors de la suppression de la classe");
                }
            }
        }
        
        function resetClasseForm() {
            document.getElementById("formClasse").reset();
            document.getElementById("classeId").value = '';
        }
        
        document.getElementById("formAttribution").addEventListener("submit", async function(e) {
            e.preventDefault();
            
            const id = document.getElementById("attributionId").value;
            const id_enseignant = document.getElementById("attributionEnseignant").value;
            const id_matiere = document.getElementById("attributionMatiere").value;
            const id_classe = document.getElementById("attributionClasse").value;
            const annee = document.getElementById("anneeScolaire").value;
            
            try {
                if (id) {
                    const attribution = await getItemById('attributions', parseInt(id));
                    attribution.id_enseignant = parseInt(id_enseignant);
                    attribution.id_matiere = parseInt(id_matiere);
                    attribution.id_classe = parseInt(id_classe);
                    attribution.annee = annee;
                    
                    await updateItem('attributions', attribution);
                } else {
                    const newAttribution = {
                        id_enseignant: parseInt(id_enseignant),
                        id_matiere: parseInt(id_matiere),
                        id_classe: parseInt(id_classe),
                        annee
                    };
                    
                    await addItem('attributions', newAttribution);
                }
                
                await updateTableAttributions();
                resetAttributionForm();
            } catch (error) {
                console.error("Erreur lors de l'enregistrement de l'attribution:", error);
                alert("Erreur lors de l'enregistrement de l'attribution");
            }
        });
        
        async function editAttribution(id) {
            try {
                const att = await getItemById('attributions', id);
                document.getElementById("attributionId").value = att.id;
                document.getElementById("attributionEnseignant").value = att.id_enseignant;
                document.getElementById("attributionMatiere").value = att.id_matiere;
                document.getElementById("attributionClasse").value = att.id_classe;
                document.getElementById("anneeScolaire").value = att.annee;
                
                document.querySelector('.tablinks.active').classList.remove('active');
                document.querySelector('.tabcontent[style*="display: block"]').style.display = 'none';
                
                document.querySelector('.tablinks:nth-child(4)').classList.add('active');
                document.getElementById("Attributions").style.display = 'block';
            } catch (error) {
                console.error("Erreur lors de l'édition de l'attribution:", error);
                alert("Erreur lors de l'édition de l'attribution");
            }
        }
        
        async function deleteAttribution(id) {
            if (confirm("Voulez-vous vraiment supprimer cette attribution ?")) {
                try {
                    const notes = await getAllItems('notes');
                    const hasNotes = notes.some(n => n.id_enseignement === id);
                    
                    if (hasNotes) {
                        alert("Impossible de supprimer cette attribution car elle a des notes associées. Supprimez d'abord les notes.");
                        return;
                    }
                    
                    await deleteItem('attributions', id);
                    await updateTableAttributions();
                } catch (error) {
                    console.error("Erreur lors de la suppression de l'attribution:", error);
                    alert("Erreur lors de la suppression de l'attribution");
                }
            }
        }
        
        function resetAttributionForm() {
            document.getElementById("formAttribution").reset();
            document.getElementById("attributionId").value = '';
        }
        
        document.getElementById("formEleve").addEventListener("submit", async function(e) {
            e.preventDefault();
            
            const id = document.getElementById("eleveId").value;
            const nom = document.getElementById("eleveNom").value;
            const prenom = document.getElementById("elevePrenom").value;
            const age = document.getElementById("eleveAge").value;
            const sexe = document.getElementById("eleveSexe").value;
            const id_classe = document.getElementById("eleveClasse").value;
            
            try {
                if (id) {
                    const eleve = await getItemById('eleves', parseInt(id));
                    eleve.nom = nom;
                    eleve.prenom = prenom;
                    eleve.age = parseInt(age);
                    eleve.sexe = sexe;
                    eleve.id_classe = parseInt(id_classe);
                    
                    await updateItem('eleves', eleve);
                } else {
                    const newEleve = {
                        nom,
                        prenom,
                        age: parseInt(age),
                        sexe,
                        id_classe: parseInt(id_classe)
                    };
                    
                    await addItem('eleves', newEleve);
                }
                
                await updateTableEleves();
                resetEleveForm();
            } catch (error) {
                console.error("Erreur lors de l'enregistrement de l'élève:", error);
                alert("Erreur lors de l'enregistrement de l'élève");
            }
        });
        
        async function editEleve(id) {
            try {
                const el = await getItemById('eleves', id);
                document.getElementById("eleveId").value = el.id;
                document.getElementById("eleveNom").value = el.nom;
                document.getElementById("elevePrenom").value = el.prenom;
                document.getElementById("eleveAge").value = el.age;
                document.getElementById("eleveSexe").value = el.sexe;
                document.getElementById("eleveClasse").value = el.id_classe;
                
                document.querySelector('.tablinks.active').classList.remove('active');
                document.querySelector('.tabcontent[style*="display: block"]').style.display = 'none';
                
                document.querySelector('.tablinks:nth-child(5)').classList.add('active');
                document.getElementById("Eleves").style.display = 'block';
            } catch (error) {
                console.error("Erreur lors de l'édition de l'élève:", error);
                alert("Erreur lors de l'édition de l'élève");
            }
        }
        
        async function deleteEleve(id) {
            if (confirm("Voulez-vous vraiment supprimer cet élève ?")) {
                try {
                    const notes = await getAllItems('notes');
                    const hasNotes = notes.some(n => n.id_eleve === id);
                    
                    if (hasNotes) {
                        alert("Impossible de supprimer cet élève car il a des notes. Supprimez d'abord ses notes.");
                        return;
                    }
                    
                    await deleteItem('eleves', id);
                    await updateTableEleves();
                } catch (error) {
                    console.error("Erreur lors de la suppression de l'élève:", error);
                    alert("Erreur lors de la suppression de l'élève");
                }
            }
        }
        
        function resetEleveForm() {
            document.getElementById("formEleve").reset();
            document.getElementById("eleveId").value = '';
        }
        
        document.getElementById("formNote").addEventListener("submit", async function(e) {
            e.preventDefault();
            
            const id = document.getElementById("noteId").value;
            const id_enseignement = document.getElementById("noteEnseignant").value;
            const id_matiere = document.getElementById("noteMatiere").value;
            const id_classe = document.getElementById("noteClasse").value;
            const id_eleve = document.getElementById("noteEleve").value;
            const note = document.getElementById("noteValeur").value;
            const type = document.getElementById("noteType").value;
            const date = document.getElementById("noteDate").value;
            const coefficient = document.getElementById("noteCoefficient").value;
            const commentaire = document.getElementById("noteCommentaire").value;
            
            try {
                if (id) {
                    const existingNote = await getItemById('notes', parseInt(id));
                    existingNote.id_enseignement = parseInt(id_enseignement);
                    existingNote.id_eleve = parseInt(id_eleve);
                    existingNote.note = parseFloat(note);
                    existingNote.type = type;
                    existingNote.date = date;
                    existingNote.coefficient = parseInt(coefficient);
                    existingNote.commentaire = commentaire;
                    
                    await updateItem('notes', existingNote);
                } else {
                    const newNote = {
                        id_enseignement: parseInt(id_enseignement),
                        id_eleve: parseInt(id_eleve),
                        note: parseFloat(note),
                        type,
                        date,
                        coefficient: parseInt(coefficient),
                        commentaire
                    };
                    
                    await addItem('notes', newNote);
                }
                
                await updateTableNotes();
                resetNoteForm();
            } catch (error) {
                console.error("Erreur lors de l'enregistrement de la note:", error);
                alert("Erreur lors de l'enregistrement de la note");
            }
        });
        
        async function editNote(id) {
            try {
                const note = await getItemById('notes', id);
                const attribution = await getItemById('attributions', note.id_enseignement);
                
                document.getElementById("noteId").value = note.id;
                document.getElementById("noteEnseignant").value = attribution.id_enseignant;
                await chargerMatieresClasses();
                document.getElementById("noteMatiere").value = attribution.id_matiere;
                document.getElementById("noteClasse").value = attribution.id_classe;
                await chargerEleves();
                document.getElementById("noteEleve").value = note.id_eleve;
                document.getElementById("noteValeur").value = note.note;
                document.getElementById("noteType").value = note.type;
                document.getElementById("noteDate").value = note.date;
                document.getElementById("noteCoefficient").value = note.coefficient;
                document.getElementById("noteCommentaire").value = note.commentaire || '';
                
                document.querySelector('.tablinks.active').classList.remove('active');
                document.querySelector('.tabcontent[style*="display: block"]').style.display = 'none';
                
                document.querySelector('.tablinks:nth-child(6)').classList.add('active');
                document.getElementById("Notes").style.display = 'block';
            } catch (error) {
                console.error("Erreur lors de l'édition de la note:", error);
                alert("Erreur lors de l'édition de la note");
            }
        }
        
        async function deleteNote(id) {
            if (confirm("Voulez-vous vraiment supprimer cette note ?")) {
                try {
                    await deleteItem('notes', id);
                    await updateTableNotes();
                } catch (error) {
                    console.error("Erreur lors de la suppression de la note:", error);
                    alert("Erreur lors de la suppression de la note");
                }
            }
        }
        
        function resetNoteForm() {
            document.getElementById("formNote").reset();
            document.getElementById("noteId").value = '';
            document.getElementById("noteDate").valueAsDate = new Date();
        }
        
        // Fonctions pour exporter/importer/supprimer la base de données
        async function exportDatabase() {
            try {
                const stores = ['enseignants', 'matieres', 'classes', 'attributions', 'eleves', 'notes'];
                const data = {};
                
                for (const store of stores) {
                    data[store] = await getAllItems(store);
                }
                
                const dataStr = JSON.stringify(data, null, 2);
                const blob = new Blob([dataStr], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                
                const a = document.createElement('a');
                a.href = url;
                a.download = 'gestion_notes_export.json';
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
                
                alert('Données exportées avec succès !');
            } catch (error) {
                console.error("Erreur lors de l'export des données:", error);
                alert("Erreur lors de l'export des données");
            }
        }
        
        async function importDatabase(input) {
            if (!input.files || input.files.length === 0) return;
            
            const file = input.files[0];
            const reader = new FileReader();
            
            reader.onload = async function(e) {
                try {
                    const data = JSON.parse(e.target.result);
                    const stores = ['enseignants', 'matieres', 'classes', 'attributions', 'eleves', 'notes'];
                    
                    // Vider les tables existantes
                    for (const store of stores) {
                        const items = await getAllItems(store);
                        for (const item of items) {
                            await deleteItem(store, item.id);
                        }
                    }
                    
                    // Importer les nouvelles données
                    for (const store of stores) {
                        if (data[store]) {
                            for (const item of data[store]) {
                                // Supprimer l'id existant pour éviter les conflits
                                const { id, ...itemWithoutId } = item;
                                await addItem(store, itemWithoutId);
                            }
                        }
                    }
                    
                    await updateAllTables();
                    alert('Données importées avec succès !');
                } catch (error) {
                    console.error("Erreur lors de l'import des données:", error);
                    alert("Erreur lors de l'import des données");
                }
            };
            
            reader.readAsText(file);
            input.value = ''; // Réinitialiser l'input pour permettre le même fichier
        }
        
        async function clearDatabase() {
            if (confirm("Voulez-vous vraiment supprimer TOUTES les données ? Cette action est irréversible.")) {
                try {
                    const stores = ['enseignants', 'matieres', 'classes', 'attributions', 'eleves', 'notes'];
                    
                    for (const store of stores) {
                        const items = await getAllItems(store);
                        for (const item of items) {
                            await deleteItem(store, item.id);
                        }
                    }
                    
                    // Réinitialiser avec les données par défaut
                    const request = indexedDB.open('GestionNotesDB', 3);
                    request.onupgradeneeded = function(event) {
                        addInitialData(event.target.transaction);
                    };
                    
                    await updateAllTables();
                    alert('Toutes les données ont été supprimées et la base a été réinitialisée.');
                } catch (error) {
                    console.error("Erreur lors de la suppression des données:", error);
                    alert("Erreur lors de la suppression des données");
                }
            }
        }
        
        // Initialisation de l'application
        window.onload = async function() {
            try {
                console.log("Début de l'initialisation de l'application");
                
                // Vérifier le support de IndexedDB
                if (!('indexedDB' in window)) {
                    throw new Error("IndexedDB n'est pas supporté par votre navigateur");
                }
                
                // Attendre que jsPDF soit chargé
                let jsPDFCheckCount = 0;
                while (typeof window.jspdf === 'undefined' && jsPDFCheckCount < 10) {
                    await new Promise(resolve => setTimeout(resolve, 100));
                    jsPDFCheckCount++;
                }
                
                if (typeof window.jspdf === 'undefined') {
                    throw new Error("La bibliothèque jsPDF n'a pas été chargée correctement");
                }
                
                // Initialiser la base de données
                await initDB();
                
                // Mettre à jour les tables
                await updateAllTables();
                await fillSelectOptions();
                
                // Initialiser la date de note
                const noteDateInput = document.getElementById("noteDate");
                if (noteDateInput) {
                    noteDateInput.valueAsDate = new Date();
                }
                
                console.log("Application initialisée avec succès");
            } catch (error) {
                console.error("Erreur lors de l'initialisation:", error);
                
                // Message d'erreur convivial
                let errorMessage = "Une erreur est survenue lors du chargement de l'application.\n";
                errorMessage += "Veuillez rafraîchir la page ou contacter le support.\n\n";
                errorMessage += `Détails: ${error.message}`;
                
                alert(errorMessage);
                
                // Tentative de récupération
                try {
                    if (error.message.includes("bloquée") || error.message.includes("connexion")) {
                        if (confirm("La base de données semble bloquée. Voulez-vous essayer de la réinitialiser ?")) {
                            await clearDatabase();
                            window.location.reload();
                        }
                    }
                } catch (recoveryError) {
                    console.error("Échec de la récupération:", recoveryError);
                }
            }
        };
    </script>
</body>
</html>
