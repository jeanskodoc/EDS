<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Système de Gestion Scolaire - République Togolaise</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- Ajout de jsPDF pour l'export PDF -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <style>
        :root {
            --primary-color: #006400; /* Vert togolais */
            --primary-dark: #004d00;
            --primary-light: #e8f5e9;
            --secondary-color: #FF0000; /* Rouge togolais */
            --tertiary-color: #FFD700; /* Jaune togolais */
            --accent-color: #17a2b8;
            --success-color: #28a745;
            --danger-color: #dc3545;
            --warning-color: #ffc107;
            --info-color: #17a2b8;
            --light-color: #f8f9fa;
            --dark-color: #343a40;
            --border-color: #dee2e6;
            --shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            --transition: all 0.3s ease;
            --border-radius: 8px;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', system-ui, -apple-system, sans-serif;
        }

        body {
            background: linear-gradient(135deg, #f5f7fa 0%, #e3e8f7 100%);
            color: var(--dark-color);
            line-height: 1.6;
            min-height: 100vh;
            padding: 15px;
            position: relative;
        }

        .container {
            max-width: 1800px;
            margin: 0 auto;
            background: white;
            border-radius: var(--border-radius);
            box-shadow: var(--shadow);
            overflow: hidden;
            position: relative;
            border: 1px solid var(--primary-color);
        }

        /* Header Styles */
        .header-main {
            background: linear-gradient(135deg, var(--primary-color), var(--primary-dark));
            color: white;
            padding: 1.5rem;
            position: relative;
            border-bottom: 3px solid var(--secondary-color);
        }

        .header-main::after {
            content: '';
            position: absolute;
            bottom: -3px;
            left: 0;
            width: 100%;
            height: 3px;
            background: linear-gradient(90deg, 
                var(--secondary-color) 0%, 
                var(--secondary-color) 33%, 
                var(--tertiary-color) 33%, 
                var(--tertiary-color) 66%, 
                var(--primary-color) 66%, 
                var(--primary-color) 100%);
        }

        .logo-section {
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 1rem;
        }

        .logo-wrapper {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .logo {
            width: 70px;
            height: 70px;
            background: linear-gradient(135deg, var(--secondary-color), var(--tertiary-color));
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            color: white;
            font-size: 1.5rem;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
            position: relative;
            overflow: hidden;
        }

        .logo::before {
            content: '★';
            position: absolute;
            color: white;
            font-size: 24px;
            text-shadow: 0 0 5px rgba(255, 255, 255, 0.5);
        }

        .school-info {
            text-align: center;
            flex: 1;
            min-width: 300px;
        }

        .school-info h1 {
            font-size: clamp(1.2rem, 3vw, 1.8rem);
            margin-bottom: 0.5rem;
            font-weight: 700;
            text-shadow: 1px 1px 2px rgba(0,0,0,0.3);
        }

        .school-info .subtitle {
            font-size: clamp(0.9rem, 2vw, 1.1rem);
            opacity: 0.9;
            color: var(--tertiary-color);
        }

        .togo-flag {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            margin-top: 10px;
            padding: 5px 15px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 20px;
            border: 1px solid rgba(255, 255, 255, 0.3);
        }

        .flag-stripe {
            width: 20px;
            height: 3px;
            border-radius: 2px;
        }

        .stripe-red { background-color: var(--secondary-color); }
        .stripe-yellow { background-color: var(--tertiary-color); }
        .stripe-green { background-color: var(--primary-color); }

        .user-actions {
            display: flex;
            gap: 10px;
        }

        .btn-retour {
            position: absolute;
            top: 15px;
            left: 15px;
            z-index: 100;
            padding: 8px 16px;
            background: var(--primary-color);
            color: white;
            border: 1px solid var(--secondary-color);
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            text-decoration: none;
            display: flex;
            align-items: center;
            gap: 5px;
            transition: var(--transition);
        }

        .btn-retour:hover {
            background: var(--primary-dark);
            transform: translateX(-3px);
        }

        /* Navigation Tabs */
        .tabs-container {
            background: white;
            border-bottom: 2px solid var(--border-color);
            overflow-x: auto;
            -webkit-overflow-scrolling: touch;
        }

        .tabs {
            display: flex;
            min-width: max-content;
        }

        .tab {
            padding: 1rem 1.5rem;
            border: none;
            background: none;
            cursor: pointer;
            font-weight: 600;
            color: var(--dark-color);
            border-bottom: 3px solid transparent;
            transition: var(--transition);
            white-space: nowrap;
            position: relative;
        }

        .tab:hover {
            color: var(--primary-color);
            background: var(--primary-light);
        }

        .tab.active {
            color: var(--primary-color);
            border-bottom-color: var(--secondary-color);
            background: var(--primary-light);
        }

        .tab-badge {
            position: absolute;
            top: 5px;
            right: 5px;
            background: var(--secondary-color);
            color: white;
            font-size: 0.7rem;
            padding: 2px 6px;
            border-radius: 10px;
            min-width: 18px;
            text-align: center;
        }

        /* Main Content */
        .main-content {
            padding: 2rem;
            min-height: 600px;
        }

        .tab-content {
            display: none;
            animation: fadeIn 0.5s ease;
        }

        .tab-content.active {
            display: block;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .form-section {
            background: white;
            border-radius: var(--border-radius);
            padding: 1.5rem;
            margin-bottom: 2rem;
            border: 1px solid var(--border-color);
            transition: var(--transition);
            position: relative;
        }

        .form-section:hover {
            box-shadow: 0 6px 15px rgba(0, 0, 0, 0.08);
            border-color: var(--primary-color);
        }

        .form-section h2 {
            color: var(--primary-color);
            margin-bottom: 1.5rem;
            padding-bottom: 0.5rem;
            border-bottom: 2px solid var(--secondary-color);
            font-size: 1.4rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .form-section h3 {
            color: var(--dark-color);
            margin: 1rem 0;
            font-size: 1.2rem;
            color: var(--primary-color);
        }

        /* Form Layout */
        .form-row {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 1.5rem;
            margin-bottom: 1.5rem;
        }

        .form-group {
            display: flex;
            flex-direction: column;
        }

        .form-group label {
            margin-bottom: 0.5rem;
            font-weight: 600;
            color: var(--dark-color);
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .form-group .required::after {
            content: '*';
            color: var(--secondary-color);
            margin-left: 4px;
        }

        .form-control {
            padding: 0.75rem 1rem;
            border: 2px solid var(--border-color);
            border-radius: var(--border-radius);
            font-size: 1rem;
            transition: var(--transition);
            background: white;
        }

        .form-control:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(0, 100, 0, 0.1);
        }

        .form-control:disabled {
            background: #f8f9fa;
            cursor: not-allowed;
        }

        .input-with-icon {
            position: relative;
        }

        .input-with-icon i {
            position: absolute;
            left: 1rem;
            top: 50%;
            transform: translateY(-50%);
            color: var(--primary-color);
        }

        .input-with-icon input {
            padding-left: 3rem;
        }

        /* Tables */
        .table-container {
            overflow-x: auto;
            margin: 1rem 0;
            border-radius: var(--border-radius);
            border: 1px solid var(--border-color);
            position: relative;
        }

        .data-table {
            width: 100%;
            border-collapse: collapse;
            min-width: 600px;
        }

        .data-table th {
            background: linear-gradient(135deg, var(--primary-color), var(--primary-dark));
            color: white;
            font-weight: 600;
            text-align: left;
            padding: 1rem;
            position: sticky;
            top: 0;
            border-right: 1px solid rgba(255,255,255,0.1);
        }

        .data-table th:last-child {
            border-right: none;
        }

        .data-table td {
            padding: 1rem;
            border-bottom: 1px solid var(--border-color);
            border-right: 1px solid var(--border-color);
        }

        .data-table td:last-child {
            border-right: none;
        }

        .data-table tbody tr:hover {
            background: var(--primary-light);
        }

        .data-table tbody tr:nth-child(even) {
            background: #f8f9fa;
        }

        .data-table tbody tr:nth-child(even):hover {
            background: var(--primary-light);
        }

        /* Buttons */
        .btn {
            padding: 0.75rem 1.5rem;
            border: none;
            border-radius: var(--border-radius);
            font-weight: 600;
            cursor: pointer;
            transition: var(--transition);
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
            font-size: 1rem;
            min-height: 44px;
            position: relative;
            overflow: hidden;
        }

        .btn::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 0;
            height: 0;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.2);
            transform: translate(-50%, -50%);
            transition: width 0.6s, height 0.6s;
        }

        .btn:hover::before {
            width: 300px;
            height: 300px;
        }

        .btn-primary {
            background: linear-gradient(135deg, var(--primary-color), var(--primary-dark));
            color: white;
            border: 1px solid var(--secondary-color);
        }

        .btn-primary:hover {
            background: linear-gradient(135deg, var(--primary-dark), var(--primary-color));
            transform: translateY(-2px);
            box-shadow: 0 6px 12px rgba(0, 100, 0, 0.2);
        }

        .btn-success {
            background: linear-gradient(135deg, #28a745, #218838);
            color: white;
        }

        .btn-success:hover {
            background: linear-gradient(135deg, #218838, #28a745);
            transform: translateY(-2px);
        }

        .btn-danger {
            background: linear-gradient(135deg, #dc3545, #c82333);
            color: white;
        }

        .btn-danger:hover {
            background: linear-gradient(135deg, #c82333, #dc3545);
            transform: translateY(-2px);
        }

        .btn-warning {
            background: linear-gradient(135deg, #ffc107, #e0a800);
            color: var(--dark-color);
        }

        .btn-warning:hover {
            background: linear-gradient(135deg, #e0a800, #ffc107);
            transform: translateY(-2px);
        }

        .btn-info {
            background: linear-gradient(135deg, #17a2b8, #138496);
            color: white;
        }

        .btn-info:hover {
            background: linear-gradient(135deg, #138496, #17a2b8);
            transform: translateY(-2px);
        }

        .btn-secondary {
            background: linear-gradient(135deg, #6c757d, #5a6268);
            color: white;
        }

        .btn-secondary:hover {
            background: linear-gradient(135deg, #5a6268, #6c757d);
            transform: translateY(-2px);
        }

        .btn-sm {
            padding: 0.5rem 1rem;
            font-size: 0.875rem;
        }

        .btn-lg {
            padding: 1rem 2rem;
            font-size: 1.125rem;
        }

        .btn-block {
            width: 100%;
        }

        /* Student List */
        .student-list {
            max-height: 400px;
            overflow-y: auto;
            border: 1px solid var(--border-color);
            border-radius: var(--border-radius);
            margin: 1rem 0;
            scrollbar-width: thin;
            scrollbar-color: var(--primary-color) #f1f1f1;
        }

        .student-list::-webkit-scrollbar {
            width: 8px;
        }

        .student-list::-webkit-scrollbar-track {
            background: #f1f1f1;
        }

        .student-list::-webkit-scrollbar-thumb {
            background: var(--primary-color);
            border-radius: 4px;
        }

        .student-item {
            display: grid;
            grid-template-columns: 2fr 1fr 1fr auto;
            gap: 1rem;
            padding: 1rem;
            border-bottom: 1px solid var(--border-color);
            align-items: center;
        }

        .student-item:last-child {
            border-bottom: none;
        }

        .student-item:hover {
            background: var(--primary-light);
        }

        .student-info {
            display: flex;
            flex-direction: column;
            gap: 0.25rem;
        }

        .student-name {
            font-weight: 600;
            color: var(--primary-color);
        }

        .student-details {
            font-size: 0.875rem;
            color: #6c757d;
            display: flex;
            gap: 1rem;
        }

        .student-actions {
            display: flex;
            gap: 0.5rem;
            flex-wrap: wrap;
        }

        /* Stats Cards */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1.5rem;
            margin: 1.5rem 0;
        }

        .stat-card {
            background: linear-gradient(135deg, white, #f8f9fa);
            border-radius: var(--border-radius);
            padding: 1.5rem;
            border: 1px solid var(--border-color);
            transition: var(--transition);
            text-align: center;
            position: relative;
            overflow: hidden;
        }

        .stat-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 4px;
            background: linear-gradient(90deg, var(--secondary-color), var(--tertiary-color), var(--primary-color));
        }

        .stat-card:hover {
            transform: translateY(-5px);
            box-shadow: var(--shadow);
        }

        .stat-value {
            font-size: 2.5rem;
            font-weight: 700;
            color: var(--primary-color);
            margin-bottom: 0.5rem;
            text-shadow: 1px 1px 2px rgba(0,0,0,0.1);
        }

        .stat-label {
            color: #6c757d;
            font-size: 0.875rem;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        /* Notes Input */
        .notes-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
            gap: 1.5rem;
        }

        .note-card {
            background: white;
            border: 1px solid var(--border-color);
            border-radius: var(--border-radius);
            padding: 1.5rem;
            transition: var(--transition);
        }

        .note-card:hover {
            border-color: var(--primary-color);
        }

        .note-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
            padding-bottom: 0.5rem;
            border-bottom: 1px solid var(--border-color);
        }

        .note-input-group {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 1rem;
            margin-bottom: 1rem;
        }

        .note-input-group label {
            grid-column: 1 / -1;
        }

        .note-input {
            text-align: center;
            font-weight: 600;
            font-size: 1.2rem;
        }

        .note-average {
            text-align: center;
            padding: 0.5rem;
            background: var(--primary-light);
            border-radius: var(--border-radius);
            font-weight: 600;
            color: var(--primary-color);
            border: 1px solid var(--primary-color);
        }

        /* Bulletin Preview */
        .bulletin-preview-container {
            background: white;
            border-radius: var(--border-radius);
            padding: 2rem;
            border: 1px solid var(--border-color);
            min-height: 500px;
            position: relative;
        }

        .bulletin-actions {
            position: absolute;
            top: 1rem;
            right: 1rem;
            display: flex;
            gap: 0.5rem;
            z-index: 10;
        }

        .bulletin-options {
            background: var(--light-color);
            padding: 1rem;
            border-radius: var(--border-radius);
            margin-bottom: 1rem;
            border: 1px solid var(--border-color);
        }

        .bulletin-options label {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            cursor: pointer;
            margin-bottom: 0.5rem;
        }

        /* Modal */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            align-items: center;
            justify-content: center;
            padding: 1rem;
        }

        .modal.show {
            display: flex;
        }

        .modal-content {
            background: white;
            border-radius: var(--border-radius);
            width: 100%;
            max-width: 800px;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            animation: modalSlideIn 0.3s ease;
            border: 2px solid var(--secondary-color);
        }

        @keyframes modalSlideIn {
            from {
                opacity: 0;
                transform: translateY(-50px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .modal-header {
            padding: 1.5rem;
            border-bottom: 1px solid var(--border-color);
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: linear-gradient(135deg, var(--primary-color), var(--primary-dark));
            color: white;
        }

        .modal-body {
            padding: 1.5rem;
        }

        .modal-footer {
            padding: 1.5rem;
            border-top: 1px solid var(--border-color);
            display: flex;
            justify-content: flex-end;
            gap: 1rem;
        }

        /* Filter Bar */
        .filter-bar {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
            padding: 1rem;
            background: var(--light-color);
            border-radius: var(--border-radius);
            margin-bottom: 1.5rem;
            border: 1px solid var(--border-color);
        }

        /* Alert Messages */
        .alert {
            padding: 1rem;
            border-radius: var(--border-radius);
            margin-bottom: 1rem;
            display: flex;
            align-items: center;
            gap: 1rem;
            border-left: 4px solid;
        }

        .alert-success {
            background: #d4edda;
            color: #155724;
            border-color: var(--success-color);
        }

        .alert-danger {
            background: #f8d7da;
            color: #721c24;
            border-color: var(--secondary-color);
        }

        .alert-warning {
            background: #fff3cd;
            color: #856404;
            border-color: var(--tertiary-color);
        }

        .alert-info {
            background: #d1ecf1;
            color: #0c5460;
            border-color: var(--info-color);
        }

        /* Loading States */
        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid var(--border-color);
            border-top-color: var(--primary-color);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            to {
                transform: rotate(360deg);
            }
        }

        /* Bulletin Specific Styles - OPTIMISÉ POUR IMPRESSION */
        .bulletin-togo {
            position: relative;
            border: 2px solid var(--primary-color);
            background: white;
            padding: 20px;
            min-height: 29.7cm; /* A4 height */
            width: 21cm; /* A4 width */
            margin: 0 auto;
            box-sizing: border-box;
            page-break-inside: avoid;
            page-break-after: always;
        }

        .bulletin-togo.with-watermark {
            background-image: 
                url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100" width="300" height="300" opacity="0.03"><path d="M50,10 C30,10 10,30 10,50 C10,70 30,90 50,90 C70,90 90,70 90,50 C90,30 70,10 50,10 Z M50,30 C63,30 70,43 70,50 C70,57 63,70 50,70 C37,70 30,57 30,50 C30,43 37,30 50,30 Z" fill="%23006400"/></svg>'),
                linear-gradient(to bottom, rgba(255,255,255,0.95), rgba(255,255,255,0.98));
            background-repeat: no-repeat;
            background-position: center;
            background-size: 300px;
        }

        .bulletin-header {
            text-align: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid var(--secondary-color);
            position: relative;
        }

        .bulletin-header::before,
        .bulletin-header::after {
            content: '✦';
            position: absolute;
            top: 50%;
            color: var(--tertiary-color);
            font-size: 20px;
        }

        .bulletin-header::before {
            left: 15%;
        }

        .bulletin-header::after {
            right: 15%;
        }

        .republic-togo {
            font-size: 16px;
            font-weight: bold;
            color: var(--primary-color);
            margin-bottom: 5px;
            text-transform: uppercase;
        }

        .ministry-togo {
            font-size: 12px;
            color: var(--dark-color);
            margin-bottom: 8px;
        }

        .title-togo {
            font-size: 20px;
            font-weight: bold;
            color: var(--secondary-color);
            margin: 10px 0;
            text-transform: uppercase;
        }

        .motto-togo {
            font-style: italic;
            color: var(--primary-color);
            font-size: 11px;
            margin-bottom: 8px;
        }

        .school-info-bulletin {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin: 15px 0;
            padding: 12px;
            background: var(--primary-light);
            border-radius: var(--border-radius);
            border-left: 4px solid var(--secondary-color);
            font-size: 12px;
        }

        .student-info-bulletin {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 12px;
            margin: 15px 0;
            padding: 12px;
            background: #f8f9fa;
            border-radius: var(--border-radius);
            border: 1px solid var(--border-color);
            font-size: 11px;
        }

        .grades-table {
            width: 100%;
            border-collapse: collapse;
            margin: 15px 0;
            border: 1px solid var(--border-color);
            font-size: 11px;
        }

        .grades-table th {
            background: linear-gradient(135deg, var(--primary-color), var(--primary-dark));
            color: white;
            padding: 8px;
            text-align: left;
            border-right: 1px solid rgba(255,255,255,0.1);
            font-weight: 600;
            font-size: 11px;
        }

        .grades-table td {
            padding: 8px;
            border-bottom: 1px solid var(--border-color);
            border-right: 1px solid var(--border-color);
            font-size: 11px;
        }

        .grades-table tr:nth-child(even) {
            background: #f8f9fa;
        }

        .grades-table tr:hover {
            background: var(--primary-light);
        }

        .summary-section {
            background: linear-gradient(135deg, var(--primary-light), white);
            padding: 15px;
            margin: 15px 0;
            border-radius: var(--border-radius);
            border: 1px solid var(--primary-color);
            font-size: 12px;
        }

        .signatures-section {
            display: flex;
            justify-content: space-between;
            margin-top: 40px;
            padding-top: 15px;
            border-top: 1px solid var(--border-color);
            font-size: 12px;
        }

        .signature-box {
            text-align: center;
            width: 45%;
        }

        .signature-line {
            border-top: 1px solid var(--dark-color);
            margin-top: 50px;
            padding-top: 5px;
        }

        .footer-bulletin {
            text-align: center;
            margin-top: 20px;
            font-size: 9px;
            color: #666;
            border-top: 1px solid var(--border-color);
            padding-top: 8px;
        }

        .watermark {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%) rotate(-45deg);
            font-size: 80px;
            color: rgba(0, 100, 0, 0.08);
            z-index: 0;
            pointer-events: none;
            white-space: nowrap;
            font-weight: bold;
            text-shadow: 1px 1px 3px rgba(0,0,0,0.1);
        }

        /* Category colors for subjects */
        .category-scientific {
            background: #e3f2fd !important;
        }
        
        .category-literary {
            background: #f3e5f5 !important;
        }
        
        .category-other {
            background: #f1f8e9 !important;
        }
        
        .category-header {
            font-weight: bold;
            font-size: 14px;
            padding: 12px;
            border-left: 4px solid;
            margin: 10px 0 5px 0;
        }
        
        .category-scientific-header {
            background: #bbdefb;
            border-color: #1976d2;
        }
        
        .category-literary-header {
            background: #e1bee7;
            border-color: #7b1fa2;
        }
        
        .category-other-header {
            background: #dcedc8;
            border-color: #689f38;
        }
        
        .success-rate {
            display: inline-block;
            padding: 2px 8px;
            border-radius: 10px;
            font-size: 11px;
            font-weight: bold;
            margin-left: 8px;
        }
        
        .success-rate-high {
            background: #c8e6c9;
            color: #1b5e20;
        }
        
        .success-rate-medium {
            background: #fff9c4;
            color: #f57f17;
        }
        
        .success-rate-low {
            background: #ffcdd2;
            color: #b71c1c;
        }

        /* Styles pour impression multiple */
        .bulletin-multiple-container {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: white;
            z-index: 10000;
            overflow-y: auto;
            padding: 20px;
        }

        .bulletin-multiple-container .bulletin-togo {
            margin: 20px auto;
            box-shadow: 0 0 10px rgba(0,0,0,0.1);
        }

        /* Responsive Design */
        @media (max-width: 1200px) {
            .form-row {
                grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            }
            
            .notes-grid {
                grid-template-columns: 1fr;
            }
            
            .student-info-bulletin {
                grid-template-columns: 1fr 1fr;
            }
        }

        @media (max-width: 768px) {
            body {
                padding: 10px;
            }
            
            .main-content {
                padding: 1rem;
            }
            
            .form-section {
                padding: 1rem;
            }
            
            .form-row {
                grid-template-columns: 1fr;
            }
            
            .student-item {
                grid-template-columns: 1fr;
                gap: 0.5rem;
            }
            
            .student-actions {
                justify-content: center;
            }
            
            .tab {
                padding: 0.75rem 1rem;
                font-size: 0.875rem;
            }
            
            .btn {
                padding: 0.5rem 1rem;
                font-size: 0.875rem;
            }
            
            .stats-grid {
                grid-template-columns: repeat(2, 1fr);
            }
            
            .modal-content {
                margin: 1rem;
            }
            
            .school-info-bulletin,
            .student-info-bulletin {
                grid-template-columns: 1fr;
            }
            
            .signatures-section {
                flex-direction: column;
                gap: 30px;
            }
            
            .signature-box {
                width: 100%;
            }
            
            .bulletin-togo {
                padding: 15px;
                width: 100%;
                min-height: auto;
            }
            
            .bulletin-preview-container {
                overflow-x: auto;
            }
        }

        @media (max-width: 480px) {
            .header-main {
                padding: 1rem;
            }
            
            .logo-section {
                flex-direction: column;
                text-align: center;
            }
            
            .logo-wrapper {
                flex-direction: column;
            }
            
            .tabs {
                flex-direction: column;
            }
            
            .tab {
                width: 100%;
                text-align: left;
                padding: 1rem;
            }
            
            .stats-grid {
                grid-template-columns: 1fr;
            }
            
            .filter-bar {
                grid-template-columns: 1fr;
            }
            
            .bulletin-togo {
                padding: 10px;
            }
            
            .watermark {
                font-size: 40px;
            }
        }

        /* Styles d'impression AMÉLIORÉS */
        @media print {
            body {
                background: white !important;
                padding: 0 !important;
                margin: 0 !important;
            }
            
            .container {
                box-shadow: none !important;
                border: none !important;
                border-radius: 0 !important;
                width: 100% !important;
                max-width: 100% !important;
                margin: 0 !important;
            }
            
            .header-main,
            .tabs-container,
            .btn-retour,
            .bulletin-actions,
            .bulletin-options,
            .user-actions,
            footer,
            .no-print {
                display: none !important;
            }
            
            .main-content {
                padding: 0 !important;
                margin: 0 !important;
            }
            
            .bulletin-preview-container {
                border: none !important;
                padding: 0 !important;
                box-shadow: none !important;
                min-height: auto !important;
            }
            
            .bulletin-togo {
                border: 1px solid #000 !important;
                margin: 0 auto !important;
                page-break-inside: avoid !important;
                page-break-after: always !important;
                position: relative !important;
                box-shadow: none !important;
                width: 21cm !important;
                height: 29.7cm !important;
                padding: 15mm !important;
            }
            
            .bulletin-togo:last-child {
                page-break-after: auto !important;
            }
            
            .watermark {
                opacity: 0.1 !important;
                font-size: 60px !important;
            }
            
            /* Optimisation du contenu pour impression */
            .grades-table th,
            .grades-table td {
                padding: 4px 6px !important;
                font-size: 10px !important;
            }
            
            .student-info-bulletin,
            .school-info-bulletin {
                padding: 8px !important;
                font-size: 10px !important;
            }
            
            .title-togo {
                font-size: 18px !important;
            }
            
            /* Suppression des effets interactifs */
            .bulletin-togo:hover,
            .grades-table tr:hover,
            .student-info-bulletin:hover {
                background: transparent !important;
            }
            
            /* Couleurs d'impression optimisées */
            * {
                color: black !important;
                background-color: transparent !important;
                background: white !important;
            }
            
            .category-scientific {
                background: #f0f8ff !important;
            }
            
            .category-literary {
                background: #f8f0ff !important;
            }
            
            .category-other {
                background: #f8fff0 !important;
            }
            
            /* Contraste amélioré pour impression noir/blanc */
            .success-rate-high {
                background: #e0e0e0 !important;
                color: black !important;
                border: 1px solid #666 !important;
            }
            
            .success-rate-medium {
                background: #f0f0f0 !important;
                color: black !important;
                border: 1px solid #666 !important;
            }
            
            .success-rate-low {
                background: #f8f8f8 !important;
                color: black !important;
                border: 1px solid #666 !important;
            }
            
            .text-primary,
            .text-secondary,
            .text-tertiary {
                color: black !important;
            }
        }

        /* Utility Classes */
        .d-none {
            display: none !important;
        }

        .d-flex {
            display: flex !important;
        }

        .justify-between {
            justify-content: space-between;
        }

        .align-center {
            align-items: center;
        }

        .gap-1 {
            gap: 0.5rem;
        }

        .gap-2 {
            gap: 1rem;
        }

        .gap-3 {
            gap: 1.5rem;
        }

        .mt-1 { margin-top: 0.5rem; }
        .mt-2 { margin-top: 1rem; }
        .mt-3 { margin-top: 1.5rem; }
        .mb-1 { margin-bottom: 0.5rem; }
        .mb-2 { margin-bottom: 1rem; }
        .mb-3 { margin-bottom: 1.5rem; }
        .p-1 { padding: 0.5rem; }
        .p-2 { padding: 1rem; }
        .p-3 { padding: 1.5rem; }

        .text-center { text-align: center; }
        .text-right { text-align: right; }
        .text-primary { color: var(--primary-color); }
        .text-secondary { color: var(--secondary-color); }
        .text-tertiary { color: var(--tertiary-color); }
        .text-success { color: var(--success-color); }
        .text-danger { color: var(--danger-color); }
        .text-warning { color: var(--warning-color); }

        .bg-light { background: var(--light-color); }
        .bg-primary { background: var(--primary-color); }
        .bg-secondary { background: var(--secondary-color); }
        .bg-success { background: var(--success-color); }

        /* Tooltip */
        .tooltip {
            position: relative;
            display: inline-block;
        }

        .tooltip .tooltip-text {
            visibility: hidden;
            width: 200px;
            background: var(--dark-color);
            color: white;
            text-align: center;
            border-radius: var(--border-radius);
            padding: 0.5rem;
            position: absolute;
            z-index: 1;
            bottom: 125%;
            left: 50%;
            transform: translateX(-50%);
            opacity: 0;
            transition: opacity 0.3s;
            font-size: 0.875rem;
            font-weight: normal;
        }

        .tooltip:hover .tooltip-text {
            visibility: visible;
            opacity: 1;
        }

        /* Badge */
        .badge {
            display: inline-block;
            padding: 0.25rem 0.5rem;
            font-size: 0.75rem;
            font-weight: 600;
            border-radius: 20px;
            color: white;
        }

        .badge-primary { background: var(--primary-color); }
        .badge-secondary { background: var(--secondary-color); }
        .badge-tertiary { background: var(--tertiary-color); }
        .badge-success { background: var(--success-color); }
        .badge-danger { background: var(--danger-color); }
        .badge-warning { background: var(--warning-color); }
        .badge-info { background: var(--info-color); }

        /* Progress Bar */
        .progress {
            height: 10px;
            background: #e9ecef;
            border-radius: 5px;
            overflow: hidden;
            margin: 10px 0;
        }

        .progress-bar {
            height: 100%;
            background: linear-gradient(90deg, var(--secondary-color), var(--tertiary-color), var(--primary-color));
            transition: width 0.6s ease;
        }
    </style>
</head>
<body>
    <div class="container">
        <a href="#" class="btn-retour no-print" onclick="history.back()">
            <i class="fas fa-arrow-left"></i> Retour
        </a>

        <!-- Header -->
        <header class="header-main">
            <div class="logo-section">
                <div class="logo-wrapper">
                    <div class="logo" title="République Togolaise">TG</div>
                    <div class="school-info">
                        <h1>SYSTÈME DE GESTION SCOLAIRE</h1>
                        <div class="subtitle">MINISTÈRE DES ENSEIGNEMENTS PRIMAIRE, SECONDAIRE ET TECHNIQUE</div>
                        <div class="togo-flag mt-2">
                            <div class="flag-stripe stripe-red"></div>
                            <div class="flag-stripe stripe-yellow"></div>
                            <div class="flag-stripe stripe-green"></div>
                            <span>République Togolaise</span>
                        </div>
                    </div>
                    <div class="logo" title="École Digitale du Siècle">EDS</div>
                </div>
                <div class="user-actions">
                    <button class="btn btn-secondary btn-sm" onclick="toggleDarkMode()">
                        <i class="fas fa-moon"></i> Mode
                    </button>
                    <button class="btn btn-info btn-sm" onclick="showHelp()">
                        <i class="fas fa-question-circle"></i> Aide
                    </button>
                </div>
            </div>
        </header>

        <!-- Navigation Tabs -->
        <nav class="tabs-container no-print">
            <div class="tabs">
                <button class="tab active" onclick="switchTab(0)">
                    <i class="fas fa-users"></i> Gestion Classe
                    <span class="tab-badge" id="studentCount">0</span>
                </button>
                <button class="tab" onclick="switchTab(1)">
                    <i class="fas fa-book"></i> Programmes
                    <span class="tab-badge" id="subjectCount">0</span>
                </button>
                <button class="tab" onclick="switchTab(2)">
                    <i class="fas fa-edit"></i> Saisie Notes
                </button>
                <button class="tab" onclick="switchTab(3)">
                    <i class="fas fa-chart-line"></i> Statistiques
                </button>
                <button class="tab" onclick="switchTab(4)">
                    <i class="fas fa-file-alt"></i> Bulletin
                </button>
                <button class="tab" onclick="switchTab(5)">
                    <i class="fas fa-database"></i> Archives
                </button>
                <button class="tab" onclick="switchTab(6)">
                    <i class="fas fa-cog"></i> Configuration
                </button>
            </div>
        </nav>

        <!-- Main Content -->
        <main class="main-content">
            <!-- Tab 1: Class Management -->
            <div class="tab-content active" id="tab0">
                <div class="form-section">
                    <h2><i class="fas fa-info-circle"></i> Informations Générales</h2>
                    <div class="form-row">
                        <div class="form-group">
                            <label class="required">Année Scolaire</label>
                            <div class="input-with-icon">
                                <i class="fas fa-calendar-alt"></i>
                                <input type="text" id="schoolYear" class="form-control" placeholder="2024-2025" required>
                            </div>
                        </div>
                        <div class="form-group">
                            <label class="required">Période</label>
                            <select id="period" class="form-control" required>
                                <option value="">Sélectionner</option>
                                <option value="1">1er Trimestre</option>
                                <option value="2">2ème Trimestre</option>
                                <option value="3">3ème Trimestre</option>
                                <option value="4">1er Semestre</option>
                                <option value="5">2ème Semestre</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label class="required">Date d'Édition</label>
                            <input type="date" id="editionDate" class="form-control" required>
                        </div>
                    </div>
                </div>

                <div class="form-section">
                    <h2><i class="fas fa-school"></i> Information de l'Établissement</h2>
                    <div class="form-row">
                        <div class="form-group">
                            <label class="required">Nom de l'Établissement</label>
                            <input type="text" id="schoolName" class="form-control" placeholder="CEG MASSEDENA" required>
                        </div>
                        <div class="form-group">
                            <label>Code Établissement</label>
                            <input type="text" id="schoolCode" class="form-control" placeholder="000123">
                        </div>
                        <div class="form-group">
                            <label>Statut</label>
                            <select id="schoolStatus" class="form-control">
                                <option value="Public">Public</option>
                                <option value="Privé">Privé</option>
                            </select>
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label>Direction Régionale</label>
                            <input type="text" id="regionalDirection" class="form-control" value="DRE-KARA">
                        </div>
                        <div class="form-group">
                            <label>Inspection</label>
                            <input type="text" id="inspection" class="form-control" value="IESG-Niamtougou">
                        </div>
                        <div class="form-group">
                            <label>Ville</label>
                            <input type="text" id="city" class="form-control" value="KARA">
                        </div>
                    </div>
                </div>

                <div class="form-section">
                    <h2><i class="fas fa-graduation-cap"></i> Gestion de la Classe</h2>
                    <div class="form-row">
                        <div class="form-group">
                            <label class="required">Niveau</label>
                            <select id="level" class="form-control" required onchange="updateSubjects()">
                                <option value="">Sélectionner</option>
                                <option value="college">Collège</option>
                                <option value="lycee">Lycée</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label class="required">Classe</label>
                            <select id="class" class="form-control" required onchange="updateSubjects()">
                                <option value="">Sélectionner</option>
                                <option value="6e">6ème</option>
                                <option value="5e">5ème</option>
                                <option value="4e">4ème</option>
                                <option value="3e">3ème</option>
                                <option value="2nd">Seconde</option>
                                <option value="1ere">Première</option>
                                <option value="tle">Terminale</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Série (Lycée)</label>
                            <select id="series" class="form-control" onchange="updateSubjects()">
                                <option value="">Sélectionner</option>
                                <option value="A">Série A</option>
                                <option value="C">Série C</option>
                                <option value="D">Série D</option>
                                <option value="E">Série E</option>
                            </select>
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label>Effectif de la Classe</label>
                            <input type="number" id="classSize" class="form-control" min="1" value="0" readonly>
                        </div>
                        <div class="form-group">
                            <label>Filles</label>
                            <input type="number" id="girlsCount" class="form-control" min="0" value="0" readonly>
                        </div>
                        <div class="form-group">
                            <label>Garçons</label>
                            <input type="number" id="boysCount" class="form-control" min="0" value="0" readonly>
                        </div>
                    </div>
                </div>

                <div class="form-section">
                    <h2><i class="fas fa-user-plus"></i> Gestion des Élèves</h2>
                    <div class="form-row">
                        <div class="form-group">
                            <label>Nom</label>
                            <input type="text" id="studentLastName" class="form-control" placeholder="Nom">
                        </div>
                        <div class="form-group">
                            <label>Prénom</label>
                            <input type="text" id="studentFirstName" class="form-control" placeholder="Prénom">
                        </div>
                        <div class="form-group">
                            <label>Matricule</label>
                            <input type="text" id="studentId" class="form-control" placeholder="MAT-001">
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label>Sexe</label>
                            <select id="studentGender" class="form-control">
                                <option value="">Sélectionner</option>
                                <option value="M">Masculin</option>
                                <option value="F">Féminin</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Date de Naissance</label>
                            <input type="date" id="studentBirthDate" class="form-control">
                        </div>
                        <div class="form-group">
                            <label>Lieu de Naissance</label>
                            <input type="text" id="studentBirthPlace" class="form-control" placeholder="Ville">
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label>Statut</label>
                            <select id="studentStatus" class="form-control">
                                <option value="Nouveau">Nouveau</option>
                                <option value="Nouvelle">Nouvelle</option>
                                <option value="Redoublant">Redoublant</option>
                                <option value="Redoublante">Redoublante</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Nom du Tuteur</label>
                            <input type="text" id="guardianName" class="form-control" placeholder="Nom du tuteur">
                        </div>
                        <div class="form-group">
                            <label>Téléphone du Tuteur</label>
                            <input type="tel" id="guardianPhone" class="form-control" placeholder="+228 XX XX XX XX">
                        </div>
                    </div>
                    <div class="text-center mt-3">
                        <button class="btn btn-success btn-lg" onclick="addStudent()">
                            <i class="fas fa-plus"></i> Ajouter l'Élève
                        </button>
                        <button class="btn btn-info btn-lg" onclick="importStudents()">
                            <i class="fas fa-file-import"></i> Importer Liste
                        </button>
                    </div>
                </div>

                <div class="form-section">
                    <h2><i class="fas fa-list"></i> Liste des Élèves</h2>
                    <div class="student-list" id="studentsList">
                        <!-- Students will be dynamically added here -->
                    </div>
                </div>
            </div>

            <!-- Tab 2: Subjects Management -->
            <div class="tab-content" id="tab1">
                <div class="form-section">
                    <h2><i class="fas fa-book-open"></i> Programme Scolaire</h2>
                    <div class="alert alert-info">
                        <i class="fas fa-info-circle"></i>
                        <div>
                            <strong>Information:</strong> Les matières sont automatiquement chargées selon le niveau et la classe sélectionnés.
                            Vous pouvez personnaliser les coefficients et ajouter des matières spécifiques.
                        </div>
                    </div>
                    
                    <div class="table-container">
                        <table class="data-table" id="subjectsTable">
                            <thead>
                                <tr>
                                    <th>Matière</th>
                                    <th>Coefficient</th>
                                    <th>Professeur</th>
                                    <th>Heures/Semaine</th>
                                    <th>Type</th>
                                    <th>Catégorie</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="subjectsList">
                                <!-- Subjects will be dynamically added here -->
                            </tbody>
                        </table>
                    </div>
                    
                    <div class="mt-3">
                        <button class="btn btn-success" onclick="addSubject()">
                            <i class="fas fa-plus"></i> Ajouter une Matière
                        </button>
                        <button class="btn btn-primary" onclick="loadDefaultSubjects()">
                            <i class="fas fa-sync"></i> Charger le Programme Standard
                        </button>
                    </div>
                </div>
            </div>

            <!-- Tab 3: Grades Entry -->
            <div class="tab-content" id="tab2">
                <div class="form-section">
                    <h2><i class="fas fa-edit"></i> Saisie des Notes</h2>
                    
                    <div class="filter-bar">
                        <div class="form-group">
                            <label>Sélectionner un Élève</label>
                            <select id="studentSelect" class="form-control" onchange="loadStudentGrades()">
                                <option value="">Tous les élèves</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Matière</label>
                            <select id="subjectFilter" class="form-control" onchange="filterGrades()">
                                <option value="">Toutes les matières</option>
                            </select>
                        </div>
                    </div>
                    
                    <div class="notes-grid" id="gradesContainer">
                        <!-- Grades entry forms will be dynamically generated here -->
                    </div>
                </div>
            </div>

            <!-- Tab 4: Statistics -->
            <div class="tab-content" id="tab3">
                <div class="form-section">
                    <h2><i class="fas fa-chart-bar"></i> Statistiques de la Classe</h2>
                    
                    <div class="stats-grid">
                        <div class="stat-card">
                            <div class="stat-value" id="classAverage">0.00</div>
                            <div class="stat-label">Moyenne Générale</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-value" id="highestAverage">0.00</div>
                            <div class="stat-label">Meilleure Moyenne</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-value" id="lowestAverage">0.00</div>
                            <div class="stat-label">Plus Basse Moyenne</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-value" id="passRate">0%</div>
                            <div class="stat-label">Taux de Réussite</div>
                        </div>
                    </div>
                    
                    <h3><i class="fas fa-trophy"></i> Classement des Élèves</h3>
                    <div class="table-container">
                        <table class="data-table" id="rankingTable">
                            <thead>
                                <tr>
                                    <th>Rang</th>
                                    <th>Élève</th>
                                    <th>Moyenne</th>
                                    <th>Mention</th>
                                    <th>Évolution</th>
                                    <th>Détails</th>
                                </tr>
                            </thead>
                            <tbody id="rankingList">
                                <!-- Ranking will be dynamically added here -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Tab 5: Bulletin -->
            <div class="tab-content" id="tab4">
                <div class="form-section">
                    <h2><i class="fas fa-file-pdf"></i> Génération du Bulletin</h2>
                    
                    <div class="bulletin-options no-print">
                        <h3><i class="fas fa-cog"></i> Options du Bulletin</h3>
                        <div class="form-row">
                            <div class="form-group">
                                <label>
                                    <input type="checkbox" id="watermarkToggle" checked onchange="toggleWatermark()">
                                    Afficher le filigrane des armoiries
                                </label>
                            </div>
                            <div class="form-group">
                                <label>
                                    <input type="checkbox" id="autoCalculate" checked>
                                    Calcul automatique des moyennes
                                </label>
                            </div>
                            <div class="form-group">
                                <label>Sélectionner un élève</label>
                                <select id="bulletinStudentSelect" class="form-control" onchange="updateSelectedStudent()">
                                    <option value="all">Tous les élèves</option>
                                </select>
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label>Options d'impression</label>
                                <div class="d-flex gap-2">
                                    <button class="btn btn-sm btn-outline-primary" onclick="printSingleBulletin()">
                                        <i class="fas fa-print"></i> Imprimer bulletin actuel
                                    </button>
                                    <button class="btn btn-sm btn-outline-success" onclick="printAllBulletins()">
                                        <i class="fas fa-print"></i> Imprimer tous les bulletins
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="bulletin-preview-container">
                        <div class="bulletin-actions no-print">
                            <button class="btn btn-primary btn-sm" onclick="generateBulletin()">
                                <i class="fas fa-sync"></i> Générer
                            </button>
                            <button class="btn btn-success btn-sm" onclick="printBulletin()">
                                <i class="fas fa-print"></i> Imprimer
                            </button>
                            <button class="btn btn-info btn-sm" onclick="exportPDF()">
                                <i class="fas fa-file-pdf"></i> PDF
                            </button>
                            <button class="btn btn-warning btn-sm" onclick="exportAllPDF()">
                                <i class="fas fa-file-pdf"></i> Tous en PDF
                            </button>
                            <button class="btn btn-secondary btn-sm" onclick="saveCurrentBulletin()">
                                <i class="fas fa-save"></i> Sauvegarder
                            </button>
                        </div>
                        
                        <div id="bulletinPreview" class="bulletin-togo with-watermark">
                            <!-- Bulletin preview will be generated here -->
                            <div class="watermark" id="watermarkElement">RÉPUBLIQUE TOGOLAISE</div>
                            <div class="alert alert-info text-center">
                                <i class="fas fa-info-circle"></i>
                                <span>Cliquez sur "Générer" pour créer le bulletin scolaire</span>
                            </div>
                        </div>
                    </div>
                    
                    <div class="mt-3 no-print">
                        <button class="btn btn-success" onclick="saveAllReports()">
                            <i class="fas fa-save"></i> Enregistrer Tous les Bulletins
                        </button>
                        <button class="btn btn-info" onclick="generateAllBulletins()">
                            <i class="fas fa-copy"></i> Générer Tous les Bulletins
                        </button>
                        <button class="btn btn-warning" onclick="testPrint()">
                            <i class="fas fa-bug"></i> Test Impression
                        </button>
                    </div>
                </div>
            </div>

            <!-- Tab 6: Archives -->
            <div class="tab-content" id="tab5">
                <div class="form-section">
                    <h2><i class="fas fa-archive"></i> Archives des Bulletins</h2>
                    
                    <div class="filter-bar">
                        <div class="form-group">
                            <label>Année Scolaire</label>
                            <select id="archiveYear" class="form-control" onchange="filterArchives()">
                                <option value="">Toutes</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Classe</label>
                            <select id="archiveClass" class="form-control" onchange="filterArchives()">
                                <option value="">Toutes</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Période</label>
                            <select id="archivePeriod" class="form-control" onchange="filterArchives()">
                                <option value="">Toutes</option>
                            </select>
                        </div>
                    </div>
                    
                    <div class="table-container">
                        <table class="data-table" id="archivesTable">
                            <thead>
                                <tr>
                                    <th>Date</th>
                                    <th>Élève</th>
                                    <th>Classe</th>
                                    <th>Période</th>
                                    <th>Moyenne</th>
                                    <th>Rang</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="archivesList">
                                <!-- Archives will be dynamically added here -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Tab 7: Settings -->
            <div class="tab-content" id="tab6">
                <div class="form-section">
                    <h2><i class="fas fa-cogs"></i> Configuration</h2>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label>Seuil de Réussite</label>
                            <input type="number" id="passingGrade" class="form-control" min="0" max="20" step="0.5" value="10" onchange="updatePassingGrade()">
                        </div>
                        <div class="form-group">
                            <label>Arrondir les Notes</label>
                            <select id="roundingPrecision" class="form-control" onchange="updateRoundingPrecision()">
                                <option value="0">Unités</option>
                                <option value="1" selected>Dixièmes</option>
                                <option value="2">Centaines</option>
                            </select>
                        </div>
                    </div>
                    
                    <div class="form-section mt-3">
                        <h3><i class="fas fa-database"></i> Gestion des Données</h3>
                        <div class="d-flex gap-2 flex-wrap">
                            <button class="btn btn-primary" onclick="saveAllData()">
                                <i class="fas fa-save"></i> Sauvegarder
                            </button>
                            <button class="btn btn-secondary" onclick="loadBackup()">
                                <i class="fas fa-upload"></i> Restaurer
                            </button>
                            <button class="btn btn-danger" onclick="clearData()">
                                <i class="fas fa-trash"></i> Réinitialiser
                            </button>
                            <button class="btn btn-info" onclick="exportData()">
                                <i class="fas fa-file-export"></i> Exporter Excel
                            </button>
                        </div>
                    </div>

                    <div class="form-section mt-3">
                        <h3><i class="fas fa-info-circle"></i> Informations du Système</h3>
                        <div class="form-row">
                            <div class="form-group">
                                <label>Version</label>
                                <input type="text" class="form-control" value="3.0 - République Togolaise" readonly>
                            </div>
                            <div class="form-group">
                                <label>Dernière Sauvegarde</label>
                                <input type="text" id="lastBackup" class="form-control" readonly>
                            </div>
                            <div class="form-group">
                                <label>Nombre d'Élèves</label>
                                <input type="text" id="systemStudentCount" class="form-control" readonly>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </main>

        <!-- Footer -->
        <footer class="p-3 bg-light text-center no-print">
            <div class="footer-content">
                <div class="togo-flag d-inline-flex mb-2">
                    <div class="flag-stripe stripe-red"></div>
                    <div class="flag-stripe stripe-yellow"></div>
                    <div class="flag-stripe stripe-green"></div>
                </div>
                <p class="mb-1"><strong>République Togolaise</strong> - Travail • Liberté • Patrie</p>
                <p class="text-muted">Ministère des Enseignements Primaire, Secondaire et Technique © 2025</p>
                <div class="mt-2">
                    <button class="btn btn-sm btn-success" onclick="saveAllData()">
                        <i class="fas fa-save"></i> Sauvegarder
                    </button>
                    <button class="btn btn-sm btn-info" onclick="calculateAllStatistics()">
                        <i class="fas fa-calculator"></i> Calculer
                    </button>
                </div>
            </div>
        </footer>
    </div>

    <!-- Container pour impression multiple -->
    <div id="bulletinMultipleContainer" class="bulletin-multiple-container"></div>

    <!-- Modals -->
    <div id="helpModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3><i class="fas fa-question-circle"></i> Aide & Documentation</h3>
                <button class="btn btn-sm btn-danger" onclick="closeModal('helpModal')">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-body">
                <h4><i class="fas fa-flag text-secondary"></i> Système de Gestion Scolaire - Togo</h4>
                <p>Ce système permet de gérer complètement les bulletins scolaires pour les établissements togolais :</p>
                <ul>
                    <li><strong>Tab 1:</strong> Gérer les élèves et les informations de la classe</li>
                    <li><strong>Tab 2:</strong> Configurer les matières et coefficients selon les programmes togolais</li>
                    <li><strong>Tab 3:</strong> Saisir les notes des élèves</li>
                    <li><strong>Tab 4:</strong> Voir les statistiques et classements</li>
                    <li><strong>Tab 5:</strong> Générer et imprimer les bulletins officiels</li>
                    <li><strong>Tab 6:</strong> Consulter les archives</li>
                    <li><strong>Tab 7:</strong> Configurer le système</li>
                </ul>
                <h4 class="mt-3"><i class="fas fa-keyboard"></i> Raccourcis clavier</h4>
                <ul>
                    <li><strong>Ctrl + S:</strong> Sauvegarder les données</li>
                    <li><strong>Ctrl + P:</strong> Imprimer le bulletin</li>
                    <li><strong>F1:</strong> Ouvrir l'aide</li>
                </ul>
            </div>
            <div class="modal-footer">
                <button class="btn btn-primary" onclick="closeModal('helpModal')">
                    <i class="fas fa-check"></i> Compris
                </button>
            </div>
        </div>
    </div>

    <div id="studentDetailsModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3><i class="fas fa-user-graduate"></i> Détails de l'Élève</h3>
                <button class="btn btn-sm btn-danger" onclick="closeModal('studentDetailsModal')">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-body" id="studentDetailsContent">
                <!-- Student details will be loaded here -->
            </div>
        </div>
    </div>

    <script>
        // Global variables
        let students = [];
        let subjects = [];
        let grades = {};
        let archives = [];
        let currentSettings = {
            passingGrade: 10,
            roundingPrecision: 1,
            showWatermark: true
        };
        let currentStudentForBulletin = null;
        let generatedBulletins = []; // Pour stocker les bulletins générés

        // Initialize the application
        document.addEventListener('DOMContentLoaded', function() {
            // Set current date
            const today = new Date();
            document.getElementById('editionDate').valueAsDate = today;
            const nextYear = today.getFullYear() + 1;
            document.getElementById('schoolYear').value = `${today.getFullYear()}-${nextYear}`;
            
            // Load saved data
            loadAllData();
            
            // Update counters
            updateCounters();
            
            // Initialize subject filter
            updateSubjectFilter();
            updateBulletinStudentSelect();
            
            // Show welcome message
            showNotification('Système de Gestion Scolaire Togolais chargé avec succès !', 'success');
            
            // Initialize tabs
            document.querySelectorAll('.tab-content')[0].classList.add('active');
            
            // Add keyboard shortcuts
            initializeKeyboardShortcuts();
            
            // Set watermark
            updateWatermark();
        });

        // Update watermark with school info
        function updateWatermark() {
            const schoolName = document.getElementById('schoolName').value || 'Établissement';
            const watermark = document.getElementById('watermarkElement');
            if (watermark) {
                watermark.textContent = schoolName.toUpperCase();
                watermark.style.display = currentSettings.showWatermark ? 'block' : 'none';
            }
        }

        // Toggle watermark
        function toggleWatermark() {
            currentSettings.showWatermark = document.getElementById('watermarkToggle').checked;
            const bulletinContainer = document.getElementById('bulletinPreview');
            if (currentSettings.showWatermark) {
                bulletinContainer.classList.add('with-watermark');
            } else {
                bulletinContainer.classList.remove('with-watermark');
            }
            updateWatermark();
            saveAllData();
        }

        // Update bulletin student select
        function updateBulletinStudentSelect() {
            const select = document.getElementById('bulletinStudentSelect');
            if (!select) return;
            
            select.innerHTML = '<option value="all">Tous les élèves</option>';
            students.forEach(student => {
                const option = document.createElement('option');
                option.value = student.id;
                option.textContent = `${student.lastName} ${student.firstName} (${student.studentId})`;
                select.appendChild(option);
            });
        }

        function updateSelectedStudent() {
            const studentId = document.getElementById('bulletinStudentSelect').value;
            if (studentId !== 'all') {
                generateBulletin(studentId);
            } else {
                generateBulletin();
            }
        }

        // Initialize keyboard shortcuts
        function initializeKeyboardShortcuts() {
            document.addEventListener('keydown', function(e) {
                // Ctrl+S to save
                if (e.ctrlKey && e.key === 's') {
                    e.preventDefault();
                    saveAllData();
                    showNotification('Données sauvegardées', 'success');
                }
                
                // Ctrl+P to print
                if (e.ctrlKey && e.key === 'p') {
                    e.preventDefault();
                    printBulletin();
                }
                
                // F1 for help
                if (e.key === 'F1') {
                    e.preventDefault();
                    showHelp();
                }
            });
        }

        // Tab switching
        function switchTab(tabIndex) {
            // Hide all tabs
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.remove('active');
            });
            
            // Remove active class from all tabs
            document.querySelectorAll('.tab').forEach(tab => {
                tab.classList.remove('active');
            });
            
            // Show selected tab and activate button
            const tabContents = document.querySelectorAll('.tab-content');
            const tabButtons = document.querySelectorAll('.tab');
            
            if (tabContents[tabIndex]) {
                tabContents[tabIndex].classList.add('active');
                tabButtons[tabIndex].classList.add('active');
                
                // Update data for the tab
                switch(tabIndex) {
                    case 0: // Class management
                        updateStudentList();
                        break;
                    case 1: // Subjects
                        updateSubjectsList();
                        break;
                    case 2: // Grades
                        updateStudentSelect();
                        updateGradesDisplay();
                        break;
                    case 3: // Statistics
                        calculateStatistics();
                        updateRanking();
                        break;
                    case 4: // Bulletin
                        generateBulletin();
                        break;
                    case 5: // Archives
                        loadArchives();
                        break;
                    case 6: // Settings
                        updateSystemInfo();
                        break;
                }
            }
        }

        // Student management
        function addStudent() {
            const lastName = document.getElementById('studentLastName').value.trim();
            const firstName = document.getElementById('studentFirstName').value.trim();
            const studentId = document.getElementById('studentId').value.trim();
            const gender = document.getElementById('studentGender').value;
            const birthDate = document.getElementById('studentBirthDate').value;
            const birthPlace = document.getElementById('studentBirthPlace').value.trim();
            const status = document.getElementById('studentStatus').value;
            const guardianName = document.getElementById('guardianName').value.trim();
            const guardianPhone = document.getElementById('guardianPhone').value.trim();

            if (!lastName || !firstName) {
                showNotification('Veuillez saisir au moins le nom et le prénom', 'danger');
                return;
            }

            const student = {
                id: Date.now().toString(),
                lastName,
                firstName,
                studentId: studentId || `MAT-${Date.now().toString().slice(-6)}`,
                gender,
                birthDate,
                birthPlace,
                status,
                guardianName,
                guardianPhone,
                class: document.getElementById('class').value || 'Non spécifié',
                createdAt: new Date().toISOString()
            };

            students.push(student);
            
            // Initialize grades for this student
            grades[student.id] = {};
            
            // Clear form
            document.getElementById('studentLastName').value = '';
            document.getElementById('studentFirstName').value = '';
            document.getElementById('studentId').value = '';
            document.getElementById('studentGender').value = '';
            document.getElementById('studentBirthDate').value = '';
            document.getElementById('studentBirthPlace').value = '';
            document.getElementById('guardianName').value = '';
            document.getElementById('guardianPhone').value = '';
            
            // Update UI
            updateStudentList();
            updateCounters();
            updateStudentSelect();
            updateBulletinStudentSelect();
            saveAllData();
            
            showNotification(`Élève ${lastName} ${firstName} ajouté avec succès`, 'success');
        }

        function updateStudentList() {
            const container = document.getElementById('studentsList');
            if (!container) return;
            
            container.innerHTML = '';
            
            if (students.length === 0) {
                container.innerHTML = `
                    <div class="alert alert-info text-center p-3">
                        <i class="fas fa-info-circle fa-2x mb-2"></i>
                        <p>Aucun élève ajouté. Commencez par ajouter des élèves en utilisant le formulaire ci-dessus.</p>
                    </div>
                `;
                return;
            }
            
            students.forEach(student => {
                const item = document.createElement('div');
                item.className = 'student-item';
                item.innerHTML = `
                    <div class="student-info">
                        <div class="student-name">${student.lastName} ${student.firstName}</div>
                        <div class="student-details">
                            <span><i class="fas fa-id-card"></i> ${student.studentId}</span>
                            <span>${student.gender === 'M' ? '♂ Masculin' : '♀ Féminin'}</span>
                            <span class="badge ${student.status.includes('Nouveau') ? 'badge-info' : 'badge-warning'}">
                                ${student.status}
                            </span>
                        </div>
                    </div>
                    <div><i class="fas fa-calendar"></i> ${student.birthDate ? formatDate(student.birthDate) : 'Non renseigné'}</div>
                    <div><i class="fas fa-phone"></i> ${student.guardianPhone || 'Non renseigné'}</div>
                    <div class="student-actions">
                        <button class="btn btn-sm btn-info" onclick="viewStudentDetails('${student.id}')">
                            <i class="fas fa-eye"></i>
                        </button>
                        <button class="btn btn-sm btn-warning" onclick="editStudent('${student.id}')">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button class="btn btn-sm btn-danger" onclick="deleteStudent('${student.id}')">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                `;
                container.appendChild(item);
            });
            
            updateClassStats();
        }

        function viewStudentDetails(studentId) {
            const student = students.find(s => s.id === studentId);
            if (!student) return;
            
            const average = calculateStudentAverage(studentId);
            const mention = getMention(average);
            
            const content = document.getElementById('studentDetailsContent');
            content.innerHTML = `
                <div class="form-row">
                    <div class="form-group">
                        <label>Nom complet</label>
                        <input type="text" class="form-control" value="${student.lastName} ${student.firstName}" readonly>
                    </div>
                    <div class="form-group">
                        <label>Matricule</label>
                        <input type="text" class="form-control" value="${student.studentId}" readonly>
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label>Date de naissance</label>
                        <input type="text" class="form-control" value="${formatDate(student.birthDate) || 'Non renseigné'}" readonly>
                    </div>
                    <div class="form-group">
                        <label>Lieu de naissance</label>
                        <input type="text" class="form-control" value="${student.birthPlace || 'Non renseigné'}" readonly>
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label>Tuteur</label>
                        <input type="text" class="form-control" value="${student.guardianName || 'Non renseigné'}" readonly>
                    </div>
                    <div class="form-group">
                        <label>Téléphone tuteur</label>
                        <input type="text" class="form-control" value="${student.guardianPhone || 'Non renseigné'}" readonly>
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label>Moyenne générale</label>
                        <input type="text" class="form-control" value="${average.toFixed(2)}/20" readonly>
                    </div>
                    <div class="form-group">
                        <label>Mention</label>
                        <input type="text" class="form-control" value="${mention}" readonly>
                    </div>
                </div>
                <div class="mt-3">
                    <h4>Notes par matière</h4>
                    <div class="table-container">
                        <table class="data-table">
                            <thead>
                                <tr>
                                    <th>Matière</th>
                                    <th>Note 1</th>
                                    <th>Note 2</th>
                                    <th>Moyenne</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${subjects.map(subject => {
                                    const subjectGrades = grades[student.id]?.[subject.id] || {};
                                    const note1 = subjectGrades.note1 || '-';
                                    const note2 = subjectGrades.note2 || '-';
                                    const avg = calculateSubjectAverage(subjectGrades);
                                    return `
                                        <tr>
                                            <td>${subject.name}</td>
                                            <td>${note1}</td>
                                            <td>${note2}</td>
                                            <td>${avg > 0 ? avg.toFixed(2) : '-'}</td>
                                        </tr>
                                    `;
                                }).join('')}
                            </tbody>
                        </table>
                    </div>
                </div>
            `;
            
            document.getElementById('studentDetailsModal').classList.add('show');
        }

        function editStudent(studentId) {
            const student = students.find(s => s.id === studentId);
            if (!student) return;
            
            // Fill form with student data
            document.getElementById('studentLastName').value = student.lastName;
            document.getElementById('studentFirstName').value = student.firstName;
            document.getElementById('studentId').value = student.studentId;
            document.getElementById('studentGender').value = student.gender;
            document.getElementById('studentBirthDate').value = student.birthDate;
            document.getElementById('studentBirthPlace').value = student.birthPlace;
            document.getElementById('studentStatus').value = student.status;
            document.getElementById('guardianName').value = student.guardianName;
            document.getElementById('guardianPhone').value = student.guardianPhone;
            
            // Remove student from list
            students = students.filter(s => s.id !== studentId);
            updateStudentList();
            
            showNotification(`Élève ${student.lastName} ${student.firstName} chargé pour modification`, 'info');
        }

        function deleteStudent(studentId) {
            if (!confirm('Voulez-vous vraiment supprimer cet élève ? Cette action supprimera également toutes ses notes.')) return;
            
            const student = students.find(s => s.id === studentId);
            students = students.filter(s => s.id !== studentId);
            delete grades[studentId];
            
            updateStudentList();
            updateCounters();
            updateStudentSelect();
            updateBulletinStudentSelect();
            saveAllData();
            
            showNotification(`Élève ${student?.lastName || ''} supprimé`, 'success');
        }

        // Subject management
        function loadDefaultSubjects() {
            const level = document.getElementById('level').value;
            const className = document.getElementById('class').value;
            const series = document.getElementById('series').value;
            
            if (!level || !className) {
                showNotification('Veuillez d\'abord sélectionner le niveau et la classe', 'warning');
                return;
            }
            
            // Default subjects based on level
            if (level === 'college') {
                subjects = [
                    { id: 1, name: 'Français', coefficient: 1, teacher: 'M. DUPONT', hours: 5, type: 'Obligatoire', category: 'Littéraire' },
                    { id: 2, name: 'Mathématiques', coefficient: 1, teacher: 'Mme. KOFFI', hours: 5, type: 'Obligatoire', category: 'Scientifique' },
                    { id: 3, name: 'Histoire-Géographie', coefficient: 1, teacher: 'M. ADAM', hours: 4, type: 'Obligatoire', category: 'Littéraire' },
                    { id: 4, name: 'SVT', coefficient: 1, teacher: 'Mme. ASSIMA', hours: 4, type: 'Obligatoire', category: 'Scientifique' },
                    { id: 5, name: 'Physique-Chimie', coefficient: 1, teacher: 'M. KOUMA', hours: 4, type: 'Obligatoire', category: 'Scientifique' },
                    { id: 6, name: 'Anglais', coefficient: 1, teacher: 'Mme. JOHNSON', hours: 3, type: 'Obligatoire', category: 'Littéraire' },
                    { id: 7, name: 'EPS', coefficient: 1, teacher: 'M. GBEASSOR', hours: 2, type: 'Obligatoire', category: 'Autre' },
                    { id: 8, name: 'Arts Plastiques', coefficient: 1, teacher: 'Mme. DOSSOU', hours: 2, type: 'Optionnel', category: 'Autre' }
                ];
            } else if (level === 'lycee') {
                let baseSubjects = [
                    { id: 1, name: 'Français', coefficient: 3, teacher: 'M. DUPONT', hours: 6, type: 'Obligatoire', category: 'Littéraire' },
                    { id: 2, name: 'Philosophie', coefficient: 3, teacher: 'M. SAGBO', hours: 4, type: 'Obligatoire', category: 'Littéraire' },
                    { id: 3, name: 'Histoire-Géographie', coefficient: 2, teacher: 'M. ADAM', hours: 4, type: 'Obligatoire', category: 'Littéraire' },
                    { id: 4, name: 'LV1 (Anglais)', coefficient: 2, teacher: 'Mme. JOHNSON', hours: 3, type: 'Obligatoire', category: 'Littéraire' },
                    { id: 5, name: 'EPS', coefficient: 1, teacher: 'M. GBEASSOR', hours: 2, type: 'Obligatoire', category: 'Autre' }
                ];
                
                // Add series-specific subjects
                if (series === 'A') {
                    baseSubjects.push(
                        { id: 6, name: 'Langues Anciennes', coefficient: 3, teacher: 'M. AGBA', hours: 4, type: 'Spécifique', category: 'Littéraire' },
                        { id: 7, name: 'LV2 (Allemand)', coefficient: 2, teacher: 'Mme. MULLER', hours: 3, type: 'Obligatoire', category: 'Littéraire' }
                    );
                } else if (series === 'C') {
                    baseSubjects.push(
                        { id: 6, name: 'Mathématiques', coefficient: 5, teacher: 'Mme. KOFFI', hours: 8, type: 'Spécifique', category: 'Scientifique' },
                        { id: 7, name: 'Physique-Chimie', coefficient: 3, teacher: 'M. KOUMA', hours: 6, type: 'Spécifique', category: 'Scientifique' }
                    );
                } else if (series === 'D') {
                    baseSubjects.push(
                        { id: 6, name: 'Mathématiques', coefficient: 3, teacher: 'Mme. KOFFI', hours: 6, type: 'Spécifique', category: 'Scientifique' },
                        { id: 7, name: 'SVT', coefficient: 4, teacher: 'Mme. ASSIMA', hours: 6, type: 'Spécifique', category: 'Scientifique' }
                    );
                } else if (series === 'E') {
                    baseSubjects.push(
                        { id: 6, name: 'Mathématiques', coefficient: 5, teacher: 'Mme. KOFFI', hours: 8, type: 'Spécifique', category: 'Scientifique' },
                        { id: 7, name: 'Technologie', coefficient: 4, teacher: 'M. AKAKPO', hours: 6, type: 'Spécifique', category: 'Scientifique' }
                    );
                }
                
                subjects = baseSubjects;
            }
            
            updateSubjectsList();
            updateSubjectFilter();
            saveAllData();
            
            showNotification('Programme chargé avec succès', 'success');
        }

        function updateSubjects() {
            // This function can be called when level/class changes
            const level = document.getElementById('level').value;
            const className = document.getElementById('class').value;
            
            if (level && className) {
                // Clear existing subjects if needed
                if (confirm('Voulez-vous charger les matières par défaut pour ce niveau ?')) {
                    loadDefaultSubjects();
                }
            }
        }

        function addSubject() {
            const subject = {
                id: Date.now().toString(),
                name: 'Nouvelle Matière',
                coefficient: 1,
                teacher: '',
                hours: 2,
                type: 'Obligatoire',
                category: 'Autre'
            };
            
            subjects.push(subject);
            updateSubjectsList();
            updateSubjectFilter();
            saveAllData();
            
            showNotification('Matière ajoutée', 'success');
        }

        function updateSubjectsList() {
            const container = document.getElementById('subjectsList');
            if (!container) return;
            
            container.innerHTML = '';
            
            subjects.forEach((subject, index) => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>
                        <input type="text" value="${subject.name}" class="form-control" 
                               onchange="updateSubjectField(${index}, 'name', this.value)">
                    </td>
                    <td>
                        <input type="number" value="${subject.coefficient}" min="1" max="10" class="form-control" 
                               onchange="updateSubjectField(${index}, 'coefficient', this.value)">
                    </td>
                    <td>
                        <input type="text" value="${subject.teacher}" class="form-control" 
                               onchange="updateSubjectField(${index}, 'teacher', this.value)" 
                               placeholder="Nom du professeur">
                    </td>
                    <td>
                        <input type="number" value="${subject.hours}" min="1" max="10" class="form-control" 
                               onchange="updateSubjectField(${index}, 'hours', this.value)">
                    </td>
                    <td>
                        <select class="form-control" onchange="updateSubjectField(${index}, 'type', this.value)">
                            <option value="Obligatoire" ${subject.type === 'Obligatoire' ? 'selected' : ''}>Obligatoire</option>
                            <option value="Optionnel" ${subject.type === 'Optionnel' ? 'selected' : ''}>Optionnel</option>
                            <option value="Spécifique" ${subject.type === 'Spécifique' ? 'selected' : ''}>Spécifique</option>
                        </select>
                    </td>
                    <td>
                        <select class="form-control" onchange="updateSubjectField(${index}, 'category', this.value)">
                            <option value="Scientifique" ${subject.category === 'Scientifique' ? 'selected' : ''}>Scientifique</option>
                            <option value="Littéraire" ${subject.category === 'Littéraire' ? 'selected' : ''}>Littéraire</option>
                            <option value="Autre" ${subject.category === 'Autre' ? 'selected' : ''}>Autre</option>
                        </select>
                    </td>
                    <td>
                        <button class="btn btn-sm btn-danger" onclick="removeSubject(${index})">
                            <i class="fas fa-trash"></i>
                        </button>
                    </td>
                `;
                container.appendChild(row);
            });
            
            updateCounters();
        }

        function updateSubjectField(index, field, value) {
            if (subjects[index]) {
                subjects[index][field] = field === 'coefficient' || field === 'hours' ? parseInt(value) || 1 : value;
                saveAllData();
            }
        }

        function removeSubject(index) {
            if (!confirm('Supprimer cette matière ? Toutes les notes associées seront perdues.')) return;
            subjects.splice(index, 1);
            updateSubjectsList();
            updateSubjectFilter();
            saveAllData();
            
            showNotification('Matière supprimée', 'success');
        }

        // Grades management
        function updateStudentSelect() {
            const select = document.getElementById('studentSelect');
            if (!select) return;
            
            select.innerHTML = '<option value="">Tous les élèves</option>';
            students.forEach(student => {
                const option = document.createElement('option');
                option.value = student.id;
                option.textContent = `${student.lastName} ${student.firstName} (${student.studentId})`;
                select.appendChild(option);
            });
        }

        function updateSubjectFilter() {
            const select = document.getElementById('subjectFilter');
            if (!select) return;
            
            select.innerHTML = '<option value="">Toutes les matières</option>';
            subjects.forEach(subject => {
                const option = document.createElement('option');
                option.value = subject.id;
                option.textContent = `${subject.name} (coef. ${subject.coefficient})`;
                select.appendChild(option);
            });
        }

        function loadStudentGrades() {
            const studentId = document.getElementById('studentSelect').value;
            updateGradesDisplay(studentId);
        }

        function filterGrades() {
            const subjectId = document.getElementById('subjectFilter').value;
            updateGradesDisplay(null, subjectId);
        }

        function updateGradesDisplay(studentId = null, subjectId = null) {
            const container = document.getElementById('gradesContainer');
            if (!container) return;
            
            if (students.length === 0 || subjects.length === 0) {
                container.innerHTML = `
                    <div class="alert alert-warning text-center">
                        <i class="fas fa-exclamation-triangle"></i>
                        <p>Ajoutez d'abord des élèves et des matières dans les onglets précédents.</p>
                    </div>
                `;
                return;
            }
            
            // Filter students if needed
            let filteredStudents = students;
            if (studentId) {
                filteredStudents = students.filter(s => s.id == studentId);
            }
            
            container.innerHTML = '';
            
            filteredStudents.forEach(student => {
                const card = document.createElement('div');
                card.className = 'note-card';
                card.innerHTML = `
                    <div class="note-header">
                        <h4>${student.lastName} ${student.firstName}</h4>
                        <span class="badge badge-primary">${student.studentId}</span>
                    </div>
                    <div class="note-inputs">
                        ${subjects.filter(subject => !subjectId || subject.id == subjectId).map(subject => {
                            const studentGrades = grades[student.id] || {};
                            const subjectGrades = studentGrades[subject.id] || {};
                            const average = calculateSubjectAverage(subjectGrades);
                            
                            return `
                                <div class="form-row">
                                    <div class="form-group">
                                        <label>${subject.name} (coef. ${subject.coefficient})</label>
                                        <div class="note-input-group">
                                            <input type="number" min="0" max="20" step="0.5" 
                                                   value="${subjectGrades.note1 || ''}"
                                                   placeholder="Note 1"
                                                   class="form-control note-input"
                                                   onchange="updateGrade('${student.id}', '${subject.id}', 'note1', this.value)">
                                            <input type="number" min="0" max="20" step="0.5" 
                                                   value="${subjectGrades.note2 || ''}"
                                                   placeholder="Note 2"
                                                   class="form-control note-input"
                                                   onchange="updateGrade('${student.id}', '${subject.id}', 'note2', this.value)">
                                        </div>
                                        <div class="note-average">
                                            Moyenne: ${average > 0 ? average.toFixed(2) : '-'}/20
                                        </div>
                                    </div>
                                </div>
                            `;
                        }).join('')}
                    </div>
                    <div class="text-center mt-2">
                        <span class="badge badge-info">Moyenne générale: ${calculateStudentAverage(student.id).toFixed(2)}/20</span>
                    </div>
                `;
                container.appendChild(card);
            });
        }

        function updateGrade(studentId, subjectId, type, value) {
            if (!grades[studentId]) {
                grades[studentId] = {};
            }
            if (!grades[studentId][subjectId]) {
                grades[studentId][subjectId] = {};
            }
            
            // Parse and validate value
            const numericValue = parseFloat(value);
            if (isNaN(numericValue) || numericValue < 0 || numericValue > 20) {
                grades[studentId][subjectId][type] = undefined;
            } else {
                grades[studentId][subjectId][type] = numericValue;
            }
            
            // Update display
            updateGradesDisplay();
            
            // Recalculate statistics
            calculateStatistics();
            updateRanking();
            
            saveAllData();
        }

        function calculateSubjectAverage(subjectGrades) {
            const note1 = subjectGrades.note1 || 0;
            const note2 = subjectGrades.note2 || 0;
            
            if (note1 === 0 && note2 === 0) return 0;
            if (note1 > 0 && note2 === 0) return note1;
            if (note1 === 0 && note2 > 0) return note2;
            
            return (note1 + note2) / 2;
        }

        // Statistics calculation
        function calculateStatistics() {
            if (students.length === 0) {
                resetStatistics();
                return;
            }
            
            let totalAverage = 0;
            let highestAverage = 0;
            let lowestAverage = 20;
            let passedStudents = 0;
            let studentCount = 0;
            
            students.forEach(student => {
                const studentAverage = calculateStudentAverage(student.id);
                if (studentAverage > 0) {
                    totalAverage += studentAverage;
                    studentCount++;
                    
                    if (studentAverage > highestAverage) highestAverage = studentAverage;
                    if (studentAverage < lowestAverage) lowestAverage = studentAverage;
                    if (studentAverage >= currentSettings.passingGrade) passedStudents++;
                }
            });
            
            const classAverage = studentCount > 0 ? totalAverage / studentCount : 0;
            const passRate = studentCount > 0 ? (passedStudents / studentCount) * 100 : 0;
            
            // Update UI
            document.getElementById('classAverage').textContent = classAverage.toFixed(2);
            document.getElementById('highestAverage').textContent = highestAverage.toFixed(2);
            document.getElementById('lowestAverage').textContent = lowestAverage.toFixed(2);
            document.getElementById('passRate').textContent = `${passRate.toFixed(1)}%`;
        }

        function resetStatistics() {
            document.getElementById('classAverage').textContent = '0.00';
            document.getElementById('highestAverage').textContent = '0.00';
            document.getElementById('lowestAverage').textContent = '0.00';
            document.getElementById('passRate').textContent = '0%';
        }

        function calculateStudentAverage(studentId) {
            const studentGrades = grades[studentId];
            if (!studentGrades || Object.keys(studentGrades).length === 0) return 0;
            
            let totalWeighted = 0;
            let totalCoefficients = 0;
            
            subjects.forEach(subject => {
                if (studentGrades[subject.id]) {
                    const average = calculateSubjectAverage(studentGrades[subject.id]);
                    if (average > 0) {
                        totalWeighted += average * subject.coefficient;
                        totalCoefficients += subject.coefficient;
                    }
                }
            });
            
            return totalCoefficients > 0 ? totalWeighted / totalCoefficients : 0;
        }

        function calculateAllStatistics() {
            calculateStatistics();
            updateRanking();
            showNotification('Statistiques calculées', 'success');
        }

        function updateRanking() {
            const container = document.getElementById('rankingList');
            if (!container) return;
            
            // Calculate averages for all students
            const studentAverages = students.map(student => ({
                ...student,
                average: calculateStudentAverage(student.id),
                mention: getMention(calculateStudentAverage(student.id))
            }));
            
            // Filter students with at least one grade
            const studentsWithGrades = studentAverages.filter(s => s.average > 0);
            
            if (studentsWithGrades.length === 0) {
                container.innerHTML = `
                    <tr>
                        <td colspan="6" class="text-center">
                            <div class="alert alert-info">
                                Aucune note saisie pour le moment
                            </div>
                        </td>
                    </tr>
                `;
                return;
            }
            
            // Sort by average (descending)
            studentsWithGrades.sort((a, b) => b.average - a.average);
            
            // Update table
            container.innerHTML = '';
            
            studentsWithGrades.forEach((student, index) => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td><strong>${index + 1}</strong></td>
                    <td>${student.lastName} ${student.firstName}</td>
                    <td>${student.average.toFixed(2)}</td>
                    <td><span class="badge badge-${getMentionColor(student.mention)}">${student.mention}</span></td>
                    <td><i class="fas fa-arrow-up text-success"></i> Stable</td>
                    <td>
                        <button class="btn btn-sm btn-info" onclick="viewStudentDetails('${student.id}')">
                            <i class="fas fa-eye"></i>
                        </button>
                    </td>
                `;
                container.appendChild(row);
            });
        }

        function getMention(average) {
            if (average >= 18) return 'Excellent';
            if (average >= 16) return 'Très Bien';
            if (average >= 14) return 'Bien';
            if (average >= 12) return 'Assez Bien';
            if (average >= 10) return 'Passable';
            return 'Insuffisant';
        }

        function getMentionColor(mention) {
            switch(mention) {
                case 'Excellent': return 'success';
                case 'Très Bien': return 'info';
                case 'Bien': return 'primary';
                case 'Assez Bien': return 'warning';
                case 'Passable': return 'warning';
                default: return 'danger';
            }
        }

        // New function to calculate success rate by category
        function calculateCategorySuccessRate(category) {
            if (students.length === 0) return 0;
            
            let totalPassed = 0;
            let totalStudents = 0;
            
            // Get subjects in this category
            const categorySubjects = subjects.filter(subject => subject.category === category);
            if (categorySubjects.length === 0) return 0;
            
            students.forEach(student => {
                const studentGrades = grades[student.id];
                if (!studentGrades) return;
                
                let categoryAverage = 0;
                let totalCoeff = 0;
                
                categorySubjects.forEach(subject => {
                    if (studentGrades[subject.id]) {
                        const avg = calculateSubjectAverage(studentGrades[subject.id]);
                        if (avg > 0) {
                            categoryAverage += avg * subject.coefficient;
                            totalCoeff += subject.coefficient;
                        }
                    }
                });
                
                if (totalCoeff > 0) {
                    const weightedAverage = categoryAverage / totalCoeff;
                    if (weightedAverage >= currentSettings.passingGrade) {
                        totalPassed++;
                    }
                    totalStudents++;
                }
            });
            
            return totalStudents > 0 ? (totalPassed / totalStudents) * 100 : 0;
        }

        // New function to get success rate badge class
        function getSuccessRateClass(rate) {
            if (rate >= 80) return 'success-rate-high';
            if (rate >= 60) return 'success-rate-medium';
            return 'success-rate-low';
        }

        // Bulletin generation avec style togolais - OPTIMISÉ POUR IMPRESSION
        function generateBulletin(studentId = null) {
            const container = document.getElementById('bulletinPreview');
            if (!container) return;
            
            if (students.length === 0) {
                container.innerHTML = `
                    <div class="alert alert-warning text-center">
                        <i class="fas fa-exclamation-triangle"></i>
                        <p>Aucun élève à afficher. Ajoutez d'abord des élèves.</p>
                    </div>
                `;
                return;
            }
            
            // Clear generated bulletins
            generatedBulletins = [];
            
            // Get selected student or all students
            let selectedStudents = [];
            if (studentId && studentId !== 'all') {
                const student = students.find(s => s.id === studentId);
                if (student) {
                    selectedStudents = [student];
                    currentStudentForBulletin = student.id;
                }
            } else {
                // Use first student as example for preview
                selectedStudents = [students[0]];
                currentStudentForBulletin = students[0].id;
            }
            
            if (selectedStudents.length === 0) {
                showNotification('Aucun élève sélectionné', 'warning');
                return;
            }
            
            // Generate bulletin for the first student (for preview)
            const student = selectedStudents[0];
            const bulletinHTML = createBulletinHTML(student);
            container.innerHTML = bulletinHTML;
            
            // Store all generated bulletins
            selectedStudents.forEach(s => {
                generatedBulletins.push({
                    student: s,
                    html: createBulletinHTML(s)
                });
            });
            
            updateWatermark();
            showNotification('Bulletin généré avec succès', 'success');
        }

        // Fonction pour créer le HTML d'un bulletin
        function createBulletinHTML(student) {
            const average = calculateStudentAverage(student.id);
            const mention = getMention(average);
            const rank = getStudentRank(student.id);
            
            const schoolYear = document.getElementById('schoolYear').value || '2024-2025';
            const periodSelect = document.getElementById('period');
            const period = periodSelect.options[periodSelect.selectedIndex]?.text || '1er Trimestre';
            const schoolName = document.getElementById('schoolName').value || 'CEG MASSEDENA';
            const className = document.getElementById('class').value || '6ème';
            const schoolCode = document.getElementById('schoolCode').value || '';
            const inspection = document.getElementById('inspection').value || 'IESG-Niamtougou';
            const city = document.getElementById('city').value || 'KARA';
            
            // Calculate success rates by category
            const scientificSuccessRate = calculateCategorySuccessRate('Scientifique');
            const literarySuccessRate = calculateCategorySuccessRate('Littéraire');
            const otherSuccessRate = calculateCategorySuccessRate('Autre');
            
            // Group subjects by category
            const scientificSubjects = subjects.filter(s => s.category === 'Scientifique');
            const literarySubjects = subjects.filter(s => s.category === 'Littéraire');
            const otherSubjects = subjects.filter(s => s.category === 'Autre');
            
            return `
                <div class="bulletin-header">
                    <div class="republic-togo">RÉPUBLIQUE TOGOLAISE</div>
                    <div class="motto-togo">Travail - Liberté - Patrie</div>
                    <div class="ministry-togo">MINISTÈRE DES ENSEIGNEMENTS PRIMAIRE, SECONDAIRE ET TECHNIQUE</div>
                    <div class="title-togo">BULLETIN SCOLAIRE OFFICIEL</div>
                    <div style="font-size: 12px; color: #666; margin-top: 8px;">
                        Année Scolaire: <strong>${schoolYear}</strong> | Période: <strong>${period}</strong>
                    </div>
                </div>
                
                <div class="school-info-bulletin">
                    <div>
                        <div><strong>Établissement:</strong> ${schoolName}</div>
                        <div><strong>Code:</strong> ${schoolCode}</div>
                        <div><strong>Ville:</strong> ${city}</div>
                        <div><strong>Inspection:</strong> ${inspection}</div>
                    </div>
                    <div>
                        <div><strong>Classe:</strong> ${className}</div>
                        <div><strong>Effectif:</strong> ${students.length}</div>
                        <div><strong>Filles/Garçons:</strong> ${document.getElementById('girlsCount').value || 0}/${document.getElementById('boysCount').value || 0}</div>
                        <div><strong>Date d'édition:</strong> ${new Date().toLocaleDateString('fr-FR')}</div>
                    </div>
                </div>
                
                <div class="student-info-bulletin">
                    <div>
                        <div><strong>Nom et Prénom:</strong></div>
                        <div>${student.lastName} ${student.firstName}</div>
                    </div>
                    <div>
                        <div><strong>Matricule:</strong></div>
                        <div>${student.studentId || 'Non précisé'}</div>
                    </div>
                    <div>
                        <div><strong>Sexe:</strong></div>
                        <div>${student.gender === 'M' ? 'Masculin' : 'Féminin'}</div>
                    </div>
                    <div>
                        <div><strong>Né(e) le:</strong></div>
                        <div>${student.birthDate ? formatDate(student.birthDate) : 'Non précisé'}</div>
                    </div>
                    <div>
                        <div><strong>À:</strong></div>
                        <div>${student.birthPlace || 'Non précisé'}</div>
                    </div>
                    <div>
                        <div><strong>Statut:</strong></div>
                        <div>${student.status === 'Nouveau' ? 'Nouveau/Nouvelle' : 'Redoublant(e)'}</div>
                    </div>
                </div>
                
                <h3 style="color: var(--primary-color); margin: 15px 0 8px 0; border-bottom: 2px solid var(--secondary-color); padding-bottom: 5px; font-size: 14px;">
                    <i class="fas fa-book"></i> NOTES ET APPRÉCIATIONS
                </h3>
                
                <!-- Matières Scientifiques -->
                ${scientificSubjects.length > 0 ? `
                <div class="category-header category-scientific-header">
                    <i class="fas fa-flask"></i> MATIÈRES SCIENTIFIQUES 
                    <span class="success-rate ${getSuccessRateClass(scientificSuccessRate)}">
                        ${scientificSuccessRate.toFixed(0)}% de réussite
                    </span>
                </div>
                <table class="grades-table">
                    <thead>
                        <tr>
                            <th>DISCIPLINES</th>
                            <th>Professeur</th>
                            <th>Coeff.</th>
                            <th>Note 1</th>
                            <th>Note 2</th>
                            <th>Moyenne</th>
                            <th>Appréciation</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${scientificSubjects.map(subject => {
                            const subjectGrades = grades[student.id]?.[subject.id] || {};
                            const note1 = subjectGrades.note1 || 0;
                            const note2 = subjectGrades.note2 || 0;
                            const avg = calculateSubjectAverage(subjectGrades);
                            const subjectMention = getMention(avg);
                            
                            return `
                                <tr class="category-scientific">
                                    <td><strong>${subject.name}</strong></td>
                                    <td>${subject.teacher || 'Non assigné'}</td>
                                    <td>${subject.coefficient}</td>
                                    <td>${note1 > 0 ? note1.toFixed(2) : '-'}</td>
                                    <td>${note2 > 0 ? note2.toFixed(2) : '-'}</td>
                                    <td><strong>${avg > 0 ? avg.toFixed(2) : '-'}</strong></td>
                                    <td>${subjectMention}</td>
                                </tr>
                            `;
                        }).join('')}
                    </tbody>
                </table>
                ` : ''}
                
                <!-- Matières Littéraires -->
                ${literarySubjects.length > 0 ? `
                <div class="category-header category-literary-header">
                    <i class="fas fa-book-reader"></i> MATIÈRES LITTÉRAIRES
                    <span class="success-rate ${getSuccessRateClass(literarySuccessRate)}">
                        ${literarySuccessRate.toFixed(0)}% de réussite
                    </span>
                </div>
                <table class="grades-table">
                    <thead>
                        <tr>
                            <th>DISCIPLINES</th>
                            <th>Professeur</th>
                            <th>Coeff.</th>
                            <th>Note 1</th>
                            <th>Note 2</th>
                            <th>Moyenne</th>
                            <th>Appréciation</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${literarySubjects.map(subject => {
                            const subjectGrades = grades[student.id]?.[subject.id] || {};
                            const note1 = subjectGrades.note1 || 0;
                            const note2 = subjectGrades.note2 || 0;
                            const avg = calculateSubjectAverage(subjectGrades);
                            const subjectMention = getMention(avg);
                            
                            return `
                                <tr class="category-literary">
                                    <td><strong>${subject.name}</strong></td>
                                    <td>${subject.teacher || 'Non assigné'}</td>
                                    <td>${subject.coefficient}</td>
                                    <td>${note1 > 0 ? note1.toFixed(2) : '-'}</td>
                                    <td>${note2 > 0 ? note2.toFixed(2) : '-'}</td>
                                    <td><strong>${avg > 0 ? avg.toFixed(2) : '-'}</strong></td>
                                    <td>${subjectMention}</td>
                                </tr>
                            `;
                        }).join('')}
                    </tbody>
                </table>
                ` : ''}
                
                <!-- Autres Matières -->
                ${otherSubjects.length > 0 ? `
                <div class="category-header category-other-header">
                    <i class="fas fa-running"></i> AUTRES MATIÈRES
                    <span class="success-rate ${getSuccessRateClass(otherSuccessRate)}">
                        ${otherSuccessRate.toFixed(0)}% de réussite
                    </span>
                </div>
                <table class="grades-table">
                    <thead>
                        <tr>
                            <th>DISCIPLINES</th>
                            <th>Professeur</th>
                            <th>Coeff.</th>
                            <th>Note 1</th>
                            <th>Note 2</th>
                            <th>Moyenne</th>
                            <th>Appréciation</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${otherSubjects.map(subject => {
                            const subjectGrades = grades[student.id]?.[subject.id] || {};
                            const note1 = subjectGrades.note1 || 0;
                            const note2 = subjectGrades.note2 || 0;
                            const avg = calculateSubjectAverage(subjectGrades);
                            const subjectMention = getMention(avg);
                            
                            return `
                                <tr class="category-other">
                                    <td><strong>${subject.name}</strong></td>
                                    <td>${subject.teacher || 'Non assigné'}</td>
                                    <td>${subject.coefficient}</td>
                                    <td>${note1 > 0 ? note1.toFixed(2) : '-'}</td>
                                    <td>${note2 > 0 ? note2.toFixed(2) : '-'}</td>
                                    <td><strong>${avg > 0 ? avg.toFixed(2) : '-'}</strong></td>
                                    <td>${subjectMention}</td>
                                </tr>
                            `;
                        }).join('')}
                    </tbody>
                </table>
                ` : ''}
                
                <!-- Résumé Général -->
                <table class="grades-table" style="margin-top: 20px;">
                    <tr style="background: linear-gradient(135deg, var(--primary-light), #e8f5e9); font-weight: bold;">
                        <td colspan="2"><strong>MOYENNE GÉNÉRALE</strong></td>
                        <td>${calculateTotalCoefficient()}</td>
                        <td colspan="2">Moyenne pondérée</td>
                        <td><strong style="font-size: 16px; color: var(--secondary-color);">${average.toFixed(2)}/20</strong></td>
                        <td><strong style="color: ${getMentionColor(mention)};">${mention}</strong></td>
                    </tr>
                </table>
                
                <div class="summary-section">
                    <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px; margin-bottom: 15px;">
                        <div style="text-align: center;">
                            <div style="font-size: 12px; color: #666;">Moyenne Générale</div>
                            <div style="font-size: 24px; font-weight: bold; color: var(--primary-color);">${average.toFixed(2)}</div>
                        </div>
                        <div style="text-align: center;">
                            <div style="font-size: 12px; color: #666;">Mention</div>
                            <div style="font-size: 18px; font-weight: bold; color: ${getMentionColor(mention)};">${mention}</div>
                        </div>
                        <div style="text-align: center;">
                            <div style="font-size: 12px; color: #666;">Rang</div>
                            <div style="font-size: 24px; font-weight: bold; color: var(--primary-color);">${rank}</div>
                        </div>
                    </div>
                    
                    <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 15px; margin-top: 15px;">
                        <div>
                            <h4 style="color: var(--primary-color); margin-bottom: 8px; font-size: 13px;">BILAN PÉDAGOGIQUE</h4>
                            <div>Moyenne min. classe: <strong>${document.getElementById('lowestAverage').textContent}</strong></div>
                            <div>Moyenne max. classe: <strong>${document.getElementById('highestAverage').textContent}</strong></div>
                            <div>Moyenne classe: <strong>${document.getElementById('classAverage').textContent}</strong></div>
                            <div>Taux de réussite: <strong>${document.getElementById('passRate').textContent}</strong></div>
                        </div>
                        <div>
                            <h4 style="color: var(--primary-color); margin-bottom: 8px; font-size: 13px;">DÉCISION DU CONSEIL</h4>
                            <div style="margin-bottom: 5px;">
                                <span style="display: inline-block; width: 12px; height: 12px; border: 2px solid #000; margin-right: 6px; vertical-align: middle; ${average >= currentSettings.passingGrade ? 'background: #000;' : ''}"></span>
                                Admis(e)
                            </div>
                            <div>
                                <span style="display: inline-block; width: 12px; height: 12px; border: 2px solid #000; margin-right: 6px; vertical-align: middle; ${average < currentSettings.passingGrade ? 'background: #000;' : ''}"></span>
                                Ajourné(e)
                            </div>
                        </div>
                    </div>
                </div>
                
                <div style="margin: 20px 0 15px 0; padding: 12px; background: #f8f9fa; border-radius: 5px; border-left: 4px solid var(--secondary-color);">
                    <h4 style="color: var(--primary-color); margin-bottom: 8px; font-size: 13px;">APPRÉCIATION GÉNÉRALE</h4>
                    <p style="font-size: 12px;">${getAppreciationText(average)}</p>
                </div>
                
                <div class="signatures-section">
                    <div class="signature-box">
                        <div>Le Directeur</div>
                        <div class="signature-line"></div>
                        <div style="font-size: 10px; color: #666; margin-top: 5px;">Nom, prénom et cachet</div>
                    </div>
                    <div class="signature-box">
                        <div>Le Professeur Principal</div>
                        <div class="signature-line"></div>
                        <div style="font-size: 10px; color: #666; margin-top: 5px;">Nom, prénom et signature</div>
                    </div>
                </div>
                
                <div class="footer-bulletin">
                    <p>Ce bulletin est établi conformément aux textes en vigueur de la République Togolaise</p>
                    <p>Conserver ce document pour toute réclamation - Tout bulletin falsifié est nul et non avenu</p>
                </div>
                
                ${currentSettings.showWatermark ? '<div class="watermark" id="watermarkElement">' + (document.getElementById('schoolName').value || 'ÉTABLISSEMENT').toUpperCase() + '</div>' : ''}
            `;
        }

        function calculateTotalCoefficient() {
            return subjects.reduce((total, subject) => total + subject.coefficient, 0);
        }

        function getAppreciationText(average) {
            if (average >= 18) return 'Élève excellent, travail remarquable. Continue sur cette lancée !';
            if (average >= 16) return 'Très bon travail, résultats excellents. Félicitations !';
            if (average >= 14) return 'Bon travail, résultats satisfaisants. Peut encore progresser.';
            if (average >= 12) return 'Résultats acceptables. Doit fournir plus d\'efforts.';
            if (average >= 10) return 'Résultats justes suffisants. Nécessite un travail plus régulier.';
            return 'Résultats insuffisants. Doit redoubler d\'efforts pour la prochaine période.';
        }

        function getStudentRank(studentId) {
            const studentAverages = students.map(student => ({
                id: student.id,
                average: calculateStudentAverage(student.id)
            }));
            
            studentAverages.sort((a, b) => b.average - a.average);
            
            const rank = studentAverages.findIndex(s => s.id === studentId) + 1;
            return rank > 0 ? `${rank}${getRankSuffix(rank)}/${students.length}` : '-';
        }

        function getRankSuffix(rank) {
            if (rank === 1) return 'er';
            return 'ème';
        }

        // FONCTIONS D'IMPRESSION AMÉLIORÉES

        // Impression d'un seul bulletin
        function printSingleBulletin() {
            if (!currentStudentForBulletin) {
                showNotification('Générez d\'abord un bulletin', 'warning');
                return;
            }
            
            const student = students.find(s => s.id === currentStudentForBulletin);
            if (!student) {
                showNotification('Élève non trouvé', 'danger');
                return;
            }
            
            const printContent = createBulletinHTML(student);
            printBulletinContent(printContent, `${student.lastName}_${student.firstName}_bulletin`);
        }

        // Impression de tous les bulletins
        function printAllBulletins() {
            if (students.length === 0) {
                showNotification('Aucun élève à imprimer', 'warning');
                return;
            }
            
            showNotification(`Préparation de l'impression de ${students.length} bulletins...`, 'info');
            
            // Créer le contenu pour tous les bulletins
            let allBulletinsHTML = '';
            students.forEach((student, index) => {
                allBulletinsHTML += `<div class="bulletin-togo ${currentSettings.showWatermark ? 'with-watermark' : ''}">${createBulletinHTML(student)}</div>`;
                if (index < students.length - 1) {
                    allBulletinsHTML += '<div style="page-break-before: always;"></div>';
                }
            });
            
            // Afficher dans le container d'impression multiple
            const container = document.getElementById('bulletinMultipleContainer');
            container.innerHTML = allBulletinsHTML;
            container.style.display = 'block';
            
            // Attendre un moment pour que le DOM se mette à jour
            setTimeout(() => {
                window.print();
                
                // Masquer le container après impression
                setTimeout(() => {
                    container.style.display = 'none';
                    container.innerHTML = '';
                    showNotification(`${students.length} bulletins imprimés avec succès`, 'success');
                }, 500);
            }, 500);
        }

        // Fonction générique d'impression
        function printBulletinContent(content, title = 'Bulletin Scolaire') {
            const originalContent = document.body.innerHTML;
            const originalTitle = document.title;
            
            document.title = `${title} - ${document.getElementById('schoolName').value || 'Établissement'}`;
            document.body.innerHTML = `
                <div class="bulletin-togo ${currentSettings.showWatermark ? 'with-watermark' : ''}">
                    ${content}
                </div>
                <style>
                    ${document.querySelector('style').textContent}
                </style>
            `;
            
            window.print();
            
            // Restaurer le contenu original
            document.body.innerHTML = originalContent;
            document.title = originalTitle;
            
            // Recharger les données
            loadAllData();
            switchTab(4);
        }

        // Impression du bulletin actuel
        function printBulletin() {
            const container = document.getElementById('bulletinPreview');
            if (!container || container.querySelector('.alert')) {
                showNotification('Générez d\'abord un bulletin', 'warning');
                return;
            }
            
            const content = container.innerHTML;
            const student = students.find(s => s.id === currentStudentForBulletin);
            const title = student ? `${student.lastName}_${student.firstName}_bulletin` : 'Bulletin';
            
            printBulletinContent(content, title);
        }

        // EXPORT PDF AMÉLIORÉ

        // Export PDF d'un seul bulletin
        async function exportPDF() {
            if (!currentStudentForBulletin) {
                showNotification('Générez d\'abord un bulletin', 'warning');
                return;
            }
            
            const student = students.find(s => s.id === currentStudentForBulletin);
            if (!student) {
                showNotification('Élève non trouvé', 'danger');
                return;
            }
            
            showNotification('Génération du PDF en cours...', 'info');
            
            try {
                const { jsPDF } = window.jspdf;
                const doc = new jsPDF({
                    orientation: 'portrait',
                    unit: 'mm',
                    format: 'a4'
                });
                
                const element = document.getElementById('bulletinPreview');
                const options = {
                    scale: 2,
                    useCORS: true,
                    logging: false,
                    backgroundColor: '#ffffff'
                };
                
                const canvas = await html2canvas(element, options);
                const imgData = canvas.toDataURL('image/png');
                
                const imgWidth = 210; // A4 width in mm
                const imgHeight = (canvas.height * imgWidth) / canvas.width;
                
                doc.addImage(imgData, 'PNG', 0, 0, imgWidth, imgHeight);
                
                const fileName = `bulletin_${student.lastName}_${student.firstName}_${new Date().toISOString().slice(0, 10)}.pdf`;
                doc.save(fileName);
                
                showNotification('PDF généré avec succès', 'success');
            } catch (error) {
                console.error('Erreur génération PDF:', error);
                showNotification('Erreur lors de la génération du PDF', 'danger');
            }
        }

        // Export PDF de tous les bulletins
        async function exportAllPDF() {
            if (students.length === 0) {
                showNotification('Aucun élève à exporter', 'warning');
                return;
            }
            
            showNotification(`Génération du PDF pour ${students.length} bulletins...`, 'info');
            
            try {
                const { jsPDF } = window.jspdf;
                const doc = new jsPDF({
                    orientation: 'portrait',
                    unit: 'mm',
                    format: 'a4'
                });
                
                // Créer un conteneur temporaire
                const tempContainer = document.createElement('div');
                tempContainer.style.position = 'absolute';
                tempContainer.style.left = '-9999px';
                tempContainer.style.width = '210mm';
                document.body.appendChild(tempContainer);
                
                for (let i = 0; i < students.length; i++) {
                    const student = students[i];
                    const bulletinHTML = createBulletinHTML(student);
                    
                    tempContainer.innerHTML = `<div class="bulletin-togo" style="width: 210mm;">${bulletinHTML}</div>`;
                    
                    const options = {
                        scale: 2,
                        useCORS: true,
                        logging: false,
                        backgroundColor: '#ffffff',
                        width: 794, // A4 width in pixels at 96 DPI
                        windowWidth: 794
                    };
                    
                    const canvas = await html2canvas(tempContainer.firstChild, options);
                    const imgData = canvas.toDataURL('image/png');
                    
                    const imgWidth = 210; // A4 width in mm
                    const imgHeight = (canvas.height * imgWidth) / canvas.width;
                    
                    if (i > 0) {
                        doc.addPage();
                    }
                    
                    doc.addImage(imgData, 'PNG', 0, 0, imgWidth, imgHeight);
                    
                    // Mise à jour de la progression
                    if (i % 5 === 0) {
                        showNotification(`Traitement ${i + 1}/${students.length}...`, 'info');
                    }
                }
                
                // Nettoyer
                document.body.removeChild(tempContainer);
                
                const fileName = `bulletins_classe_${new Date().toISOString().slice(0, 10)}.pdf`;
                doc.save(fileName);
                
                showNotification(`PDF de ${students.length} bulletins généré avec succès`, 'success');
            } catch (error) {
                console.error('Erreur génération PDF multiple:', error);
                showNotification('Erreur lors de la génération du PDF multiple', 'danger');
            }
        }

        // Fonction de test d'impression
        function testPrint() {
            const testHTML = `
                <div class="bulletin-togo">
                    <div class="bulletin-header">
                        <div class="republic-togo">TEST D'IMPRESSION</div>
                        <div class="title-togo">BULLETIN DE TEST</div>
                    </div>
                    <div class="school-info-bulletin">
                        <div><strong>Test réussi !</strong></div>
                        <div>L'impression fonctionne correctement</div>
                    </div>
                    <div class="footer-bulletin">
                        <p>Test d'impression - Système de Gestion Scolaire Togolais</p>
                    </div>
                </div>
            `;
            
            printBulletinContent(testHTML, 'Test Impression');
            showNotification('Test d\'impression effectué', 'success');
        }

        // Fonction pour sauvegarder le bulletin actuel
        function saveCurrentBulletin() {
            if (!currentStudentForBulletin) {
                showNotification('Aucun bulletin à sauvegarder. Générer d\'abord un bulletin.', 'warning');
                return;
            }
            
            const student = students.find(s => s.id === currentStudentForBulletin);
            if (!student) {
                showNotification('Élève non trouvé', 'danger');
                return;
            }
            
            const bulletinData = {
                id: Date.now().toString(),
                date: new Date().toISOString(),
                studentId: student.id,
                studentName: `${student.lastName} ${student.firstName}`,
                class: document.getElementById('class').value,
                schoolYear: document.getElementById('schoolYear').value,
                period: document.getElementById('period').value,
                average: calculateStudentAverage(student.id),
                mention: getMention(calculateStudentAverage(student.id)),
                rank: getStudentRank(student.id),
                data: {
                    student: student,
                    grades: grades[student.id] || {},
                    subjects: subjects
                }
            };
            
            // Add to archives
            archives.push(bulletinData);
            
            // Save data
            saveAllData();
            
            showNotification(`Bulletin de ${student.lastName} ${student.firstName} sauvegardé dans les archives`, 'success');
        }

        // Fonction pour générer tous les bulletins
        function generateAllBulletins() {
            if (students.length === 0) {
                showNotification('Aucun élève à traiter', 'warning');
                return;
            }
            
            // Save all bulletins to archives
            students.forEach(student => {
                const bulletinData = {
                    id: Date.now().toString() + student.id,
                    date: new Date().toISOString(),
                    studentId: student.id,
                    studentName: `${student.lastName} ${student.firstName}`,
                    class: document.getElementById('class').value,
                    schoolYear: document.getElementById('schoolYear').value,
                    period: document.getElementById('period').value,
                    average: calculateStudentAverage(student.id),
                    mention: getMention(calculateStudentAverage(student.id)),
                    rank: getStudentRank(student.id),
                    data: {
                        student: student,
                        grades: grades[student.id] || {},
                        subjects: subjects
                    }
                };
                
                // Check if already exists
                const existingIndex = archives.findIndex(a => a.studentId === student.id && 
                    a.class === bulletinData.class && 
                    a.schoolYear === bulletinData.schoolYear && 
                    a.period === bulletinData.period);
                
                if (existingIndex !== -1) {
                    archives[existingIndex] = bulletinData;
                } else {
                    archives.push(bulletinData);
                }
            });
            
            saveAllData();
            
            // Afficher le premier bulletin
            generateBulletin(students[0].id);
            document.getElementById('bulletinStudentSelect').value = students[0].id;
            
            showNotification(`${students.length} bulletins générés et sauvegardés`, 'success');
        }

        // Sauvegarder tous les rapports
        function saveAllReports() {
            if (students.length === 0) {
                showNotification('Aucun bulletin à enregistrer', 'warning');
                return;
            }
            
            // Save all current data as archive
            const archive = {
                id: Date.now().toString(),
                date: new Date().toISOString(),
                schoolYear: document.getElementById('schoolYear').value,
                period: document.getElementById('period').value,
                className: document.getElementById('class').value,
                studentCount: students.length,
                data: {
                    students: JSON.parse(JSON.stringify(students)),
                    subjects: JSON.parse(JSON.stringify(subjects)),
                    grades: JSON.parse(JSON.stringify(grades))
                }
            };
            
            // Check if similar archive exists
            const existingIndex = archives.findIndex(a => 
                a.className === archive.className && 
                a.schoolYear === archive.schoolYear && 
                a.period === archive.period
            );
            
            if (existingIndex !== -1) {
                archives[existingIndex] = archive;
            } else {
                archives.push(archive);
            }
            
            saveAllData();
            
            showNotification('Tous les bulletins enregistrés dans les archives', 'success');
        }

        // Archives management
        function loadArchives() {
            const container = document.getElementById('archivesList');
            if (!container) return;
            
            if (archives.length === 0) {
                container.innerHTML = `
                    <tr>
                        <td colspan="7" class="text-center">
                            <div class="alert alert-info">
                                <i class="fas fa-info-circle"></i>
                                Aucune archive disponible
                            </div>
                        </td>
                    </tr>
                `;
                return;
            }
            
            container.innerHTML = '';
            
            archives.slice().reverse().forEach(archive => {
                const date = new Date(archive.date);
                const formattedDate = date.toLocaleDateString('fr-FR');
                const studentName = archive.studentName || `${archive.data?.student?.lastName || ''} ${archive.data?.student?.firstName || ''}`;
                
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${formattedDate}</td>
                    <td>${studentName || archive.studentCount + ' élèves'}</td>
                    <td>${archive.className || archive.class || 'Non spécifié'}</td>
                    <td>${getPeriodText(archive.period)}</td>
                    <td>${archive.average ? archive.average.toFixed(2) : calculateArchiveAverage(archive).toFixed(2)}</td>
                    <td>${archive.rank || '-'}</td>
                    <td>
                        <button class="btn btn-sm btn-info" onclick="loadArchive('${archive.id}')">
                            <i class="fas fa-download"></i>
                        </button>
                        <button class="btn btn-sm btn-danger" onclick="deleteArchive('${archive.id}')">
                            <i class="fas fa-trash"></i>
                        </button>
                    </td>
                `;
                container.appendChild(row);
            });
            
            updateArchiveFilters();
        }

        function calculateArchiveAverage(archive) {
            // Calculate average from archive data
            if (!archive.data || !archive.data.students) return 0;
            
            let total = 0;
            let count = 0;
            
            archive.data.students.forEach(student => {
                const studentGrades = archive.data.grades[student.id];
                if (studentGrades) {
                    // Simplified average calculation
                    let studentTotal = 0;
                    let subjectCount = 0;
                    
                    Object.values(studentGrades).forEach(subjectGrades => {
                        const avg = calculateSubjectAverage(subjectGrades);
                        if (avg > 0) {
                            studentTotal += avg;
                            subjectCount++;
                        }
                    });
                    
                    if (subjectCount > 0) {
                        total += studentTotal / subjectCount;
                        count++;
                    }
                }
            });
            
            return count > 0 ? total / count : 0;
        }

        function getPeriodText(periodValue) {
            const periods = {
                '1': '1er Trimestre',
                '2': '2ème Trimestre',
                '3': '3ème Trimestre',
                '4': '1er Semestre',
                '5': '2ème Semestre'
            };
            return periods[periodValue] || periodValue;
        }

        function updateArchiveFilters() {
            // Update year filter
            const yearFilter = document.getElementById('archiveYear');
            const years = [...new Set(archives.map(a => a.schoolYear))];
            
            yearFilter.innerHTML = '<option value="">Toutes</option>';
            years.forEach(year => {
                const option = document.createElement('option');
                option.value = year;
                option.textContent = year;
                yearFilter.appendChild(option);
            });
            
            // Update class filter
            const classFilter = document.getElementById('archiveClass');
            const classes = [...new Set(archives.map(a => a.className || a.class))];
            
            classFilter.innerHTML = '<option value="">Toutes</option>';
            classes.forEach(className => {
                const option = document.createElement('option');
                option.value = className;
                option.textContent = className;
                classFilter.appendChild(option);
            });
        }

        function filterArchives() {
            const year = document.getElementById('archiveYear').value;
            const className = document.getElementById('archiveClass').value;
            const period = document.getElementById('archivePeriod').value;
            
            // Filter archives
            const filteredArchives = archives.filter(archive => {
                if (year && archive.schoolYear !== year) return false;
                if (className && (archive.className !== className && archive.class !== className)) return false;
                if (period && archive.period !== period) return false;
                return true;
            });
            
            // Update display
            const container = document.getElementById('archivesList');
            if (!container) return;
            
            container.innerHTML = '';
            
            filteredArchives.slice().reverse().forEach(archive => {
                const date = new Date(archive.date);
                const formattedDate = date.toLocaleDateString('fr-FR');
                const studentName = archive.studentName || `${archive.data?.student?.lastName || ''} ${archive.data?.student?.firstName || ''}`;
                
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${formattedDate}</td>
                    <td>${studentName || archive.studentCount + ' élèves'}</td>
                    <td>${archive.className || archive.class || 'Non spécifié'}</td>
                    <td>${getPeriodText(archive.period)}</td>
                    <td>${archive.average ? archive.average.toFixed(2) : calculateArchiveAverage(archive).toFixed(2)}</td>
                    <td>${archive.rank || '-'}</td>
                    <td>
                        <button class="btn btn-sm btn-info" onclick="loadArchive('${archive.id}')">
                            <i class="fas fa-download"></i>
                        </button>
                        <button class="btn btn-sm btn-danger" onclick="deleteArchive('${archive.id}')">
                            <i class="fas fa-trash"></i>
                        </button>
                    </td>
                `;
                container.appendChild(row);
            });
        }

        function loadArchive(archiveId) {
            const archive = archives.find(a => a.id === archiveId);
            if (!archive) {
                showNotification('Archive non trouvée', 'danger');
                return;
            }
            
            if (confirm('Charger cette archive ? Les données actuelles seront remplacées.')) {
                // Load data from archive
                if (archive.data) {
                    students = archive.data.students || [];
                    subjects = archive.data.subjects || [];
                    grades = archive.data.grades || {};
                }
                
                // Update form fields
                document.getElementById('schoolYear').value = archive.schoolYear || '';
                document.getElementById('period').value = archive.period || '';
                document.getElementById('class').value = archive.className || archive.class || '';
                
                // Update UI
                updateStudentList();
                updateSubjectsList();
                updateStudentSelect();
                updateBulletinStudentSelect();
                updateSubjectFilter();
                calculateStatistics();
                updateRanking();
                
                showNotification('Archive chargée avec succès', 'success');
                switchTab(0); // Go to class management tab
            }
        }

        function deleteArchive(archiveId) {
            if (!confirm('Supprimer cette archive ? Cette action est irréversible.')) return;
            
            archives = archives.filter(a => a.id !== archiveId);
            loadArchives();
            saveAllData();
            
            showNotification('Archive supprimée', 'success');
        }

        // Settings management
        function updatePassingGrade() {
            const passingGrade = parseFloat(document.getElementById('passingGrade').value);
            if (!isNaN(passingGrade) && passingGrade >= 0 && passingGrade <= 20) {
                currentSettings.passingGrade = passingGrade;
                saveAllData();
                calculateStatistics();
                showNotification('Seuil de réussite mis à jour', 'success');
            }
        }

        function updateRoundingPrecision() {
            const precision = parseInt(document.getElementById('roundingPrecision').value);
            if ([0, 1, 2].includes(precision)) {
                currentSettings.roundingPrecision = precision;
                saveAllData();
                showNotification('Précision d\'arrondi mise à jour', 'success');
            }
        }

        function updateSystemInfo() {
            document.getElementById('systemStudentCount').value = students.length;
            
            // Get last backup time
            const lastBackup = localStorage.getItem('lastBackupTime');
            document.getElementById('lastBackup').value = lastBackup ? 
                new Date(lastBackup).toLocaleString('fr-FR') : 'Jamais';
        }

        // Data management
        function saveAllData() {
            try {
                const data = {
                    students: JSON.parse(JSON.stringify(students)),
                    subjects: JSON.parse(JSON.stringify(subjects)),
                    grades: JSON.parse(JSON.stringify(grades)),
                    archives: JSON.parse(JSON.stringify(archives)),
                    settings: JSON.parse(JSON.stringify(currentSettings)),
                    classInfo: {
                        level: document.getElementById('level').value,
                        class: document.getElementById('class').value,
                        series: document.getElementById('series').value,
                        schoolYear: document.getElementById('schoolYear').value,
                        period: document.getElementById('period').value,
                        schoolName: document.getElementById('schoolName').value,
                        schoolCode: document.getElementById('schoolCode').value,
                        regionalDirection: document.getElementById('regionalDirection').value,
                        inspection: document.getElementById('inspection').value,
                        city: document.getElementById('city').value,
                        schoolStatus: document.getElementById('schoolStatus').value
                    },
                    timestamp: new Date().toISOString(),
                    version: '3.0'
                };
                
                localStorage.setItem('schoolManagementData', JSON.stringify(data));
                localStorage.setItem('lastBackupTime', new Date().toISOString());
                
                // Update counters
                updateCounters();
                
                // Update watermark toggle
                document.getElementById('watermarkToggle').checked = currentSettings.showWatermark;
                
                // Update watermark
                updateWatermark();
                
                return true;
            } catch (error) {
                console.error('Erreur lors de la sauvegarde:', error);
                showNotification('Erreur lors de la sauvegarde des données', 'danger');
                return false;
            }
        }

        function loadAllData() {
            const savedData = localStorage.getItem('schoolManagementData');
            if (savedData) {
                try {
                    const data = JSON.parse(savedData);
                    
                    students = data.students || [];
                    subjects = data.subjects || [];
                    grades = data.grades || {};
                    archives = data.archives || [];
                    currentSettings = data.settings || currentSettings;
                    
                    // Restore form values
                    if (data.classInfo) {
                        document.getElementById('level').value = data.classInfo.level || '';
                        document.getElementById('class').value = data.classInfo.class || '';
                        document.getElementById('series').value = data.classInfo.series || '';
                        document.getElementById('schoolYear').value = data.classInfo.schoolYear || '';
                        document.getElementById('period').value = data.classInfo.period || '';
                        document.getElementById('schoolName').value = data.classInfo.schoolName || '';
                        document.getElementById('schoolCode').value = data.classInfo.schoolCode || '';
                        document.getElementById('regionalDirection').value = data.classInfo.regionalDirection || 'DRE-KARA';
                        document.getElementById('inspection').value = data.classInfo.inspection || 'IESG-Niamtougou';
                        document.getElementById('city').value = data.classInfo.city || 'KARA';
                        document.getElementById('schoolStatus').value = data.classInfo.schoolStatus || 'Public';
                    }
                    
                    // Restore settings
                    document.getElementById('passingGrade').value = currentSettings.passingGrade;
                    document.getElementById('roundingPrecision').value = currentSettings.roundingPrecision;
                    document.getElementById('watermarkToggle').checked = currentSettings.showWatermark !== false;
                    
                    // Update UI
                    updateStudentList();
                    updateSubjectsList();
                    updateStudentSelect();
                    updateBulletinStudentSelect();
                    updateSubjectFilter();
                    updateClassStats();
                    
                    // Update bulletin display
                    const bulletinContainer = document.getElementById('bulletinPreview');
                    if (currentSettings.showWatermark) {
                        bulletinContainer.classList.add('with-watermark');
                    } else {
                        bulletinContainer.classList.remove('with-watermark');
                    }
                    
                    return true;
                    
                } catch (error) {
                    console.error('Error loading data:', error);
                    showNotification('Erreur lors du chargement des données. Réinitialisation des données.', 'danger');
                    clearData();
                    return false;
                }
            }
            return false;
        }

        function backupData() {
            if (saveAllData()) {
                const data = localStorage.getItem('schoolManagementData');
                const blob = new Blob([data], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `sauvegarde-scolaire-togo-${new Date().toISOString().slice(0, 10)}.json`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
                
                showNotification('Sauvegarde créée avec succès', 'success');
            }
        }

        function loadBackup() {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = '.json';
            
            input.onchange = function(e) {
                const file = e.target.files[0];
                if (!file) return;
                
                const reader = new FileReader();
                
                reader.onload = function(e) {
                    try {
                        const data = JSON.parse(e.target.result);
                        localStorage.setItem('schoolManagementData', JSON.stringify(data));
                        loadAllData();
                        showNotification('Sauvegarde restaurée avec succès', 'success');
                    } catch (error) {
                        showNotification('Fichier invalide ou corrompu', 'danger');
                    }
                };
                
                reader.onerror = function() {
                    showNotification('Erreur de lecture du fichier', 'danger');
                };
                
                reader.readAsText(file);
            };
            
            input.click();
        }

        function clearData() {
            if (confirm('Voulez-vous vraiment réinitialiser toutes les données ? Cette action est irréversible.')) {
                students = [];
                subjects = [];
                grades = {};
                archives = [];
                currentSettings = {
                    passingGrade: 10,
                    roundingPrecision: 1,
                    showWatermark: true
                };
                
                // Reset form
                document.getElementById('schoolYear').value = `${new Date().getFullYear()}-${new Date().getFullYear() + 1}`;
                document.getElementById('period').value = '';
                document.getElementById('schoolName').value = '';
                document.getElementById('schoolCode').value = '';
                document.getElementById('level').value = '';
                document.getElementById('class').value = '';
                document.getElementById('series').value = '';
                document.getElementById('regionalDirection').value = 'DRE-KARA';
                document.getElementById('inspection').value = 'IESG-Niamtougou';
                document.getElementById('city').value = 'KARA';
                document.getElementById('schoolStatus').value = 'Public';
                
                // Clear student form
                document.getElementById('studentLastName').value = '';
                document.getElementById('studentFirstName').value = '';
                document.getElementById('studentId').value = '';
                document.getElementById('studentGender').value = '';
                document.getElementById('studentBirthDate').value = '';
                document.getElementById('studentBirthPlace').value = '';
                document.getElementById('studentStatus').value = 'Nouveau';
                document.getElementById('guardianName').value = '';
                document.getElementById('guardianPhone').value = '';
                
                // Reset settings
                document.getElementById('watermarkToggle').checked = true;
                
                updateStudentList();
                updateSubjectsList();
                updateCounters();
                updateStudentSelect();
                updateBulletinStudentSelect();
                resetStatistics();
                
                // Clear localStorage
                localStorage.removeItem('schoolManagementData');
                
                showNotification('Données réinitialisées', 'info');
            }
        }

        function exportData() {
            // Create Excel-like data
            let csvContent = "data:text/csv;charset=utf-8,";
            
            // Add headers
            csvContent += "Nom,Prénom,Matricule,Classe,Moyenne,Mention\n";
            
            // Add student data
            students.forEach(student => {
                const average = calculateStudentAverage(student.id);
                const mention = getMention(average);
                csvContent += `${student.lastName},${student.firstName},${student.studentId},${student.class},${average.toFixed(2)},${mention}\n`;
            });
            
            // Create download link
            const encodedUri = encodeURI(csvContent);
            const link = document.createElement("a");
            link.setAttribute("href", encodedUri);
            link.setAttribute("download", `eleves_togo_${new Date().toISOString().slice(0, 10)}.csv`);
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            
            showNotification('Données exportées en CSV', 'success');
        }

        function importStudents() {
            // Create file input for CSV import
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = '.csv,.txt';
            
            input.onchange = function(e) {
                const file = e.target.files[0];
                if (!file) return;
                
                const reader = new FileReader();
                
                reader.onload = function(e) {
                    try {
                        const csvData = e.target.result;
                        const lines = csvData.split('\n');
                        
                        // Skip header line
                        for (let i = 1; i < lines.length; i++) {
                            const line = lines[i].trim();
                            if (!line) continue;
                            
                            const columns = line.split(',');
                            if (columns.length >= 2) {
                                const student = {
                                    id: Date.now().toString() + i,
                                    lastName: columns[0].trim(),
                                    firstName: columns[1].trim(),
                                    studentId: columns[2] ? columns[2].trim() : `MAT-${Date.now().toString().slice(-6)}`,
                                    gender: columns[3] ? columns[3].trim() : 'M',
                                    birthDate: '',
                                    birthPlace: '',
                                    status: 'Nouveau',
                                    guardianName: '',
                                    guardianPhone: '',
                                    class: document.getElementById('class').value || 'Non spécifié',
                                    createdAt: new Date().toISOString()
                                };
                                
                                students.push(student);
                                grades[student.id] = {};
                            }
                        }
                        
                        updateStudentList();
                        updateCounters();
                        updateStudentSelect();
                        updateBulletinStudentSelect();
                        saveAllData();
                        
                        showNotification(`${students.length} élèves importés avec succès`, 'success');
                        
                    } catch (error) {
                        showNotification('Erreur lors de l\'importation du fichier CSV', 'danger');
                    }
                };
                
                reader.onerror = function() {
                    showNotification('Erreur de lecture du fichier', 'danger');
                };
                
                reader.readAsText(file);
            };
            
            input.click();
        }

        // Utility functions
        function updateCounters() {
            document.getElementById('studentCount').textContent = students.length;
            document.getElementById('subjectCount').textContent = subjects.length;
            updateClassStats();
        }

        function updateClassStats() {
            document.getElementById('classSize').value = students.length;
            
            const girlsCount = students.filter(s => s.gender === 'F').length;
            const boysCount = students.filter(s => s.gender === 'M').length;
            
            document.getElementById('girlsCount').value = girlsCount;
            document.getElementById('boysCount').value = boysCount;
        }

        function formatDate(dateString) {
            if (!dateString) return '';
            const date = new Date(dateString);
            return date.toLocaleDateString('fr-FR');
        }

        function showNotification(message, type = 'info') {
            // Remove existing notifications
            document.querySelectorAll('.notification').forEach(n => n.remove());
            
            // Create notification element
            const notification = document.createElement('div');
            notification.className = `notification alert alert-${type}`;
            notification.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                z-index: 10000;
                min-width: 300px;
                animation: slideIn 0.3s ease;
                border-left: 4px solid ${type === 'success' ? 'var(--success-color)' : type === 'danger' ? 'var(--secondary-color)' : type === 'warning' ? 'var(--tertiary-color)' : 'var(--info-color)'};
            `;
            
            const icon = type === 'success' ? 'check-circle' : 
                        type === 'danger' ? 'exclamation-circle' : 
                        type === 'warning' ? 'exclamation-triangle' : 'info-circle';
            
            notification.innerHTML = `
                <div style="display: flex; align-items: center; gap: 10px;">
                    <i class="fas fa-${icon}"></i>
                    <span>${message}</span>
                </div>
            `;
            
            // Add to body
            document.body.appendChild(notification);
            
            // Add CSS animation
            if (!document.querySelector('#notification-style')) {
                const style = document.createElement('style');
                style.id = 'notification-style';
                style.textContent = `
                    @keyframes slideIn {
                        from { transform: translateX(100%); opacity: 0; }
                        to { transform: translateX(0); opacity: 1; }
                    }
                    @keyframes slideOut {
                        from { transform: translateX(0); opacity: 1; }
                        to { transform: translateX(100%); opacity: 0; }
                    }
                `;
                document.head.appendChild(style);
            }
            
            // Remove after 5 seconds
            setTimeout(() => {
                if (notification.parentNode) {
                    notification.style.animation = 'slideOut 0.3s ease';
                    setTimeout(() => notification.remove(), 300);
                }
            }, 5000);
        }

        function toggleDarkMode() {
            document.body.classList.toggle('dark-mode');
            const button = document.querySelector('.btn-secondary');
            if (button) {
                if (document.body.classList.contains('dark-mode')) {
                    button.innerHTML = '<i class="fas fa-sun"></i> Mode Clair';
                    showNotification('Mode sombre activé', 'info');
                } else {
                    button.innerHTML = '<i class="fas fa-moon"></i> Mode Sombre';
                    showNotification('Mode clair activé', 'info');
                }
            }
        }

        function showHelp() {
            document.getElementById('helpModal').classList.add('show');
        }

        function closeModal(modalId) {
            document.getElementById(modalId).classList.remove('show');
        }

        // Close modals when clicking outside
        window.addEventListener('click', function(event) {
            if (event.target.classList.contains('modal')) {
                event.target.classList.remove('show');
            }
        });

        // Auto-save every minute
        setInterval(saveAllData, 60000);
    </script>
</body>
</html>
