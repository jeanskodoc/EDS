<!DOCTYPE html>
<html lang="fr">
     <style>
  .btn-retour {
    padding: 8px 16px;
    background-color: #f0f0f0;
    border: 1px solid #ccc;
    border-radius: 4px;
    cursor: pointer;
    font-size: 14px;
  }
  .btn-retour:hover {
    background-color: #e0e0e0;
  }
</style>

<button class="btn-retour" onclick="history.back()">← Retour</button>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gestion Emploi du Temps - Lycée Niamtougou</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
            line-height: 1.6;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
        }
        .header {
            text-align: center;
            margin-bottom: 20px;
        }
        .form-container {
            background: #f4f4f4;
            padding: 20px;
            border-radius: 5px;
            margin-bottom: 30px;
        }
        .form-group {
            margin-bottom: 15px;
        }
        label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
        }
        input, select {
            width: 100%;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            box-sizing: border-box;
        }
        button {
            background: #4CAF50;
            color: white;
            padding: 10px 15px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
            margin-right: 10px;
        }
        button:hover {
            background: #45a049;
        }
        .timetable {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }
        .timetable th, .timetable td {
            border: 1px solid #ddd;
            padding: 8px;
            text-align: center;
        }
        .timetable th {
            background-color: #f2f2f2;
            font-weight: bold;
        }
        .time-col {
            width: 100px;
            background-color: #f9f9f9;
        }
        .teacher-name {
            margin-top: 30px;
            font-weight: bold;
            text-align: right;
        }
        .break {
            background-color: #f0f0f0;
        }
        .hidden {
            display: none;
        }
        .tabs {
            display: flex;
            margin-bottom: 20px;
        }
        .tab {
            padding: 10px 20px;
            cursor: pointer;
            background: #ddd;
            margin-right: 5px;
            border-radius: 5px 5px 0 0;
        }
        .tab.active {
            background: #4CAF50;
            color: white;
        }
        .tab-content {
            display: none;
        }
        .tab-content.active {
            display: block;
        }
        .filters {
            display: flex;
            gap: 20px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }
        .filter-group {
            min-width: 200px;
        }
        .course-info {
            font-size: 12px;
            color: #555;
        }
        .cycle-college {
            background-color: #e6f7ff;
        }
        .cycle-lycee {
            background-color: #fff7e6;
        }
        .multi-select-container {
            margin-bottom: 15px;
        }
        .multi-select-options {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-top: 5px;
        }
        .multi-select-option {
            background: #e9e9e9;
            padding: 5px 10px;
            border-radius: 4px;
            cursor: pointer;
        }
        .multi-select-option.selected {
            background: #4CAF50;
            color: white;
        }
        .selected-items {
            margin-top: 5px;
            font-size: 14px;
            color: #555;
        }
        .time-slot-group {
            margin-bottom: 15px;
            border: 1px solid #ddd;
            padding: 10px;
            border-radius: 4px;
        }
        .time-slot-group h4 {
            margin-top: 0;
            margin-bottom: 10px;
        }
        .add-more-btn {
            background: #2196F3;
            margin-bottom: 15px;
        }
        .remove-btn {
            background: #f44336;
        }
        .data-actions {
            margin: 20px 0;
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }
        .export-btn {
            background: #2196F3;
        }
        .import-btn {
            background: #FF9800;
        }
        .delete-btn {
            background: #f44336;
        }
        .print-btn {
            background: #607d8b;
        }
        #fileInput {
            display: none;
        }
        .volume-table {
            width: auto;
            margin: 20px 0;
            border-collapse: collapse;
        }
        .volume-table caption {
            font-weight: bold;
            margin-bottom: 10px;
            text-align: left;
        }
        .volume-table th, .volume-table td {
            border: 1px solid #ddd;
            padding: 8px;
            text-align: left;
        }
        .volume-table th {
            background-color: #f2f2f2;
        }
        .total-row {
            font-weight: bold;
            background-color: #f9f9f9;
        }
        .total-volume {
            margin: 20px 0;
            padding: 10px;
            background-color: #f4f4f4;
            border-radius: 4px;
        }
        #timeVolumesContainer {
            margin-top: 30px;
        }
        .volumes-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }
        
        @media print {
            body * {
                visibility: hidden;
            }
            #timetable-tab, #timetable-tab * {
                visibility: visible;
            }
            #timetable-tab {
                position: absolute;
                left: 0;
                top: 0;
                width: 100%;
            }
            .no-print {
                display: none !important;
            }
            .tabs, .filters, .data-actions {
                display: none;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h2>LYCÉE NIAMTOUGOU</h2>
            <h3>IESG NIAMTOUGOU</h3>
            <h4>DRE- KARA</h4>
        </div>

        <div class="tabs">
            <div class="tab active" onclick="switchTab('form')">Saisie des données</div>
            <div class="tab" onclick="switchTab('timetable')">Visualisation</div>
            <div class="tab" onclick="switchTab('all-data')">Toutes les données</div>
        </div>

        <div id="form-tab" class="tab-content active">
            <div class="form-container">
                <form id="courseForm">
                    <div class="form-group">
                        <label for="teacherName">Nom de l'enseignant:</label>
                        <input type="text" id="teacherName" required>
                    </div>
                    
                    <div class="form-group">
                        <label>Classes/Niveaux:</label>
                        <div class="multi-select-container">
                            <div class="multi-select-options" id="classOptions">
                                <!-- Les options seront ajoutées dynamiquement -->
                            </div>
                            <div class="selected-items" id="selectedClasses">Aucune classe sélectionnée</div>
                            <input type="text" id="newClass" placeholder="Ajouter une nouvelle classe">
                            <button type="button" onclick="addNewClass()">Ajouter</button>
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label for="cycle">Cycle:</label>
                        <select id="cycle" required>
                            <option value="">Sélectionner un cycle</option>
                            <option value="Collège">Collège</option>
                            <option value="Lycée">Lycée</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label>Matières:</label>
                        <div class="multi-select-container">
                            <div class="multi-select-options" id="subjectOptions">
                                <!-- Les options seront ajoutées dynamiquement -->
                            </div>
                            <div class="selected-items" id="selectedSubjects">Aucune matière sélectionnée</div>
                            <input type="text" id="newSubject" placeholder="Ajouter une nouvelle matière">
                            <button type="button" onclick="addNewSubject()">Ajouter</button>
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label>Jours:</label>
                        <div class="multi-select-container">
                            <div class="multi-select-options" id="dayOptions">
                                <div class="multi-select-option" data-value="Lundi">Lundi</div>
                                <div class="multi-select-option" data-value="Mardi">Mardi</div>
                                <div class="multi-select-option" data-value="Mercredi">Mercredi</div>
                                <div class="multi-select-option" data-value="Jeudi">Jeudi</div>
                                <div class="multi-select-option" data-value="Vendredi">Vendredi</div>
                            </div>
                            <div class="selected-items" id="selectedDays">Aucun jour sélectionné</div>
                        </div>
                    </div>
                    
                    <div id="timeSlotGroups">
                        <div class="time-slot-group">
                            <h4>Créneau horaire 1</h4>
                            <div class="form-group">
                                <label for="timeSlot1">Créneau horaire:</label>
                                <select class="time-slot" required>
                                    <option value="">Sélectionner un créneau</option>
                                    <option value="07:00 - 07:55">07:00 - 07:55</option>
                                    <option value="07:55 - 08:50">07:55 - 08:50</option>
                                    <option value="08:50 - 09:45">08:50 - 09:45</option>
                                    <option value="09:45 - 10:10">09:45 - 10:10 (Pause)</option>
                                    <option value="10:10 - 11:05">10:10 - 11:05</option>
                                    <option value="11:05 - 12:00">11:05 - 12:00</option>
                                    <option value="14:30 - 15:30">14:30 - 15:30</option>
                                    <option value="15:30 - 16:30">15:30 - 16:30</option>
                                    <option value="16:30 - 17:30">16:30 - 17:30</option>
                                </select>
                            </div>
                            <button type="button" class="remove-btn" onclick="removeTimeSlotGroup(this)" style="display: none;">Supprimer ce créneau</button>
                        </div>
                    </div>
                    <button type="button" class="add-more-btn" onclick="addTimeSlotGroup()">Ajouter un autre créneau</button>
                    
                    <button type="submit">Enregistrer</button>
                    <button type="button" onclick="clearForm()">Effacer</button>
                </form>
            </div>
        </div>

        <div id="timetable-tab" class="tab-content">
            <div class="data-actions no-print">
                <button class="export-btn" onclick="exportData()">Exporter les données</button>
                <button class="import-btn" onclick="document.getElementById('fileInput').click()">Importer des données</button>
                <input type="file" id="fileInput" accept=".json" onchange="importData(this)">
                <button class="delete-btn" onclick="clearAllData()">Supprimer toutes les données</button>
                <button class="print-btn" onclick="window.print()">Imprimer</button>
            </div>
            
            <div class="filters no-print">
                <div class="filter-group">
                    <label for="selectTeacher">Enseignant:</label>
                    <select id="selectTeacher" onchange="generateTimetable()">
                        <option value="">-- Tous --</option>
                    </select>
                </div>
                
                <div class="filter-group">
                    <label for="selectCycle">Cycle:</label>
                    <select id="selectCycle" onchange="generateTimetable()">
                        <option value="">-- Tous --</option>
                        <option value="Collège">Collège</option>
                        <option value="Lycée">Lycée</option>
                    </select>
                </div>
                
                <div class="filter-group">
                    <label for="selectClass">Classe:</label>
                    <select id="selectClass" onchange="generateTimetable()">
                        <option value="">-- Toutes --</option>
                    </select>
                </div>
            </div>
            
            <div id="timetableContainer">
                <table class="timetable" id="timetable">
                    <thead>
                        <tr>
                            <th></th>
                            <th>Lundi</th>
                            <th>Mardi</th>
                            <th>Mercredi</th>
                            <th>Jeudi</th>
                            <th>Vendredi</th>
                        </tr>
                    </thead>
                    <tbody id="timetableBody">
                        <!-- Les créneaux horaires seront générés ici par JavaScript -->
                    </tbody>
                </table>

                <div class="teacher-name" id="displayTeacherName"></div>
                <div id="timeVolumesContainer"></div>
            </div>
        </div>

        <div id="all-data-tab" class="tab-content">
            <div class="data-actions">
                <button class="export-btn" onclick="exportData()">Exporter les données</button>
                <button class="import-btn" onclick="document.getElementById('fileInput').click()">Importer des données</button>
                <input type="file" id="fileInput" accept=".json" onchange="importData(this)">
                <button class="delete-btn" onclick="clearAllData()">Supprimer toutes les données</button>
            </div>
            
            <div class="filters">
                <div class="filter-group">
                    <label for="filterTeacher">Filtrer par enseignant:</label>
                    <select id="filterTeacher" onchange="displayAllData()">
                        <option value="">-- Tous --</option>
                    </select>
                </div>
                
                <div class="filter-group">
                    <label for="filterCycle">Filtrer par cycle:</label>
                    <select id="filterCycle" onchange="displayAllData()">
                        <option value="">-- Tous --</option>
                        <option value="Collège">Collège</option>
                        <option value="Lycée">Lycée</option>
                    </select>
                </div>
            </div>
            
            <h3>Tous les cours enregistrés</h3>
            <table class="timetable">
                <thead>
                    <tr>
                        <th>Enseignant</th>
                        <th>Classe</th>
                        <th>Cycle</th>
                        <th>Matière</th>
                        <th>Jour</th>
                        <th>Créneau</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody id="allDataBody">
                    <!-- Toutes les données seront affichées ici -->
                </tbody>
            </table>
        </div>
    </div>

    <script>
        // Données des créneaux horaires
        const timeSlots = [
            "07:00 - 07:55",
            "07:55 - 08:50",
            "08:50 - 09:45",
            "09:45 - 10:10",
            "10:10 - 11:05",
            "11:05 - 12:00",
            "14:30 - 15:30",
            "15:30 - 16:30",
            "16:30 - 17:30"
        ];

        // Données initiales pour les classes et matières
        let allClasses = ["6ème", "5ème", "4ème", "3ème", "2nde", "1ère", "Tle"];
        let allSubjects = ["Maths", "Français", "Anglais", "Physique", "Chimie", "SVT", "Histoire", "Géographie", "Philosophie"];

        document.addEventListener('DOMContentLoaded', function() {
            // Initialiser les options de sélection multiple
            initMultiSelectOptions();
            
            // Charger les données existantes
            loadCourses();
            
            // Gérer la soumission du formulaire
            document.getElementById('courseForm').addEventListener('submit', function(e) {
                e.preventDefault();
                
                const teacherName = document.getElementById('teacherName').value;
                const selectedClasses = getSelectedItems('classOptions');
                const cycle = document.getElementById('cycle').value;
                const selectedSubjects = getSelectedItems('subjectOptions');
                const selectedDays = getSelectedItems('dayOptions');
                const timeSlotGroups = document.querySelectorAll('.time-slot-group');
                
                if (selectedClasses.length === 0 || selectedDays.length === 0 || selectedSubjects.length === 0) {
                    alert("Veuillez sélectionner au moins une classe, une matière et un jour");
                    return;
                }
                
                // Vérifier que chaque groupe de créneau a une sélection valide
                let hasValidTimeSlot = false;
                timeSlotGroups.forEach(group => {
                    const timeSlotSelect = group.querySelector('.time-slot');
                    if (timeSlotSelect.value) {
                        hasValidTimeSlot = true;
                    }
                });
                
                if (!hasValidTimeSlot) {
                    alert("Veuillez sélectionner au moins un créneau horaire valide");
                    return;
                }
                
                // Créer un objet cours pour chaque combinaison
                timeSlotGroups.forEach(group => {
                    const timeSlotSelect = group.querySelector('.time-slot');
                    const timeSlot = timeSlotSelect.value;
                    
                    if (!timeSlot) return; // Ignorer les créneaux non sélectionnés
                    
                    selectedDays.forEach(day => {
                        selectedClasses.forEach(className => {
                            selectedSubjects.forEach(subject => {
                                // Créer un objet cours
                                const course = {
                                    id: Date.now() + Math.floor(Math.random() * 1000), // ID unique
                                    teacherName,
                                    className,
                                    cycle,
                                    subject,
                                    day,
                                    timeSlot
                                };
                                
                                // Enregistrer dans le localStorage
                                saveCourse(course);
                            });
                        });
                    });
                });
                
                // Mettre à jour les listes et affichages
                updateFilters();
                generateTimetable();
                displayAllData();
                
                // Réinitialiser le formulaire
                clearForm();
                
                alert("Cours enregistrés avec succès!");
            });
        });
        
        function initMultiSelectOptions() {
            // Initialiser les options pour les classes
            const classOptions = document.getElementById('classOptions');
            allClasses.forEach(cls => {
                const option = document.createElement('div');
                option.className = 'multi-select-option';
                option.textContent = cls;
                option.dataset.value = cls;
                option.onclick = function() { toggleSelection(this, 'selectedClasses'); };
                classOptions.appendChild(option);
            });
            
            // Initialiser les options pour les matières
            const subjectOptions = document.getElementById('subjectOptions');
            allSubjects.forEach(subject => {
                const option = document.createElement('div');
                option.className = 'multi-select-option';
                option.textContent = subject;
                option.dataset.value = subject;
                option.onclick = function() { toggleSelection(this, 'selectedSubjects'); };
                subjectOptions.appendChild(option);
            });
            
            // Initialiser les options pour les jours
            const dayOptions = document.getElementById('dayOptions');
            Array.from(dayOptions.children).forEach(option => {
                option.onclick = function() { toggleSelection(this, 'selectedDays'); };
            });
        }
        
        function toggleSelection(element, selectedItemsId) {
            element.classList.toggle('selected');
            updateSelectedItemsDisplay(selectedItemsId);
        }
        
        function getSelectedItems(optionsContainerId) {
            const options = document.getElementById(optionsContainerId).querySelectorAll('.selected');
            return Array.from(options).map(opt => opt.dataset.value);
        }
        
        function updateSelectedItemsDisplay(selectedItemsId) {
            const selectedItems = getSelectedItems(selectedItemsId.replace('selected', '').replace('s', '') + 'Options');
            const displayElement = document.getElementById(selectedItemsId);
            
            if (selectedItems.length === 0) {
                displayElement.textContent = selectedItemsId.includes('Classes') ? 'Aucune classe sélectionnée' : 
                                           selectedItemsId.includes('Subjects') ? 'Aucune matière sélectionnée' : 
                                           'Aucun jour sélectionné';
            } else {
                displayElement.textContent = selectedItems.join(', ');
            }
        }
        
        function addNewClass() {
            const newClassInput = document.getElementById('newClass');
            const newClassName = newClassInput.value.trim();
            
            if (newClassName && !allClasses.includes(newClassName)) {
                allClasses.push(newClassName);
                
                const classOptions = document.getElementById('classOptions');
                const option = document.createElement('div');
                option.className = 'multi-select-option';
                option.textContent = newClassName;
                option.dataset.value = newClassName;
                option.onclick = function() { toggleSelection(this, 'selectedClasses'); };
                classOptions.appendChild(option);
                
                newClassInput.value = '';
            }
        }
        
        function addNewSubject() {
            const newSubjectInput = document.getElementById('newSubject');
            const newSubjectName = newSubjectInput.value.trim();
            
            if (newSubjectName && !allSubjects.includes(newSubjectName)) {
                allSubjects.push(newSubjectName);
                
                const subjectOptions = document.getElementById('subjectOptions');
                const option = document.createElement('div');
                option.className = 'multi-select-option';
                option.textContent = newSubjectName;
                option.dataset.value = newSubjectName;
                option.onclick = function() { toggleSelection(this, 'selectedSubjects'); };
                subjectOptions.appendChild(option);
                
                newSubjectInput.value = '';
            }
        }
        
        function addTimeSlotGroup() {
            const timeSlotGroups = document.getElementById('timeSlotGroups');
            const groupCount = timeSlotGroups.querySelectorAll('.time-slot-group').length + 1;
            
            const newGroup = document.createElement('div');
            newGroup.className = 'time-slot-group';
            newGroup.innerHTML = `
                <h4>Créneau horaire ${groupCount}</h4>
                <div class="form-group">
                    <label for="timeSlot${groupCount}">Créneau horaire:</label>
                    <select class="time-slot" required>
                        <option value="">Sélectionner un créneau</option>
                        <option value="07:00 - 07:55">07:00 - 07:55</option>
                        <option value="07:55 - 08:50">07:55 - 08:50</option>
                        <option value="08:50 - 09:45">08:50 - 09:45</option>
                        <option value="09:45 - 10:10">09:45 - 10:10 (Pause)</option>
                        <option value="10:10 - 11:05">10:10 - 11:05</option>
                        <option value="11:05 - 12:00">11:05 - 12:00</option>
                        <option value="14:30 - 15:30">14:30 - 15:30</option>
                        <option value="15:30 - 16:30">15:30 - 16:30</option>
                        <option value="16:30 - 17:30">16:30 - 17:30</option>
                    </select>
                </div>
                <button type="button" class="remove-btn" onclick="removeTimeSlotGroup(this)">Supprimer ce créneau</button>
            `;
            
            timeSlotGroups.appendChild(newGroup);
            
            // Afficher le bouton de suppression pour tous les groupes sauf le premier
            const removeButtons = document.querySelectorAll('.remove-btn');
            if (removeButtons.length > 1) {
                removeButtons.forEach(btn => btn.style.display = 'inline-block');
            }
        }
        
        function removeTimeSlotGroup(button) {
            const groups = document.querySelectorAll('.time-slot-group');
            if (groups.length > 1) {
                button.parentElement.remove();
                
                // Mettre à jour les titres des groupes restants
                document.querySelectorAll('.time-slot-group h4').forEach((h4, index) => {
                    h4.textContent = `Créneau horaire ${index + 1}`;
                });
                
                // Cacher le bouton de suppression s'il ne reste qu'un groupe
                if (groups.length === 2) { // Avant suppression
                    document.querySelector('.remove-btn').style.display = 'none';
                }
            }
        }
        
        function switchTab(tabName) {
            // Désactiver tous les onglets
            document.querySelectorAll('.tab').forEach(tab => {
                tab.classList.remove('active');
            });
            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.remove('active');
            });
            
            // Activer l'onglet sélectionné
            document.querySelector(`.tab[onclick="switchTab('${tabName}')"]`).classList.add('active');
            document.getElementById(`${tabName}-tab`).classList.add('active');
            
            // Si on passe à l'onglet de visualisation, générer l'emploi du temps
            if (tabName === 'timetable') {
                updateFilters();
                generateTimetable();
            } else if (tabName === 'all-data') {
                updateFilters();
                displayAllData();
            }
        }
        
        function saveCourse(course) {
            const courses = getCourses();
            courses.push(course);
            localStorage.setItem('courses', JSON.stringify(courses));
        }
        
        function getCourses() {
            return JSON.parse(localStorage.getItem('courses')) || [];
        }
        
        function loadCourses() {
            const courses = getCourses();
            if (courses.length > 0) {
                updateFilters();
                generateTimetable();
                displayAllData();
            }
        }
        
        function updateFilters() {
            const courses = getCourses();
            
            // Mettre à jour la liste des enseignants
            updateSelectOptions('selectTeacher', [...new Set(courses.map(c => c.teacherName))]);
            updateSelectOptions('filterTeacher', [...new Set(courses.map(c => c.teacherName))]);
            
            // Mettre à jour la liste des classes
            updateSelectOptions('selectClass', [...new Set(courses.map(c => c.className))]);
        }
        
        function updateSelectOptions(selectId, options) {
            const select = document.getElementById(selectId);
            const currentValue = select.value;
            
            select.innerHTML = '';
            select.appendChild(new Option('-- ' + (selectId.includes('Teacher') ? 'Tous' : 'Toutes') + ' --', ''));
            
            options.forEach(option => {
                select.appendChild(new Option(option, option));
            });
            
            if (options.includes(currentValue)) {
                select.value = currentValue;
            }
        }
        
        // Fonction pour calculer les volumes horaires
        function calculateTimeVolumes(courses) {
            const volumes = {
                bySubject: {},
                byClass: {},
                byTeacher: {},
                total: 0
            };

            courses.forEach(course => {
                // Calculer la durée en heures (supposons que chaque créneau = 1 heure)
                const duration = 1; 

                // Par matière
                if (!volumes.bySubject[course.subject]) {
                    volumes.bySubject[course.subject] = 0;
                }
                volumes.bySubject[course.subject] += duration;

                // Par classe
                if (!volumes.byClass[course.className]) {
                    volumes.byClass[course.className] = 0;
                }
                volumes.byClass[course.className] += duration;

                // Par enseignant
                if (!volumes.byTeacher[course.teacherName]) {
                    volumes.byTeacher[course.teacherName] = 0;
                }
                volumes.byTeacher[course.teacherName] += duration;

                // Total général
                volumes.total += duration;
            });

            return volumes;
        }

        // Fonction pour afficher les volumes horaires
        function displayTimeVolumes(volumes) {
            const container = document.getElementById('timeVolumesContainer');
            if (!container) return;

            container.innerHTML = '';

            // Créer les tableaux de volumes
            const createVolumeTable = (title, data) => {
                const table = document.createElement('table');
                table.className = 'volume-table';
                table.innerHTML = `
                    <caption>${title}</caption>
                    <thead>
                        <tr>
                            <th>Nom</th>
                            <th>Volume horaire (heures)</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${Object.entries(data).map(([name, hours]) => `
                            <tr>
                                <td>${name}</td>
                                <td>${hours}</td>
                            </tr>
                        `).join('')}
                        ${title.includes('Total') ? '' : `
                            <tr class="total-row">
                                <td><strong>Total</strong></td>
                                <td><strong>${Object.values(data).reduce((a, b) => a + b, 0)}</strong></td>
                            </tr>
                        `}
                    </tbody>
                `;
                return table;
            };

            // Créer un conteneur grid pour les tableaux
            const gridContainer = document.createElement('div');
            gridContainer.className = 'volumes-grid';

            // Ajouter les tableaux au conteneur grid
            if (Object.keys(volumes.bySubject).length > 0) {
                gridContainer.appendChild(createVolumeTable('Volume horaire par matière', volumes.bySubject));
            }
            if (Object.keys(volumes.byClass).length > 0) {
                gridContainer.appendChild(createVolumeTable('Volume horaire par classe', volumes.byClass));
            }
            if (Object.keys(volumes.byTeacher).length > 0) {
                gridContainer.appendChild(createVolumeTable('Volume horaire par enseignant', volumes.byTeacher));
            }

            container.appendChild(gridContainer);

            // Ajouter le total général
            const totalDiv = document.createElement('div');
            totalDiv.className = 'total-volume';
            totalDiv.innerHTML = `<h4>Volume horaire total: ${volumes.total} heures</h4>`;
            container.appendChild(totalDiv);
        }
        
        function generateTimetable() {
            const courses = getCourses();
            const selectedTeacher = document.getElementById('selectTeacher').value;
            const selectedCycle = document.getElementById('selectCycle').value;
            const selectedClass = document.getElementById('selectClass').value;
            
            const timetableBody = document.getElementById('timetableBody');
            timetableBody.innerHTML = '';
            
            // Filtrer les cours selon les sélections
            let filteredCourses = courses;
            
            if (selectedTeacher) {
                filteredCourses = filteredCourses.filter(c => c.teacherName === selectedTeacher);
            }
            
            if (selectedCycle) {
                filteredCourses = filteredCourses.filter(c => c.cycle === selectedCycle);
            }
            
            if (selectedClass) {
                filteredCourses = filteredCourses.filter(c => c.className === selectedClass);
            }
            
            // Créer le conteneur pour les volumes horaires s'il n'existe pas
            if (!document.getElementById('timeVolumesContainer')) {
                const container = document.createElement('div');
                container.id = 'timeVolumesContainer';
                document.getElementById('timetableContainer').appendChild(container);
            }
            
            if (filteredCourses.length === 0) {
                document.getElementById('displayTeacherName').textContent = "Aucun cours trouvé avec les filtres sélectionnés";
                document.getElementById('timeVolumesContainer').innerHTML = '';
                return;
            }
            
            // Afficher le titre selon les filtres
            let title = "";
            if (selectedTeacher) title += `Enseignant: ${selectedTeacher}`;
            if (selectedCycle) title += `${title ? ' | ' : ''}Cycle: ${selectedCycle}`;
            if (selectedClass) title += `${title ? ' | ' : ''}Classe: ${selectedClass}`;
            
            document.getElementById('displayTeacherName').textContent = title || "Emploi du temps combiné";
            
            // Calculer et afficher les volumes horaires
            const volumes = calculateTimeVolumes(filteredCourses);
            displayTimeVolumes(volumes);
            
            // Créer la structure de l'emploi du temps
            timeSlots.forEach(slot => {
                const row = document.createElement('tr');
                
                // Colonne horaire
                const timeCell = document.createElement('td');
                timeCell.className = 'time-col';
                timeCell.textContent = slot;
                row.appendChild(timeCell);
                
                // Colonnes pour chaque jour
                const days = ['Lundi', 'Mardi', 'Mercredi', 'Jeudi', 'Vendredi'];
                days.forEach(day => {
                    const dayCell = document.createElement('td');
                    
                    // Vérifier si c'est une pause
                    if (slot === '09:45 - 10:10') {
                        dayCell.className = 'break';
                        row.appendChild(dayCell);
                        return;
                    }
                    
                    // Trouver les cours correspondants à ce créneau et ce jour
                    const matchingCourses = filteredCourses.filter(c => c.day === day && c.timeSlot === slot);
                    
                    if (matchingCourses.length > 0) {
                        let content = '';
                        matchingCourses.forEach(course => {
                            const courseInfo = `${course.className}${course.subject ? ` (${course.subject})` : ''}`;
                            content += `<div class="${course.cycle === 'Collège' ? 'cycle-college' : 'cycle-lycee'}">${courseInfo}</div>`;
                        });
                        dayCell.innerHTML = content;
                    }
                    
                    row.appendChild(dayCell);
                });
                
                timetableBody.appendChild(row);
            });
        }
        
        function displayAllData() {
            const courses = getCourses();
            const filterTeacher = document.getElementById('filterTeacher').value;
            const filterCycle = document.getElementById('filterCycle').value;
            
            const allDataBody = document.getElementById('allDataBody');
            allDataBody.innerHTML = '';
            
            // Filtrer les cours
            let filteredCourses = courses;
            
            if (filterTeacher) {
                filteredCourses = filteredCourses.filter(c => c.teacherName === filterTeacher);
            }
            
            if (filterCycle) {
                filteredCourses = filteredCourses.filter(c => c.cycle === filterCycle);
            }
            
            if (filteredCourses.length === 0) {
                allDataBody.innerHTML = '<tr><td colspan="7">Aucun cours trouvé avec les filtres sélectionnés</td></tr>';
                return;
            }
            
            filteredCourses.forEach(course => {
                const row = document.createElement('tr');
                
                // Appliquer une classe CSS selon le cycle
                if (course.cycle === 'Collège') {
                    row.classList.add('cycle-college');
                } else if (course.cycle === 'Lycée') {
                    row.classList.add('cycle-lycee');
                }
                
                row.innerHTML = `
                    <td>${course.teacherName}</td>
                    <td>${course.className}</td>
                    <td>${course.cycle}</td>
                    <td>${course.subject || '-'}</td>
                    <td>${course.day}</td>
                    <td>${course.timeSlot}</td>
                    <td>
                        <button onclick="deleteCourse(${course.id})">Supprimer</button>
                    </td>
                `;
                
                allDataBody.appendChild(row);
            });
        }
        
        function deleteCourse(id) {
            if (confirm("Voulez-vous vraiment supprimer ce cours?")) {
                let courses = getCourses();
                courses = courses.filter(course => course.id !== id);
                localStorage.setItem('courses', JSON.stringify(courses));
                
                // Mettre à jour les affichages
                updateFilters();
                generateTimetable();
                displayAllData();
                
                alert("Cours supprimé avec succès!");
            }
        }
        
        function clearForm() {
            document.getElementById('courseForm').reset();
            
            // Réinitialiser les sélections multiples
            document.querySelectorAll('.multi-select-option.selected').forEach(option => {
                option.classList.remove('selected');
            });
            
            // Mettre à jour les affichages des sélections
            updateSelectedItemsDisplay('selectedClasses');
            updateSelectedItemsDisplay('selectedSubjects');
            updateSelectedItemsDisplay('selectedDays');
            
            // Réinitialiser les créneaux horaires (garder seulement le premier)
            const timeSlotGroups = document.getElementById('timeSlotGroups');
            while (timeSlotGroups.children.length > 1) {
                timeSlotGroups.removeChild(timeSlotGroups.lastChild);
            }
            
            // Réinitialiser le premier créneau
            timeSlotGroups.querySelector('.time-slot').value = '';
            
            // Cacher le bouton de suppression
            document.querySelector('.remove-btn').style.display = 'none';
        }
        
        function clearAllData() {
            if (confirm("Voulez-vous vraiment supprimer TOUTES les données?")) {
                localStorage.removeItem('courses');
                updateFilters();
                generateTimetable();
                displayAllData();
                alert("Toutes les données ont été supprimées.");
            }
        }
        
        // Fonction pour exporter les données au format JSON
        function exportData() {
            const courses = getCourses();
            if (courses.length === 0) {
                alert("Aucune donnée à exporter");
                return;
            }
            
            const dataStr = JSON.stringify(courses, null, 2);
            const dataUri = 'data:application/json;charset=utf-8,'+ encodeURIComponent(dataStr);
            
            const exportFileDefaultName = `emploi_du_temps_${new Date().toISOString().slice(0,10)}.json`;
            
            const linkElement = document.createElement('a');
            linkElement.setAttribute('href', dataUri);
            linkElement.setAttribute('download', exportFileDefaultName);
            linkElement.click();
        }
        
        // Fonction pour importer des données depuis un fichier JSON
        function importData(input) {
            const file = input.files[0];
            if (!file) return;
            
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const importedCourses = JSON.parse(e.target.result);
                    if (!Array.isArray(importedCourses)) {
                        throw new Error("Le fichier ne contient pas un tableau de données valide");
                    }
                    
                    if (confirm(`Voulez-vous importer ${importedCourses.length} cours? Les données existantes seront conservées.`)) {
                        const currentCourses = getCourses();
                        const mergedCourses = [...currentCourses, ...importedCourses];
                        localStorage.setItem('courses', JSON.stringify(mergedCourses));
                        
                        // Mettre à jour les affichages
                        updateFilters();
                        generateTimetable();
                        displayAllData();
                        
                        alert("Données importées avec succès!");
                    }
                } catch (error) {
                    alert("Erreur lors de l'importation: " + error.message);
                }
                
                // Réinitialiser l'input file pour permettre la sélection du même fichier à nouveau
                input.value = '';
            };
            reader.readAsText(file);
        }
    </script>
</body>
</html>
